---
title: 牛客论坛项目
shortTitle: 牛客论坛
icon: project
date: 2022-08-26
category:
  - 面试准备
  - 笔记
tag:
  - 项目
---
# 牛客论坛项目

## 数据库表

#### 用户表 user

| 字段            | 类型      | 备注                               |
| --------------- | --------- | ---------------------------------- |
| id              | int       | 主键、自增                         |
| username        | varchar   | 用户名，创建索引                   |
| password        | varchar   | 用户密码                           |
| salt            | varchar   | 加密盐值                           |
| email           | varchar   | 用户邮箱，创建索引                 |
| type            | int       | 用户类型：0 普通、1 管理员、2 版主 |
| status          | int       | 用户状态：0 未激活、1 已激活       |
| activation_code | varchar   | 激活码                             |
| header_url      | varchar   | 用户头像地址                       |
| create_time     | timestamp | 注册时间                           |

#### 评论表 comment

| 字段        | 类型      | 备注                                 |
| ----------- | --------- | ------------------------------------ |
| id          | int       | 主键、自增                           |
| user_id     | int       | 评论的用户 id，创建索引              |
| entity_id   | int       | 评论实体 id，创建索引                |
| entity_type | int       | 评论实体类型：1 帖子评论、2 评论回复 |
| target_id   | int       | 评论目标 id                          |
| content     | text      | 评论内容                             |
| status      | int       | 评论状态：0 有效、1 无效             |
| create_time | timestamp | 评论发表时间                         |

#### 帖子表 discuss_post

| 字段          | 类型      | 备注                             |
| ------------- | --------- | -------------------------------- |
| id            | int       | 主键、自增                       |
| user_id       | int       | 发帖的用户 id，创建索引          |
| title         | varchar   | 帖子表标题                       |
| content       | text      | 帖子内容                         |
| type          | int       | 帖子类型：0 普通、1 置顶         |
| comment_count | int       | 评论数量                         |
| status        | int       | 帖子状态：0 普通、1 精华、2 拉黑 |
| create_time   | timestamp | 评论发表时间                     |

#### 用户登录凭证表 login_ticket

| 字段    | 类型      | 备注                     |
| ------- | --------- | ------------------------ |
| id      | int       | 主键、自增               |
| user_id | int       | 登录用户 id              |
| ticket  | varchar   | 登录凭证，随机字符串     |
| status  | int       | 登录状态：0 有效、1 无效 |
| expired | timestamp | 过期时间                 |

#### 消息表 message

| 字段            | 类型      | 备注                                  |
| --------------- | --------- | ------------------------------------- |
| id              | int       | 主键、自增                            |
| from_id         | int       | 发消息的 id，创建索引                 |
| to_id           | int       | 收消息的 id，创建索引                 |
| conversation_id | varchar   | 会话 id，由通信双方 id 拼接，创建索引 |
| content         | text      | 消息内容                              |
| status          | int       | 消息状态：0 未读、1 已读、2 删除      |
| create_time     | timestamp | 消息发送时间                          |

## 第一章 初识Spring Boot，开发社区首页

### 1.1 课程介绍

熟悉快速开发框架：**SpringBoot2.x.x** 整合 **SpringMVC + Mybatis**

熟悉版本控制：**Maven3.6.3 + Git**

数据库以及文件存储：**MySQL** + **文件存储阿里云OSS**

熟悉页面模板引擎：**Thymleaf3.x**

第三方工具：**网页长图生成工具Wkhtmltopdf** + **验证码生成工具kaptcha**

中间件：**分布式缓存Redis** + **全文检索ElasticSearch** + **Kafka** + **本地缓存Caffeine**

权限框架：**Spring Securtiy + Spring Actuator**

熟悉前端：**Ajax + Vue + BootStrap + HTML + jQuery**

### 1.2 搭建开发环境

#### 构建工具：Apache Maven

* 可以帮助我们构建项目、管理项目中的jar包
* Maven仓库：存放构件的位置
  * 构件:创建项目时依赖的资源jar包.
  * 本地仓库：默认是 ~/.m2/repository
  * 远程仓库：中央仓库(官网)、镜像仓库(第三方网站)、私服仓库(公司自己搭建)
* 示例：安装、配置
  * [安装和配置链接](http://blog.csdn.net/qq_38190185/article/details/115921070)

#### 集成开发工具：IntelliJ IDEA 

* 目前最流行的Java集成开发工具
* 示例：安装、配置
  * [安装和配置链接](http://mp.weixin.qq.com/s?__biz=MzA4MjU4MTg2Ng==&mid=2247488381&idx=1&sn=4fd49004e2c1b854334a7ddbe14e0578&chksm=9f82d378a8f55a6e84e5eba0b77c02ad13a898b922d7d63b64634fd5090a154efb84c867f983&scene=21&token=1698480337&lang=zh_CN#wechat_redirect)

#### 数据库：MySQL、Redis 

- [MySQL安装配置](http://blog.csdn.net/m0_49284219/article/details/121972531)
- Redis安装配置

#### Spring Initializr

* 把包进行整合按功能划分归类
* 创建 Spring Boot 项目的引导工具
  * http://start.spring.io

#### Spring Boot 入门示例

*  Spring Boot 核心作用

* 初始化能提供很多配置的依赖、自动配置、端点监控

* 示例:一个简单的处理客户端请求案例


1、使用 Spring Initializr 创建一个初始项目，添加aspects(搜索aop) ,web,thymeleaf,devtools 依赖。

初始的pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.2.6.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.dyl</groupId>
    <artifactId>community</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>community</name>
    <description>Demo project for Spring Boot</description>
    <properties>
        <java.version>1.8</java.version>
    </properties>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-aop</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

	<build>
		<plugins>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
			</plugin>
		</plugins>
	</build>

</project>
```

2、在application.yaml文件中进行配置

``````yaml
# ServerProperties
server:
  # 服务器端口
  port: 8080
  servlet:
    # 项目访问路径
    context-path: /community
``````

3、输出简单的 hello world

在 controller 包内新建 AlphaController.java 类，代码如下：

```java
@Controller
@RequestMapping(value = "/alpha")
public class AlphaController {

    @RequestMapping(value = "/hello")
    @ResponseBody
    public String sayHello() {
        return "Hello world";
    }
}
```

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/alpha/hello 输出结果：

![image-20220711134928143](http://qiniu.dyl.fit/Interview/image-20220711134928143.png)

### 1.3 Spring入门

#### Spring全家桶

* Spring Framework 
* Spring Boot
* Spring Cloud (微服务,大项目拆分成若干子项目)
* Spring Cloud Data Flow(数据集成)
* [官网](http://spring.io)

#### Spring Framework

* Spring Core

* IoC、AOP  (管理对象的思想,spring管理的对象叫做Bean)

* Spring Data Access
  * Transactions(事务)、Spring MyBatis
* Web Servlet
  * Spring MVC
* Integration(集成)
  * Email、Scheduling(定时任务)、AMQP(消息队列)、Security(安全控制)

#### Spring IoC

* Inversion of Control
  * 控制反转，是一种面向对象编程的设计思想。
* Dependency Injection
  * 依赖注入，是IoC思想的实现方式。
* IoC Container
  * IoC容器，是实现依赖注入的关键，本质上是一个工厂。
  * 容器管理Bean的前提:提供Bean的类型,通过配置文件配置Bean之间的关系.
  * 降低Bean之间的耦合度

#### 案例代码部分

启动类：CommunityApplication.java

```java
@SpringBootApplication
public class CommunityApplication {
	public static void main(String[] args) {
		SpringApplication.run(CommunityApplication.class, args);
	}
}
配置类,启动时自动扫描,扫描配置类所在的包以及子包下的Bean
@Component @Repository @Service @Controller
@Service 开发业务组件时使用
@Controller 处理请求时使用
@Repository 开发数据库访问组件时使用
@Component 通用的 
```

测试代码要以其为配置类,需加上注解:

``````java
@ContextConfiguration(classes = CommunityApplication.class)
``````

##### 使用 spring 容器

使用 spring 容器需要实现 ApplicationContextAware 接口 ,然后实现接口中 setApplicationContext 方法。传入参数applicationContext( spring 容器),它是一个接口,继承自 BeanFactory

``````java
class CommunityApplicationTests implements ApplicationContextAware {

    private ApplicationContext applicationContext;

    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
        this.applicationContext = applicationContext;
    }
    @Test
    void testApplicationContext() {
        System.out.println(applicationContext);
    }
}
``````

输出结果：

![image-20220711103844157](http://qiniu.dyl.fit/Interview/image-20220711103844588.png)

##### 获取Bean

在 dao 包里面新建接口 AlphaDao.java，代码如下：

```java
public interface AlphaDao {
    String select();
}
```

在 dao 包里面新建接口的实现类 AlphaDaoHibernateImpl.java 代码如下：

```java
@Repository
public class AlphaDaoHibernateImpl implements AlphaDao {

    @Override
    public String select() {
        return "hibernate";
    }
}
```

在 CommunityApplicationTests 类中增加如下代码：

```java
@Test
void testApplicationContext() {
    System.out.println(applicationContext);

    AlphaDao alphaDao = applicationContext.getBean(AlphaDao.class);
    System.out.println(alphaDao.select());
}
```

输出结果：

![image-20220711104240374](http://qiniu.dyl.fit/Interview/image-20220711104240374.png)

##### 体现 bean 管理

再在 dao 包里面新建接口的实现类 AlphaDaoMybatisImpl.java 代码如下：

```java
@Repository
@Primary
public class AlphaDaoMybatisImpl implements AlphaDao {

    @Override
    public String select() {
        return "mybatis";
    }
}
```

> 不加 @primary 注解会报错，因为此时有两个 bean ，spring 容器不知道该获取哪一个，该注解表示优先获取注解修饰的 bean 

重新运行 testApplicationContext() 方法，输出结果：

![image-20220711104826847](http://qiniu.dyl.fit/Interview/image-20220711104826847.png)

此时想要获取之前的 bean 时，可以用该 bean 的名字来获取，每个 bean 的名字默认是小写的类名，也可以给 bean 自定义名字: @Component("名字")

在 AlphaDaoHibernateImpl 类中修改 @Repository 为 @Repository("AlphaDaoHibernate")，再在 testApplicationContext() 方法中添加代码，如下所示：

```java
@Test
void testApplicationContext() {
    System.out.println(applicationContext);

    AlphaDao alphaDao = applicationContext.getBean(AlphaDao.class);
    System.out.println(alphaDao.select());

    alphaDao = applicationContext.getBean("AlphaDaoHibernate", AlphaDao.class);
    System.out.println(alphaDao.select());
}
```

重新运行 testApplicationContext() 方法，输出结果：

![image-20220711105332879](http://qiniu.dyl.fit/Interview/image-20220711105332879.png)

##### spring 容器管理初始化、销毁方法

在 service 包内创建 AlphaService.java类,代码如下：

```java
@Service
public class AlphaService {

    public AlphaService() {
        System.out.println("实例化 AlphaService");
    }

    @PostConstruct
    // 在构造器之后调用
    public void init() {
        System.out.println("初始化 AlphaService");
    }

    @PreDestroy
    // 在销毁对象之前调用
    public void destroy() {
        System.out.println("销毁 AlphaService");
    }
}
```

在 CommunityApplicationTests 测试类中编写 testBeanManagement() 方法

```java
@Test
void testBeanManagement() {
    //默认spring bean管理的时候都是单例，只实例化一次
    AlphaService alphaService = applicationContext.getBean(AlphaService.class);
    System.out.println(alphaService);
}
```

输出结果：

![image-20220711130629986](http://qiniu.dyl.fit/Interview/image-20220711130629986.png)

> spring bean管理的时候默认都是单例，只实例化一次

在 AlphaService.java 中通过 @Scope() 来指定单例或者多例，默认是 @Scope("singleton")->单例；@Scope("prototype")->多例，一般不使用多例，代码如下：

```java
@Service
@Scope("prototype")
public class AlphaService {
    public AlphaService() {
        System.out.println("实例化 AlphaService");
    }

    @PostConstruct
    public void init() {
        System.out.println("初始化 AlphaService");
    }

    @PreDestroy
    public void destroy() {
        System.out.println("销毁 AlphaService");
    }
}
```

将 testBeanManagement() 方法新增一个实例化对象的步骤，代码如下：

```java
@Test
void testBeanManagement() {
    AlphaService alphaService = applicationContext.getBean(AlphaService.class);
    System.out.println(alphaService);

    alphaService = applicationContext.getBean(AlphaService.class);
    System.out.println(alphaService);
}
```

输出结果：

![image-20220711132523344](http://qiniu.dyl.fit/Interview/image-20220711132523344.png)

##### 使用自定义的配置类

在 config 包内新建 AlphaConfig.java 类，并使用 @Configuration 来配置类,用以装载使用第三方类，代码如下：

```java
@Configuration
public class AlphaConfig {
    @Bean
    public SimpleDateFormat simpleDateFormat() {
        return new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    }
}
```

> 方法名就是 bean 的名字

编写测试方法

```java
@Test
void testBeanConfig() {
    SimpleDateFormat simpleDateFormat = applicationContext.getBean(SimpleDateFormat.class);
    System.out.println(simpleDateFormat.format(new Date()));
}
```

输出结果：
![image-20220711133205153](http://qiniu.dyl.fit/Interview/image-20220711133205153.png)

##### 依赖注入的便捷使用

在测试类中编写以下代码：

```java
@Autowired
@Qualifier("AlphaDaoHibernate")
private AlphaDao alphaDao;

@Autowired
private AlphaService alphaService;

@Autowired
private SimpleDateFormat simpleDateFormat;

@Test
void testDI() {
    System.out.println(alphaDao);
    System.out.println(alphaService);
    System.out.println(simpleDateFormat);
}
```

>@Qualifier("AlphaDaoHibernate") 表示使用该名称的 bean ，不加这个默认输出的是 AlphaDaoMybatisImpl 里的对象

输出结果：

![image-20220711133409450](http://qiniu.dyl.fit/Interview/image-20220711133409450.png)

##### 依赖注入的完整示例

> controller 层调用 service 层，service 层调用 dao 层

先在 AlphaService.java 中注入 AlphaDao

```java
@Resource
private AlphaDao alphaDao;
```

新增一个模拟查询业务的方法 find()

```java
public String find() {
    return alphaDao.select();
}
```

AlphaService.java 完整代码如下：

```java
@Service
//@Scope("prototype")
//从单例变成每次都是新的实例
public class AlphaService {

    @Resource
    private AlphaDao alphaDao;

    public AlphaService() {
        System.out.println("实例化 AlphaService");
    }

    @PostConstruct
    public void init() {
        System.out.println("初始化 AlphaService");
    }

    @PreDestroy
    public void destroy() {
        System.out.println("销毁 AlphaService");
    }

    public String find() {
        return alphaDao.select();
    }

}
```

在 AlphaController.java 中先注入AlphaService

```java
@Resource
private AlphaService alphaService;
```

再编写调用方法

```java
@RequestMapping(value = "/data")
@ResponseBody
public String getDate() {
    return alphaService.find();
}
```

AlphaController.java 完整代码如下：

```java
@Controller
@RequestMapping(value = "/alpha")
public class AlphaController {

    @Resource
    private AlphaService alphaService;

    @RequestMapping(value = "/hello")
    @ResponseBody
    public String sayHello() {
        return "Hello world";
    }

    @RequestMapping(value = "/data")
    @ResponseBody
    public String getDate() {
        return alphaService.find();
    }
}
```

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/alpha/data 输出结果：

![image-20220711135832754](http://qiniu.dyl.fit/Interview/image-20220711135832754.png)

### 1.4 Spring MVC入门

#### HTTP

* HyperText Transfer Protocol
* 用于传输HTML等内容的应用层协议
* 规定了浏览器和服务器之间如何通信，以及通信时的数据格式。
* 学习网站：http://developer.mozilla.org/zh-CN

浏览器服务器通信步骤：

1. 打开一个TCP连接
2. 发生一个HTTP报文 
3. 读取服务器返回的报文信息
4. 关闭连接或为后续请求重用连接

- 按下F12进入调试，在 Network 下看请求响应（ Header 和 Response ）

#### Spring MVC

* 三层架构
  * 表现层( mvc )、业务层、数据访问层

* MVC(设计模式)
  * Model：模型层
  * View：视图层
  * Controller：控制层

* 核心组件
  * 前端控制器：DispatcherServlet

浏览器访问服务器，首先访问的时 Controller 控制层， Controller 调用业务层处理，处理完后将得到的数据封装到 Model ,传给视图层。

 <qiniu src="http://qiniu.dyl.fit/Interview/image-20191111134655288.png" alt="avatar" style="zoom:60%;" />

#### Thymeleaf

* 模板引擎
  * 生成动态的HTML。
* Thymeleaf
  * 倡导自然模板，即以HTML文件为模板。
* 常用语法
  * 标准表达式、判断与循环、模板的布局。

#### 案例代码部分

##### 获取请求和响应数据

在 application.yaml 中关闭 Thymeleaf 模板引擎的缓存

> 部署到线上时候打开缓存可以减轻服务器的压力

```yaml
# ThymeleafProperties
spring:
  thymeleaf:
    cache: false
```

在 AlphaController.java 中新增如下代码：

```java
    @RequestMapping("/http")
    public void http(httpervletRequest request, httpervletResponse response) {
        // 获取请求数据
        System.out.println(request.getMethod());
        System.out.println(request.getServletPath());
        Enumeration<String> enumeration = request.getHeaderNames();
        while (enumeration.hasMoreElements()) {
            String name = enumeration.nextElement();
            String value = request.getHeader(name);
            System.out.println(name + ": " + value);
        }
        System.out.println(request.getParameter("code"));

        // 返回响应数据
        response.setContentType("text/html;charset=utf-8");
        try (PrintWriter writer = response.getWriter();) {
            writer.write("<h1>xx网</h1>");
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
```

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/alpha/http?code=123&name=zhansan 输出结果：

![image-20220711143046645](http://qiniu.dyl.fit/Interview/image-20220711143046645.png)

![image-20220711142832503](http://qiniu.dyl.fit/Interview/image-20220711142832503.png)

##### 从路径中得到变量（两种方法）

###### Get 请求

在 AlphaController.java 中新增如下代码：

```java
    // Get 请求
    // /student?current=1&limit=20

    @GetMapping("/students")
    @ResponseBody
    public String getStudents(
            @RequestParam(name = "current", required = false, defaultValue = "1") int current,
            @RequestParam(name = "limit", required = false, defaultValue = "10") int limit) {
        System.out.println(current);
        System.out.println(limit);
        return "some students";
    }

    @GetMapping("/student/{id}")
    @ResponseBody
    public String getStudent(@PathVariable("id") int id) {
        System.out.println(id);
        return "a student";
    }
```

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/alpha/students?current=1&limit=20，输出结果：

![image-20220711143510839](http://qiniu.dyl.fit/Interview/image-20220711143510839.png)

![image-20220711143712681](http://qiniu.dyl.fit/Interview/image-20220711143712681.png)

输入http://localhost:8080/community/alpha/students/123，输出结果：

![image-20220711143817390](http://qiniu.dyl.fit/Interview/image-20220711143817390.png)

![image-20220711143825323](http://qiniu.dyl.fit/Interview/image-20220711143825323.png)

###### POST请求

在 resource 文件夹下新建 html 文件夹，并创建 student.html,代码如下

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>增加学生</title>
</head>
<body>

<form method="post" action="/community/alpha/student">
    <p>
        姓名：<input type="text" name="name">
    </p>
    <p>
        年龄：<input type="text" name="age">
    </p>
    <p>
        <input type="submit" name="保存">
    </p>
</form>

</body>
</html>
```

在 AlphaController.java 中新增如下代码：

``````java
@RequestMapping(path = "/student", method = RequestMethod.POST)
@ResponseBody
public String saveStudent(String name, int age) {
    System.out.println(name);
    System.out.println(age);
    return "success";
}
``````

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/alpha/student，填写表格后输出结果：

![image-20220711145005317](http://qiniu.dyl.fit/Interview/image-20220711145005317.png)

![image-20220711145018641](http://qiniu.dyl.fit/Interview/image-20220711145018641.png)

响应 HTML 数据(使用 ModelAndView 或 Model ):

**使用 ModelAndView:**

在template文件夹下新建demo文件夹，并创建view.html，代码如下：

```html
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Teacher</title>
</head>
<body>
<p th:text="${name}"></p>
<p th:text="${age}"></p>

</body>
</html>
```

在 AlphaController.java 中新增如下代码：

``````java
@RequestMapping(path = "/teacher", method = RequestMethod.GET)
public ModelAndView getTeacher() {
    ModelAndView mav = new ModelAndView();
    mav.addObject("name", "张三");
    mav.addObject("age", 30);
    mav.setViewName("/demo/view");
    return mav;
}

@RequestMapping(path = "/school", method = RequestMethod.GET)
public String getSchool(Model model) {
    model.addAttribute("name", "北京大学");
    model.addAttribute("age", 80);
    return "/demo/view";
}
``````

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/alpha/teacher，输出结果：

![image-20220711150010030](http://qiniu.dyl.fit/Interview/image-20220711150010030.png)

**使用 Model(推荐)：**

在 AlphaController.java 中新增如下代码：

```java
@GetMapping("/school")
public String getSchool(Model model) {
    model.addAttribute("name", "北京大学");
    model.addAttribute("age", 80);
    return "/demo/view";
}
```

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/alpha/school，输出结果：

![image-20220711150319197](http://qiniu.dyl.fit/Interview/image-20220711150319197.png)

##### 响应JSON数据(异步请求)

Java对象 -> JSON字符串 -> JS对象,使用 @ResponseBody 注解

在 AlphaController.java 中新增如下代码：

``````java
    // 响应JSON数据（异步请求）
    // Java对象 -> JSON字符串 -> JS对象

    @GetMapping("/emp")
    @ResponseBody
    public Map<String, Object> getEmp() {
        Map<String, Object> emp = new HashMap<>();
        emp.put("name", "张三");
        emp.put("age", 23);
        return emp;
    }
    //转换为json字符串  {"name":"张三","age":"23"}
    //也可以返回List<Map<String, Object>>，list集合。

    @GetMapping("/emps")
    @ResponseBody
    public List<Map<String, Object>> getEmps() {
        List<Map<String, Object>> list = new ArrayList<>();
        Map<String, Object> emp1 = new HashMap<>();
        emp1.put("name", "张三");
        emp1.put("age", 23);
        list.add(emp1);

        Map<String, Object> emp2 = new HashMap<>();
        emp2.put("name", "李四");
        emp2.put("age", 25);
        list.add(emp2);

        return list;
    }
``````

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/alpha/emp，输出结果：![image-20220711150734958](http://qiniu.dyl.fit/Interview/image-20220711150734958.png)

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/alpha/emps，输出结果：

![image-20220711151053138](http://qiniu.dyl.fit/Interview/image-20220711151053138.png)

### 1.5 MyBatis入门

* 核心组件
  * SqlSessionFactory：用于创建 SqlSession 的工厂类。
  * SqlSession：MyBatis 的核心组件，用于向数据库执行 SQL 。
  * 主配置文件：XML 配置文件，可以对 MyBatis 的底层行为做出详细的配置。
  * Mapper 接口：就是 DAO 接口，在MyBatis中习惯性的称之为 Mapper 。
  * Mapper 映射器：用于编写 SQL ，并将 SQL 和实体类映射的组件，采用 XML、注解均可实现。
* 示例：使用 MyBatis 对用户表进行 CRUD 操作

#### 1、引入 MySQL 和 Mybatis 依赖

在 pom.xml 引入 MySQL 和 Mybatis 依赖

```xml
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>5.1.38</version>
        </dependency>

        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter</artifactId>
            <version>2.0.1</version>
        </dependency>
```

#### 2、配置数据库、Mybatis

在 application.yaml 中配置数据库、Mybatis

```yaml
# DataSourceProperties
spring: 
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/community?characterEncoding=utf-8&useSSL=false
    username: root
    password: root
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      maximum-pool-size: 15
      minimum-idle: 5
      idle-timeout: 30000
# MybatisProperties
mybatis:
  mapper-locations: mapper/*xml
  type-aliases-package: com.dyl.community.model.domain
  configuration:
    # 启动自动生成组件
    use-generated-keys: true
    map-underscore-to-camel-case: true
```

#### 3、创建实体类对象

在 model 包内的 domain 内创建 User 类，代码如下：

```java
public class User {
    private int id;
    private String username;
    private String password;
    private String salt;
    private String email;
    private int type;
    private int status;
    private String activationCode;
    private String headerUrl;
    private Date createTime;

    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public String getSalt() {
        return salt;
    }

    public void setSalt(String salt) {
        this.salt = salt;
    }

    public String getEmail() {
        return email;
    }

    public void setEmail(String email) {
        this.email = email;
    }

    public int getType() {
        return type;
    }

    public void setType(int type) {
        this.type = type;
    }

    public int getStatus() {
        return status;
    }

    public void setStatus(int status) {
        this.status = status;
    }

    public String getActivationCode() {
        return activationCode;
    }

    public void setActivationCode(String activationCode) {
        this.activationCode = activationCode;
    }

    public String getHeaderUrl() {
        return headerUrl;
    }

    public void setHeaderUrl(String headerUrl) {
        this.headerUrl = headerUrl;
    }

    public Date getCreateTime() {
        return createTime;
    }

    public void setCreateTime(Date createTime) {
        this.createTime = createTime;
    }

    @Override
    public String toString() {
        return "User{" +
                "id=" + id +
                ", username='" + username + '\'' +
                ", password='" + password + '\'' +
                ", salt='" + salt + '\'' +
                ", email='" + email + '\'' +
                ", type=" + type +
                ", status=" + status +
                ", activationCode='" + activationCode + '\'' +
                ", headerUrl='" + headerUrl + '\'' +
                ", createTime=" + createTime +
                '}';
    }
}
```

#### 4、创建 mapper 

在 mapper 文件夹里创建 UserMapper 类,代码如下：

```java
@Mapper
public interface UserMapper {

    User selectById(int id);

    User selectByName(String username);

    User selectByEmail(String email);

    int insertUser(User user);

    int updateStatus(int id, int status);

    int updateHeader(int id, String headerUrl);

    int updatePassword(int id, String password);
}
```

> [@Mapper和@Repository使用的区别](http://www.jianshu.com/p/34f48d31edee)

#### 5、配置 mapper 对应的 xml 文件

在 resource 中创建 UserMapper.xml,代码如下：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dyl.community.mapper.UserMapper">

    <sql id="insertFields">
        username, password, salt, email, type, status, activation_code, header_url, create_time
    </sql>

    <sql id="selectFields">
        id, username, password, salt, email, type, status, activation_code, header_url, create_time
    </sql>

    <select id="selectById" resultType="User">
        select
        <include refid="selectFields"></include>
        from user
        where id = #{id}
    </select>

    <select id="selectByName" resultType="User">
        select
        <include refid="selectFields"></include>
        from user
        where username = #{username}
    </select>

    <select id="selectByEmail" resultType="User">
        select
        <include refid="selectFields"></include>
        from user
        where email = #{email}
    </select>

    <insert id="insertUser" parameterType="User" keyProperty="id">
        insert into user (<include refid="insertFields"></include>)
        values(#{username}, #{password}, #{salt}, #{email}, #{type}, #{status}, #{activationCode}, #{headerUrl},
        #{createTime})
    </insert>

    <update id="updateStatus">
        update user set status = #{status} where id = #{id}
    </update>

    <update id="updateHeader">
        update user set header_url = #{headerUrl} where id = #{id}
    </update>

    <update id="updatePassword">
        update user set password = #{password} where id = #{id}
    </update>
</mapper>
```

> 担心 UserMapper.xml 文件里的语句写错的话，可以在 application.yaml 中配置日志级别
>
> ```yaml
> # logger
> logging:
>   level:
>     com.dyl.community:
>       debug
> ```

#### 6、编写测试类

在 UserMapper.java 中将光标放到接口名上，按住 alt + enter 创建测试类

![image-20220711162944223](http://qiniu.dyl.fit/Interview/image-20220711162944223.png)

测试类代码如下所示：

```java
@SpringBootTest
class UserMapperTest {

    @Resource
    private UserMapper userMapper;

    @Test
    void testSelectUser() {
        User user = userMapper.selectById(159);
        System.out.println(user);
        // User{id=159, username='xinghe1', password='ed11a2767003198f6cb9b3330889285b', salt='2b01d', email='2334238730@qq.com', type=0, status=1, activationCode='f76d0e133c3b447f9f9414082223a8c2', headerUrl='http://images.nowcoder.com/head/411t.png', createTime=Fri Jul 08 09:40:21 CST 2022}

        user = userMapper.selectByName("liubei");
        System.out.println(user);
        // User{id=101, username='liubei', password='390ba5f6b5f18dd4c63d7cda170a0c74', salt='12345', email='nowcoder101@sina.com', type=0, status=1, activationCode='null', headerUrl='http://images.nowcoder.com/head/100t.png', createTime=Wed Apr 03 12:04:55 CST 2019}

        user = userMapper.selectByEmail("2334238730@qq.com");
        System.out.println(user);
        // User{id=159, username='xinghe1', password='ed11a2767003198f6cb9b3330889285b', salt='2b01d', email='2334238730@qq.com', type=0, status=1, activationCode='f76d0e133c3b447f9f9414082223a8c2', headerUrl='http://images.nowcoder.com/head/411t.png', createTime=Fri Jul 08 09:40:21 CST 2022}
    }

    @Test
    void testInsertUser() {
        User user = new User();
        user.setUsername("test");
        user.setPassword("123456");
        user.setSalt("abc");
        user.setEmail("test@qq.com");
        user.setHeaderUrl("http://www.nowcoder.com/101.png");
        user.setCreateTime(new Date());

        int rows = userMapper.insertUser(user);
        System.out.println(rows);
        // 1
        System.out.println(user.getId());
        // 160
    }

    @Test
    void testUpdateUser() {
        int rows = userMapper.updateStatus(103, 1);
        System.out.println(rows);
        // 1

        rows = userMapper.updateHeader(103, "http://www.nowcoder.com/102.png");
        System.out.println(rows);
        // 1
        
        rows = userMapper.updatePassword(103, "hello");
        System.out.println(rows);
        // 1
    }
}
```

### 1.6 开发社区首页

* 分步实现
  * 开发社区首页，显示前10个帖子
  * 开发分页组件，分页显示所有的帖子

<qiniu src="http://qiniu.dyl.fit/Interview/20191114210434.png" alt="avater" style="zoom:60%;" />

#### 1、创建实体类对象

在 model 文件夹的 domain 文件夹内创建实体类 DiscussPost.java,代码如下所示：

```java
public class DiscussPost {

    private int id;

    private int userId;

    private String title;

    private String content;

    private int type;

    private int status;

    private Date createTime;

    private int commentCount;

    private double score;

    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    public int getUserId() {
        return userId;
    }

    public void setUserId(int userId) {
        this.userId = userId;
    }

    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public int getType() {
        return type;
    }

    public void setType(int type) {
        this.type = type;
    }

    public int getStatus() {
        return status;
    }

    public void setStatus(int status) {
        this.status = status;
    }

    public Date getCreateTime() {
        return createTime;
    }

    public void setCreateTime(Date createTime) {
        this.createTime = createTime;
    }

    public int getCommentCount() {
        return commentCount;
    }

    public void setCommentCount(int commentCount) {
        this.commentCount = commentCount;
    }

    public double getScore() {
        return score;
    }

    public void setScore(double score) {
        this.score = score;
    }

    @Override
    public String toString() {
        return "DiscussPost{" +
                "id=" + id +
                ", userId=" + userId +
                ", title='" + title + '\'' +
                ", content='" + content + '\'' +
                ", type=" + type +
                ", status=" + status +
                ", createTime=" + createTime +
                ", commentCount=" + commentCount +
                ", score=" + score +
                '}';
    }
}
```

#### 2、创建 mapper 对象

在 mapper 文件夹里创建 DiscussPostMapper.java，代码如下：

```java
@Mapper
public interface DiscussPostMapper {

    List<DiscussPost> selectDiscussPosts(int userId, int offset, int limit);

    /**
     * @param userId
     * @return
     * @Param注解用于给参数取别名,如果只有一个参数,并且在<if>里使用,则必须加别名.
     */
    int selectDiscussPostRows(@Param("userId") int userId);

    int insertDiscussPost(DiscussPost discussPost);

    DiscussPost selectDiscussPostById(int id);

    int updateCommentCount(int id, int commentCount);

    int updateType(int id, int type);

    int updateStatus(int id, int status);

    int updateScore(int id, double score);
}
```

#### 3、配置 mapper 对应的 xml 文件

在 resource 中创建 DiscussPostMapper.xml,代码如下：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dyl.community.mapper.DiscussPostMapper">

    <sql id="selectFields">
        id, user_id, title, content, type, status, create_time, comment_count, score
    </sql>

    <sql id="insertFields">
        user_id, title, content, type, status, create_time, comment_count, score
    </sql>

    <select id="selectDiscussPosts" resultType="DiscussPost">
        select
        <include refid="selectFields"/>
        from discuss_post
        where status != 2
        <if test="userId!=0">
            and user_id = #{userId}
        </if>
        order by type desc, create_time desc
        limit #{offset}, #{limit}
    </select>

    <select id="selectDiscussPostRows" resultType="int">
        select count(id)
        from discuss_post
        where status != 2
        <if test="userId!=0">
            and user_id = #{userId}
        </if>
    </select>

</mapper>
```

#### 4、创建 DiscussPostMapper 对应的测试类

在 DiscussPostMapper 类中光标放到类名上按 alt + enter 键，创建对应的测试类 DiscussPostMapperTest.java，代码如下所示：

```java
@SpringBootTest
class DiscussPostMapperTest {

    @Resource
    private DiscussPostMapper discussPostMapper;

    @Test
    void testSelectPosts() {
        List<DiscussPost> list = discussPostMapper.selectDiscussPosts(149, 0, 10);
        for (DiscussPost post : list) {
            System.out.println(post);
        }
        // DiscussPost{id=280, userId=149, title='事务', content='事务的4个特性，包括原子性、一致性、隔离性、持久性。', type=0, status=0, createTime=Mon May 20 17:41:30 CST 2019, commentCount=16, score=1755.2095150145426}
        // DiscussPost{id=277, userId=149, title='Spring Cache', content='Spring Cache RedisCacheManager', type=0, status=0, createTime=Fri May 17 17:06:54 CST 2019, commentCount=38, score=1752.5797835966168}
        // DiscussPost{id=276, userId=149, title='新人报道', content='新人报道，请多关照！', type=0, status=0, createTime=Fri May 17 15:50:18 CST 2019, commentCount=6, score=1751.806179973984}


        int rows = discussPostMapper.selectDiscussPostRows(149);
        System.out.println(rows);
        // 3 
    }

}
```

#### 5、创建 service 层

在 service 包内创建 DiscussPostService.java，代码如下所示：

```java
@Service
public class DiscussPostService {

    @Resource
    private DiscussPostMapper discussPostMapper;

    public List<DiscussPost> findDiscussPosts(int userId, int offset, int limit) {
        return discussPostMapper.selectDiscussPosts(userId, offset, limit);
    }

    public int findDiscussPost(int userId) {
        return discussPostMapper.selectDiscussPostRows(userId);
    }

    public int findDiscussPostRows(int userId) {
        return discussPostMapper.selectDiscussPostRows(userId);
    }
}
```

此时应注意到在返回的 DiscussPost 对象中包含 userId ,而我们应该是返回 userId 对应的 username ,所以需要新建一个UserService 来处理业务，在 service 包内创建 UserService.java，代码如下：

```java
@Service
public class UserService {

    @Resource
    private UserMapper userMapper;

    public User findUserById(int id) {
        return userMapper.selectById(id);
    }
}
```

#### 6、引入静态资源

静态资源链接：http://pan.baidu.com/s/15mTU3cdfZ_7DMPzAXaQWzg 提取码：cwm2

#### 7、创建 controller 层

在 controller 包内创建 HomeController.java，代码如下所示：

```java
@Controller
public class HomeController {

    @Resource
    private DiscussPostService discussPostservice;

    @Resource
    private UserService userService;

    @GetMapping("/index")
    public String getIndexPage(Model model) {
        List<DiscussPost> list = discussPostservice.findDiscussPosts(0, 0, 10);
        List<Map<String, Object>> discussPosts = new ArrayList<>();
        if (list != null) {
            for (DiscussPost post : list) {
                Map<String, Object> map = new HashMap<>();
                map.put("post", post);
                User user = userService.findUserById(post.getUserId());
                map.put("user", user);
                discussPosts.add(map);
            }
        }
        model.addAttribute("discussPosts", discussPosts);
        return "/index";
    }
}
```

8、处理前端界面

找到 index.html 界面，先在开头引入 thymeleaf

```html
<html lang="en" xmlns:th="http://www.thymeleaf.org">
```

接着处理头部和尾部的相对路径的 css、js 等文件

```html
<link rel="stylesheet" th:href="@{/css/global.css}"/>
```

```html
<script th:src="@{/js/global.js}"></script>
<script th:src="@{/js/index.js}"></script>
```

删除多余的帖子列表里的 <li></li> 元素,只保留一个，然后用 for 语句进行循环输出。

帖子列表的修改后的代码如下：

```html
<!-- 帖子列表 -->
<ul class="list-unstyled">
    <li class="media pb-3 pt-3 mb-3 border-bottom" th:each="map:${discussPosts}">
        <a href="site/profile.html">
            <qiniu th:src="${map.user.headerUrl}" class="mr-4 rounded-circle" alt="用户头像"
                 style="width:50px;height:50px;">
        </a>
        <div class="media-body">
            <h6 class="mt-0 mb-3">
                <a href="#" th:utext="${map.post.title}">备战春招，面试刷题跟他复习，一个月全搞定！</a>
                <span class="badge badge-secondary bg-primary" th:if="${map.post.type==1}">置顶</span>
                <span class="badge badge-secondary bg-danger" th:if="${map.post.status==1}">精华</span>
            </h6>
            <div class="text-muted font-size-12">
                <u class="mr-3" th:utext="${map.user.username}">寒江雪</u> 发布于 <b th:text="${#dates.format(map.post.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 15:32:18</b>
                <ul class="d-inline float-right">
                    <li class="d-inline ml-2">赞 11</li>
                    <li class="d-inline ml-2">|</li>
                    <li class="d-inline ml-2">回帖 7</li>
                </ul>
            </div>
        </div>
    </li>
</ul>
```

> th:utext和th:text的区别在于前者能将文字里需要转义的字符自动转义，例如 "\&lt;" 代表是小于号,在前者是可以自动被转义的

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/index，输出结果：

![image-20220712092450243](http://qiniu.dyl.fit/Interview/image-20220712092450243.png)

可以看到的确是首页显示了 10 个帖子。

#### 8、完成分页功能

##### 8.1 创建实体类

在 domain 包内创建 Page 实体类来封装分页相关信息，代码如下：

```java
public class Page {

    /**
     * 当前页码
     */
    private int current = 1;

    /**
     * 显示上限
     */
    private int limit = 10;

    /**
     * 数据总数(用于计算总页数)
     */
    private int rows;

    /**
     * 查询路径(用于复用分页链接)
     */
    private String path;

    public int getCurrent() {
        return current;
    }

    public void setCurrent(int current) {
        if (current >= 1) {
            this.current = current;
        }
    }

    public int getLimit() {
        return limit;
    }

    public void setLimit(int limit) {
        if (limit >= 1 && limit <= 100) {
            this.limit = limit;
        }
    }

    public int getRows() {
        return rows;
    }

    public void setRows(int rows) {
        if (rows >= 0) {
            this.rows = rows;
        }
    }

    public String getPath() {
        return path;
    }

    public void setPath(String path) {
        this.path = path;
    }

    /**
     * 获取当前页的起始行
     *
     * @return int
     */
    public int getOffset() {
        // current * limit - limit
        return (current - 1) * limit;
    }

    /**
     * 获取总页数
     *
     * @return int
     */
    public int getTotal() {
        // rows / limit [+1]
        if (rows % limit == 0) {
            return rows / limit;
        } else {
            return rows / limit + 1;
        }
    }

    /**
     * 获取起始页码
     *
     * @return int
     */
    public int getFrom() {
        int from = current - 2;
        return Math.max(from, 1);
    }

    /**
     * 获取结束页码
     *
     * @return int
     */
    public int getTo() {
        int to = current + 2;
        int total = getTotal();
        return Math.min(to, total);
    }
}
```

##### 8.2 修改controller层

将 HomeController 的 getIndexPage() 方法修改为如下代码：

```java
@GetMapping("/index")
public String getIndexPage(Model model, Page page) {
    // 方法调用之前，springMVC会自动实例化Model和Page，并将Page注入Model
    // 所以在thymeleaf中可以直接访问Page对象的数据
    page.setRows(discussPostservice.findDiscussPostRows(0));
    page.setPath("/index");

    List<DiscussPost> list = discussPostservice.findDiscussPosts(0, page.getOffset(), page.getLimit());
    List<Map<String, Object>> discussPosts = new ArrayList<>();
    if (list != null) {
        for (DiscussPost post : list) {
            Map<String, Object> map = new HashMap<>();
            map.put("post", post);
            User user = userService.findUserById(post.getUserId());
            map.put("user", user);
            discussPosts.add(map);
        }
    }
    model.addAttribute("discussPosts", discussPosts);
    return "/index";
}
```

##### 8.3 修改前端界面

将 index.html 中的分页代码修改为如下代码：

```html
<nav class="mt-5" th:if="${page.rows > 0}">
    <ul class="pagination justify-content-center">
        <li class="page-item">
            <a class="page-link" th:href="@{${page.path}(current = 1)}">首页</a></li>
        <li th:class="|page-item ${page.current == 1?'disabled':''}|">
            <a class="page-link" th:href="@{${page.path}(current = ${page.current - 1})}">上一页</a></li>
        <li th:class="|page-item ${i == page.current ? 'active' : ''}|"
            th:each="i : ${#numbers.sequence(page.from,page.to)}">
            <a class="page-link" th:text="${i}">1</a></li>
        <li th:class="|page-item ${page.current == page.total?'disabled':''}|">
            <a class="page-link" th:href="@{${page.path}(current = ${page.current + 1})}">下一页</a></li>
        <li class="page-item">
            <a class="page-link" th:href="@{${page.path}(current = ${page.total})}">末页</a></li>
    </ul>
</nav>
```

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/index，输出结果:

![image-20220712100031422](http://qiniu.dyl.fit/Interview/image-20220712100031422.png)

![image-20220712100139772](http://qiniu.dyl.fit/Interview/image-20220712100139772.png)

### 1.7 项目调试技巧

#### 1、响应状态码的含义

200 OK -> 请求成功

302 Found -> 此响应代码表示所请求资源的 URI 已暂时更改。未来可能会对 URI 进行进一步的改变。因此，客户机应该在将来的请求中使用这个相同的 URI。(重定向问题)

![image-20220712100850891](http://qiniu.dyl.fit/Interview/image-20220712100850891.png)

404 Not Found -> 服务器找不到请求的资源。在浏览器中，这意味着无法识别 URL。在 API 中，这也可能意味着端点有效，但资源本身不存在。服务器也可以发送此响应，而不是 403 Forbidden，以向未经授权的客户端隐藏资源的存在。这个响应代码可能是最广为人知的，因为它经常出现在网络上。(一般是访问路径写错了)

500 Internal Server Error -> 服务器遇到了不知道如何处理的情况。（服务器出现问题）

#### 2、服务端断点调试技巧

![image-20220712101349910](http://qiniu.dyl.fit/Interview/image-20220712101349910.png)

F8 逐行执行

F7 进入当前行

F9 直接执行到下一个断点

#### 3、客户端断点调试技巧

![image-20220712101915731](http://qiniu.dyl.fit/Interview/image-20220712101915731.png)

F10 逐行执行

F11 进入当前行（很少用）

F8 直接执行到下一个断点

#### 4、设置日志级别，并将日志输出到不同的终端

将 application.yaml 中的 logger 配置删除

```yaml
# logger
logging:
  level:
    com.dyl.community:
      debug
```

在 resource 文件夹里新增 logback-spring.xml，代码如下：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <contextName>community</contextName>
    <property name="LOG_PATH" value="D:/Learn/牛客网论坛项目/log"/>
    <property name="APPDIR" value="community"/>

    <!-- error file -->
    <appender name="FILE_ERROR" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${APPDIR}/log_error.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${APPDIR}/error/log-error-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>5MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <append>true</append>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d %level [%thread] %logger{10} [%file:%line] %msg%n</pattern>
            <charset>utf-8</charset>
        </encoder>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>error</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
    </appender>

    <!-- warn file -->
    <appender name="FILE_WARN" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${APPDIR}/log_warn.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${APPDIR}/warn/log-warn-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>5MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <append>true</append>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d %level [%thread] %logger{10} [%file:%line] %msg%n</pattern>
            <charset>utf-8</charset>
        </encoder>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>warn</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
    </appender>

    <!-- info file -->
    <appender name="FILE_INFO" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${APPDIR}/log_info.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${APPDIR}/info/log-info-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>5MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <append>true</append>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d %level [%thread] %logger{10} [%file:%line] %msg%n</pattern>
            <charset>utf-8</charset>
        </encoder>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>info</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
    </appender>

    <!-- console -->
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d %level [%thread] %logger{10} [%file:%line] %msg%n</pattern>
            <charset>utf-8</charset>
        </encoder>
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>debug</level>
        </filter>
    </appender>

    <logger name="com.dyl.community" level="debug"/>

    <root level="info">
        <appender-ref ref="FILE_ERROR"/>
        <appender-ref ref="FILE_WARN"/>
        <appender-ref ref="FILE_INFO"/>
        <appender-ref ref="STDOUT"/>
    </root>

</configuration>
```

创建测试类 LoggerTests，代码如下：

```java
@SpringBootTest
class LoggerTests {

    private static final Logger logger = LoggerFactory.getLogger(LoggerTests.class);

    @Test
    void testLogger() {
        System.out.println(logger.getName());

        logger.debug("debug log");
        logger.info("info log");
        logger.warn("warn log");
        logger.error("error log");
    }
}
```

运行测试类，输出结果：

![image-20220712103724708](http://qiniu.dyl.fit/Interview/image-20220712103724708.png)

![image-20220712103711999](http://qiniu.dyl.fit/Interview/image-20220712103711999.png)

### 1.8 版本控制

#### 1、认识Git

git是一个常用的分布式版本控制系统

#### 2、Git的安装与配置

git安装包：链接：http://pan.baidu.com/s/1glojcdz6MmNO5h8chppoIw 提取码：c82y 

git配置：

```c
# 账号配置
git config --list
git config --global user.name "xinghe"
git config --global user.email "1329749225@qq.com"
# 本地仓库
git init
git status -s
git add *
git commit -m '...'
# 生成秘钥
ssh-keygen -t rsa -C "1329749225@qq.com"
# 推送已有项目
git remote add origin
http://github.com/xingheDYL/community.git
git push -u origin master
# 克隆已有仓库
git clone http://github.com/xingheDYL/community.git
```

#### 3、IDEA集成Git

![image-20220712105024183](http://qiniu.dyl.fit/Interview/image-20220712105024183.png)

使用时先创建一个git repository

![image-20220712104854839](http://qiniu.dyl.fit/Interview/image-20220712104854839.png)

然后在右上角可以提交和拉取

## 第2章 Spring Boot实践，开发社区登陆模块

### 2.1 发送邮件

这里以QQ邮箱来完成发送邮件功能

#### 2.1.1 邮箱设置

登录QQ邮箱，点击设置，在账户一栏中先开启第一行的 SMTP 服务，再点击生成授权码，并保存授权码。

![image-20220708132416006](http://qiniu.dyl.fit/Interview/image-20220708132416006.png)

![image-20220708132835801](http://qiniu.dyl.fit/Interview/image-20220708132835801.png)

#### 2.1.2 导入依赖

在 [maven仓库](http://mvnrepository.com/) 中搜索 [spring boot starter mail](http://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-mail) ,选择一个较新且使用人数较多的版本进行安装依赖。

```xml
<!-- http://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-mail -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-mail</artifactId>
    <version>2.1.18.RELEASE</version>
</dependency>
```

#### 2.1.3 邮箱参数配置

```yaml
# MailProperties
spring: 
    mail:
      host: smtp.qq.com
      port: 465
      username: 1329749225@qq.com
      password: 此处填写授权码
      protocol: smtps
      # 在发送邮件时候产生SSL安全连接
      properties:
        mail:
          smtp:
            ssl:
              enable: true
```

#### 2.1.4 使用 JavaMailSender 发送邮件

在 utils 包内创建工具类 MailClient.java

```java
@Component
//Component注解表示该类由spring容器管理，且是公用的，在哪个层次内都可以使用
public class MailClient {

    /**
     * 记录日志 s4fj
     */
    private static final Logger logger = LoggerFactory.getLogger(MailClient.class);

    @Resource
    private JavaMailSender mailSender;

    /**
     * 将发件人注入，从而便捷使用
     */
    @Value("${spring.mail.username}")
    private String from;

    /**
     * 发送右键
     *
     * @param to      收件人
     * @param subject 邮件主题
     * @param content 邮件内容
     */
    public void sendMail(String to, String subject, String content) {
        try {
            MimeMessage message = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(message, true);
            helper.setFrom(from);
            helper.setTo(to);
            helper.setSubject(subject);
            // 支持HTML文本
            helper.setText(content, true);
            mailSender.send(helper.getMimeMessage());
        } catch (MessagingException e) {
            logger.error("发送邮件失败:" + e.getMessage());
        }
    }
}
```

编写测试类MailTests.java

```java
@SpringBootTest
public class MailTests {

    @Autowired
    private MailClient mailClient;

    @Autowired
    private TemplateEngine templateEngine;

    @Test
    void testSendTextMail() {
        mailClient.sendMail("2334238730@qq.com", "TEXT", "Welcome.");
    }

    @Test
    void testSendHtmlMail() {
        Context context = new Context();
        context.setVariable("username","sunday");

        String content = templateEngine.process("/mail/demo", context);
        System.out.println(content);

        mailClient.sendMail("2334238730@qq.com", "HTML", content);
    }
}
```

#### 2.1.5 模板引擎

##### 使用 Thymeleaf 发送 HTML 邮件

在template文件夹下面新建mail文件夹，在文件夹里新增demo.html

```html
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>邮件示例</title>
</head>
<body>

<p>
    欢迎您，<span style="color: red">[[${username}]]</span>！
<!--    欢迎您，<span style="color: red" th:text="${username}"></span>！-->
    啦啦啦
</p>
</body>
</html>
```

##### 发送结果

![](http://qiniu.dyl.fit/Interview/image-20220708150730033.png)

### 2.2 开发注册功能

#### 1、访问注册页面

点击顶部区域内的链接，打开注册页面。

##### 1.1 创建 controller 控制层

在Controller包里新建LoginController.java类，代码如下：

```java
@Controller
public class LoginController {
    @GetMapping(value = "/register")
    public String getRegisterPage() {
        return "/site/register";
    }
}
```

##### 1.2 修改前端界面

将 index.html 页头和页尾的相对路径改成 thymeleaf 语法的路径，并将 index.html 的头部和尾部的代码进行复用，以便提供给别的界面进行复用

```html
<link rel="stylesheet" th:href="@{/css/global.css}"/>
```

```html
<script th:src="@{/js/global.js}"></script>
<script th:src="@{/js/index.js}"></script>
```

```html
<!-- 头部 -->
<header class="bg-dark sticky-top" th:fragment="header">
```

```html
<!-- 尾部 -->
<footer class="bg-dark" th:fragment="footer">
```

将 index.html 中头部的功能部分的代码修改为如下：

```html
<li class="nav-item ml-3 btn-group-vertical">
    <a class="nav-link" th:href="@{/index}">首页</a>
</li>
<li class="nav-item ml-3 btn-group-vertical">
    <a class="nav-link" th:href="@{/register}">注册</a>
</li>
```

将 register.html 代码中的路径也进行修改为 thymeleaf 语法的路径，并且在头部和尾部复用 index.html 中的代码,如下所示：

```html
<link rel="stylesheet" th:href="@{/css/global.css}"/>
<link rel="stylesheet" th:href="@{/css/login.css}"/>
```

```html
<script th:src="@{/js/global.js}"></script>
<script th:src="@{/js/register.js}"></script>
```

```html
<!-- 头部 -->
<header class="bg-dark sticky-top" th:replace="index::header"></header>
```

```html
<!-- 尾部 -->
<footer class="bg-dark" th:replace="index::footer"></footer>
```

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/index，输出结果:

![动画1](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB1.gif)

#### 2、提交注册数据

* 通过表单提交数据。
* 服务端验证账号是否已存在、邮箱是否已注册。
* 服务端发送激活邮件。

##### 2.1 引入 commons long3 工具类的依赖

在pom.xml中引入 commons-lang3 的依赖

```xml
<!-- http://mvnrepository.com/artifact/org.apache.commons/commons-lang3 -->
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-lang3</artifactId>
    <version>3.9</version>
</dependency>
```

##### 2.2 配置 yaml 文件

在 application.yaml 中增加自定义的配置文件，使用户在点击邮件激活后重定向到项目的界面

```yaml
# 自定义属性
community:
  path:
    domain: http://localhost:8080
```

##### 2.3 创建工具类

在 utils 包内创建 CommunityUtil.java，代码如下：

```java
public class CommunityUtil {

    /**
     * 生成随机字符串
     *
     * @return String
     */
    public static String generateUUID() {
        return UUID.randomUUID().toString().replaceAll("-", "");
    }

    /**
     * MD5加密
     * hello -> abc123def456
     * hello + 3e4a8 -> abc123def456abc
     */
    public static String md5(String key) {
        if (StringUtils.isBlank(key)) {
            return null;
        }
        return DigestUtils.md5DigestAsHex(key.getBytes());
    }
}
```

##### 2.4 创建 service 层

在 UserService 中注入 邮件发送和 thymeleaf 引擎，并且将激活后需要重定向的自定义的域名和路径进行注入。

```java
@Resource
private MailClient mailClient;

@Resource
private TemplateEngine templateEngine;

@Value("${community.path.domain}")
private String domain;

@Value("${server.servlet.context-path}")
private String contextPath;
```

然后创建 register() 方法，代码如下:

```java
public Map<String, Object> register(User user) {
    Map<String, Object> map = new HashMap<>();

    //空值处理
    if (user == null) {
        throw new IllegalArgumentException("参数不能为空!");
    }

    if (StringUtils.isBlank(user.getUsername())) {
        map.put("usernameMsg", "账号不能为空!");
        return map;
    }

    if (StringUtils.isBlank(user.getPassword())) {
        map.put("passwordMsg", "密码不能为空!");
        return map;
    }

    if (StringUtils.isBlank(user.getEmail())) {
        map.put("emailMsg", "邮箱不能为空!");
        return map;
    }

    // 验证账号
    User usertest = userMapper.selectByName(user.getUsername());
    if (usertest != null) {
        map.put("usernameMsg", "该账号已存在!");
        return map;
    }

    // 验证邮箱
    usertest = userMapper.selectByEmail(user.getEmail());
    if (usertest != null) {
        map.put("emailMsg", "该邮箱已被注册!");
        return map;
    }

    // 注册用户
    user.setSalt(CommunityUtil.generateUUID().substring(0, 5));
    user.setPassword(CommunityUtil.md5(user.getPassword() + user.getSalt()));
    user.setType(0);
    user.setStatus(0);
    user.setActivationCode(CommunityUtil.generateUUID());
    user.setHeaderUrl(String.format("http://images.nowcoder.com/head/%dt.png", new Random().nextInt(1000)));
    user.setCreateTime(new Date());
    userMapper.insertUser(user);

    // 激活邮件
    Context context = new Context();
    context.setVariable("email", user.getEmail());
    // http://localhost:8080/community/activation/101/code
    String url = domain + contextPath + "/activation/" + user.getId() + "/" + user.getActivationCode();
    context.setVariable("url", url);
    String content = templateEngine.process("/mail/activation", context);
    mailClient.sendMail(user.getEmail(), "激活账号", content);

    return map;
}
```

##### 2.5 修改 activation.html 文件

修改 mail 包内的 activation.html 文件，代码如下：

```html
<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <!--    <link rel="icon" th:href="@{/qiniu/icon.png}"/>-->
    <title>星河论坛-激活账号</title>
</head>
<body>
<div>
    <p>
        <b th:text="${email}">xxx@xxx.com</b>, 您好!
    </p>
    <p>
        您正在注册牛客网, 这是一封激活邮件, 请点击
        <a th:href="${url}">此链接</a>,
        激活您的牛客账号!
    </p>
</div>
</body>
</html>
```

##### 2.6 修改 controller 层

在 LoginController 中注入 UserService

```java
@Resource
private UserService userService;
```

创建 post 请求的 register() 方法

```java
@PostMapping("/register")
public String register(Model model, User user) {
    Map<String, Object> map = userService.register(user);
    if (map == null || map.isEmpty()) {
        model.addAttribute("msg", "注册成功,我们已经向您的邮箱发送了一封激活邮件,请尽快激活!");
        //最终跳转到首页
        model.addAttribute("target", "/index");
        return "/site/operate-result";
    } else {
        model.addAttribute("usernameMsg", map.get("usernameMsg"));
        model.addAttribute("passwordMsg", map.get("passwordMsg"));
        model.addAttribute("emailMsg", map.get("emailMsg"));
        return "/site/register";
    }
}
```

##### 2.7 修改 operate-result.html 文件

修改 operate-result.html 中的相对路径,然后将头部和尾部复用 index.html 中的代码,最后将内容修改为如下代码：

```html
<!-- 内容 -->
<div class="main">
   <div class="container mt-5">
      <div class="jumbotron">
         <p class="lead" th:text="${msg}">您的账号已经激活成功,可以正常使用了!</p>
         <hr class="my-4">
         <p>
            系统会在 <span id="seconds" class="text-danger">8</span> 秒后自动跳转,
            您也可以点此 <a id="target" th:href="@{${target}}" class="text-primary">链接</a>, 手动跳转!
         </p>
      </div>
   </div>
</div>
```

运行 CommunityApplication，在浏览器中输入 http://localhost:8080/community/index，点击注册填入信息后，输出结果如下：

![image-20220712145036046](http://qiniu.dyl.fit/Interview/image-20220712145036046.png)

![image-20220712144930079](http://qiniu.dyl.fit/Interview/image-20220712144930079.png)

> 此时点击此链接会报错，因为还没有处理激活逻辑

#### 3、激活注册账号

点击邮件中的链接，访问服务端的激活服务。

##### 3.1 创建 constant 包

在其中创建 CommunityConstant接口，代码如下：

```java
public interface CommunityConstant {

    /**
     * 激活成功
     */
    int ACTIVATION_SUCCESS = 0;

    /**
     * 重复激活
     */
    int ACTIVATION_REPEAT = 1;

    /**
     * 激活失败
     */
    int ACTIVATION_FAILURE = 2;

}
```

##### 3.2 修改 service 层

在 UserService 中添加 activation() 方法，代码如下：

```java
public int activation(int userId, String code) {
    User user = userMapper.selectById(userId);
    if (user.getStatus() == 1) {
        return ACTIVATION_REPEAT;
    } else if (user.getActivationCode().equals(code)) {
        userMapper.updateStatus(userId, 1);
        return ACTIVATION_SUCCESS;
    } else {
        return ACTIVATION_FAILURE;
    }
}
```

##### 3.3 修改 controller 层

在 LoginController 中添加 activation() 方法，代码如下：

```java
// http://localhost:8080/community/activation/101/code
@GetMapping("/activation/{userId}/{code}")
public String activation(Model model, @PathVariable("userId") int userId, @PathVariable("code") String code) {
    int result = userService.activation(userId, code);
    if (result == ACTIVATION_SUCCESS) {
        model.addAttribute("msg", "激活成功,您的账号已经可以正常使用了!");
        model.addAttribute("target", "/login");
    } else if (result == ACTIVATION_REPEAT) {
        model.addAttribute("msg", "无效操作,该账号已经激活过了!");
        model.addAttribute("target", "/index");
    } else {
        model.addAttribute("msg", "激活失败,您提供的激活码不正确!");
        model.addAttribute("target", "/index");
    }
    return "/site/operate-result";
}
```

再在其中添加 getLoginPage() 方法

```java
@GetMapping(value = "/login")
public String getLoginPage() {
    return "/site/login";
}
```

##### 3.4 修改前端界面

###### 修改 index.html 页面

在头部的功能区将 login 处的代码修改如下：

```html
<li class="nav-item ml-3 btn-group-vertical">
    <a class="nav-link" th:href="@{/login}">登录</a>
</li>
```

###### 修改 login.html 页面

复用 index.html 的头部和尾部，以及更改相对路径。

```html
<link rel="stylesheet" th:href="@{/css/global.css}"/>
<link rel="stylesheet" th:href="@{/css/login.css}"/>
```

```html
<script th:src="@{/js/global.js}"></script>
```

###### 修改 register.html 页面

将其中的内容部分修改为如下代码：

```html
<!-- 内容 -->
<div class="main">
    <div class="container pl-5 pr-5 pt-3 pb-3 mt-3 mb-3">
        <h3 class="text-center text-info border-bottom pb-3">注&nbsp;&nbsp;册</h3>
        <form class="mt-5" method="post" th:action="@{/register}">
            <div class="form-group row">
                <label for="username" class="col-sm-2 col-form-label text-right">账号:</label>
                <div class="col-sm-10">
                    <input type="text"
                           th:class="|form-control ${usernameMsg != null ? 'is-invalid' : ''}|"
                           th:value="${user != null ? user.username : ''}"
                           id="username" name="username" placeholder="请输入您的账号!" required>
                    <div class="invalid-feedback" th:text="${usernameMsg}">
                        该账号已存在!
                    </div>
                </div>
            </div>
            <div class="form-group row mt-4">
                <label for="password" class="col-sm-2 col-form-label text-right">密码:</label>
                <div class="col-sm-10">
                    <input type="password"
                           th:class="|form-control ${passwordMsg != null ? 'is-invalid' : ''}|"
                           th:value="${user != null ? user.password : ''}"
                           id="password" name="password" placeholder="请输入您的密码!" required>
                    <div class="invalid-feedback" th:text="${passwordMsg}">
                        密码长度不能小于8位!
                    </div>
                </div>
            </div>
            <div class="form-group row mt-4">
                <label for="confirm-password" class="col-sm-2 col-form-label text-right">确认密码:</label>
                <div class="col-sm-10">
                    <input type="password" class="form-control"
                           th:value="${user != null ? user.password : ''}"
                           id="confirm-password" placeholder="请再次输入密码!" required>
                    <div class="invalid-feedback">
                        两次输入的密码不一致!
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <label for="email" class="col-sm-2 col-form-label text-right">邮箱:</label>
                <div class="col-sm-10">
                    <input type="email"
                           th:class="|form-control ${emailMsg != null ? 'is-invalid' : ''}|"                               th:value="${user != null ? user.email : ''}"
                           id="email" name="email" placeholder="请输入您的邮箱!" required>
                    <div class="invalid-feedback" th:text="${emailMsg}">
                        该邮箱已注册!
                    </div>
                </div>
            </div>
            <div class="form-group row mt-4">
                <div class="col-sm-2"></div>
                <div class="col-sm-10 text-center">
                    <button type="submit" class="btn btn-info text-white form-control">立即注册</button>
                </div>
            </div>
        </form>
    </div>
</div>
```

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/index，注册之后点击邮箱里的链接，结果如下:

![image-20220712150140089](http://qiniu.dyl.fit/Interview/image-20220712150140089.png)

> 此时跳转登录页面之后发现验证码处的图片不能加载，修改 login.html 的内容部分的代码如下所示：
>
> ```html
> <div class="col-sm-4">
>     <qiniu th:src="@{/qiniu/captcha.png}" style="width:100px;height:40px;" class="mr-2"/>
>     <a href="javascript:;" class="font-size-12 align-bottom">刷新验证码</a>
> </div>
> ```

### 2.3 会话管理

#### 1、HTTP的基本性质

HTTP是简单的、HTTP是可扩展的、HTTP是无状态的，有会话的

#### 2、Cookie

是服务器发送到浏览器，并保存在浏览器端的一小块数据。浏览器下次访问该服务器时，会自动携带块该数据，将其发送给服务器。

![image-20220712153634248](http://qiniu.dyl.fit/Interview/image-20220712153634248.png)

#### 3、Cookie 示例：

在 AlphaController 中添加如下代码：

```java
// cookie示例
@GetMapping("/cookie/set")
@ResponseBody
public String setCookie(httpervletResponse response) {
    // 创建cookie
    Cookie cookie = new Cookie("code", CommunityUtil.generateUUID());
    // 设置cookie生效范围
    cookie.setPath("/community/alpha");
    // 设置cookie生存时间
    cookie.setMaxAge(60 * 10);
    // 发送cookie
    response.addCookie(cookie);

    return "set cookie";
}
```

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/alpha/cookie/set，输出结果:

![image-20220712152754411](http://qiniu.dyl.fit/Interview/image-20220712152754411.png)

再增加如下代码

```java
@GetMapping("/cookie/get")
@ResponseBody
public String getCookie(@CookieValue("code") String code) {
    System.out.println(code);
    return "get cookie";
}
```

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/alpha/cookie/get，输出结果:

![image-20220712153006214](http://qiniu.dyl.fit/Interview/image-20220712153006214.png)

#### 4、Session

是JavaEE的标准，用于在服务端记录客户端信息。数据存放在服务端更加安全，但是也会增加服务端的内存压力。

![image-20220712153736921](http://qiniu.dyl.fit/Interview/image-20220712153736921.png)

#### 5、Session 示例

在 AlphaController 中添加如下代码：

```java
// session示例
@GetMapping("/session/set")
@ResponseBody
public String setSession(httpession session) {
    session.setAttribute("id", 1);
    session.setAttribute("name", "test");

    return "set session";
}

@GetMapping("/session/get")
@ResponseBody
public String getSession(httpession session) {
    System.out.println(session.getAttribute("id"));
    System.out.println(session.getAttribute("name"));
    return "get session";
}
```

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/alpha/session/set，输出结果:

![image-20220712154101314](http://qiniu.dyl.fit/Interview/image-20220712154101314.png)

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/alpha/session/get，输出结果:

![image-20220712154117937](http://qiniu.dyl.fit/Interview/image-20220712154117937.png)

![image-20220712154255576](http://qiniu.dyl.fit/Interview/image-20220712154255576.png)

#### 6、面试题

为什么 Session 在分布式部署时使用很少？怎么解决？

![image-20220712155332977](http://qiniu.dyl.fit/Interview/image-20220712155332977.png)

此时服务器无法识别另一台服务器的 session。

解决方法：

粘性 session,绑定了ip和服务器，哪一台服务器给的 session，以后就绑定这台服务器了，缺点是没法做到负载均衡

同步 session，每台服务器都会向其余服务器同步自己的 session,缺点增加了服务器的压力且增加了耦合

共享 session，有一台专门存储 session 的服务器，其余服务器都使用该服务器的 session，缺点是如果这台服务器如果宕机，其余服务器无法使用。

推荐的方案：存储到 MySQL 或者更高效率的 Redis 中

![image-20220712155145153](http://qiniu.dyl.fit/Interview/image-20220712155145153.png)

### 2.4 生成验证码

#### 1、导入 Kaptcha jar 包

在 pom.xml 中引入依赖

```xml
<!-- http://mvnrepository.com/artifact/com.github.penggle/kaptcha -->
<dependency>
    <groupId>com.github.penggle</groupId>
    <artifactId>kaptcha</artifactId>
    <version>2.3.2</version>
</dependency>
```

#### 2、编写 Kaptcha 配置类

在 config 包内创建 KaptchaConfig 类，代码如下所示：

```java
@Configuration
public class KaptchaConfig {
    @Bean
    public Producer kaptchaProducer() {
        Properties properties = new Properties();
        properties.setProperty("kaptcha.image.width", "100");
        properties.setProperty("kaptcha.image.height", "40");
        properties.setProperty("kaptcha.textproducer.font.size", "32");
        properties.setProperty("kaptcha.textproducer.font.color", "0,0,0");
        properties.setProperty("kaptcha.textproducer.char.string", "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ");
        properties.setProperty("kaptcha.textproducer.char.length", "4");
        properties.setProperty("kaptcha.noise.impl", "com.google.code.kaptcha.impl.NoNoise");

        DefaultKaptcha kaptcha = new DefaultKaptcha();
        Config config = new Config(properties);
        kaptcha.setConfig(config);
        return kaptcha;
    }
}
```

#### 3、生成随机字符、生成图片

##### 3.1 修改 controller 层

在 LoginController 中注入 kaptcha

```java
@Resource
private Producer kaptchaProducer;
```

添加 getKaptcha() 方法，代码如下所示：

```java
@GetMapping("/kaptcha")
public void getKaptcha(httpervletResponse response, httpession session) {
    // 生成验证码
    String text = kaptchaProducer.createText();
    BufferedImage image = kaptchaProducer.createImage(text);

    // 将验证码存入session
    session.setAttribute("kaptcha", text);

    // 将图片输出给浏览器
    response.setContentType("image/png");
    try {
        OutputStream os = response.getOutputStream();
        ImageIO.write(image, "png", os);
    } catch (IOException e) {
        logger.error("响应验证码失败" + e.getMessage());
    }
}
```

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/kaptcha，输出结果:

![image-20220712161337827](http://qiniu.dyl.fit/Interview/image-20220712161337827.png)

##### 3.2 修改前端界面

修改 login.html 的内容部分验证码处的代码如下所示：

```html
<div class="col-sm-4">
    <qiniu th:src="@{/kaptcha}" style="width:100px;height:40px;" class="mr-2"/>
    <a href="javascript:;" class="font-size-12 align-bottom">刷新验证码</a>
</div>
```

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/login，输出结果:

![image-20220712162101556](http://qiniu.dyl.fit/Interview/image-20220712162101556.png)

> 此时不能点刷新验证码，只能手动刷新页面显示不同的验证码，下面去完成该按钮的刷新逻辑

修改 login.html 的内容部分验证码处的代码如下所示：

```html
<div class="col-sm-4">
    <qiniu th:src="@{/kaptcha}" id="kaptcha" style="width:100px;height:40px;" class="mr-2"/>
    <a href="javascript:refresh_kaptcha();" class="font-size-12 align-bottom">刷新验证码</a>
</div>
```

在 global.js 中声明一个全局变量

```js
var CONTEXT_PATH = "/community";
```

在 login.html 页脚处增加一个新的 script

```html
<script>
    function refresh_kaptcha(){
        var path = CONTEXT_PATH + "/kaptcha?p=" + Math.random();
        $('#kaptcha').attr("src", path);
    }
</script>
```

> CONTEXT_PATH + "/kaptcha?p=" + Math.random();
>
> 这个里面的p=之后的是为了欺骗浏览器，因为有的浏览器在两个网址都是.../kaptcha 的时候，会认为这是同一个网址，不需要刷新，此处增加一个随意的参数就可以善意的欺骗浏览器，让其认为这是不同的网址，从而完成刷新功能

运行 CommunityApplication，在浏览器中输入 http://localhost:8080/community/login，把鼠标光标放到刷新验证码处，注意左下角的方法名，输出结果:

![image-20220712163541325](http://qiniu.dyl.fit/Interview/image-20220712163541325.png)

### 2.5 开发登陆、退出功能

#### 1、访问登录页面

点击顶部区域内的链接，打开登录页面。

前面已经更改过了，在 index.html 中修改头部的内容为如下代码：

```html
<li class="nav-item ml-3 btn-group-vertical">
    <a class="nav-link" th:href="@{/login}">登录</a>
</li>
```

#### 2、登录

* 验证账号、密码、验证码。
* 成功时，生成登录凭证，发放给客户端。
* 失败时，跳转回登录页。

##### 2.1 创建实体类

在 domain 包内创建 LoginTicket.java，代码如下：

```java
public class LoginTicket {

    private int id;
    private int userId;
    private String ticket;
    private int status;
    private Date expired;

    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    public int getUserId() {
        return userId;
    }

    public void setUserId(int userId) {
        this.userId = userId;
    }

    public String getTicket() {
        return ticket;
    }

    public void setTicket(String ticket) {
        this.ticket = ticket;
    }

    public int getStatus() {
        return status;
    }

    public void setStatus(int status) {
        this.status = status;
    }

    public Date getExpired() {
        return expired;
    }

    public void setExpired(Date expired) {
        this.expired = expired;
    }

    @Override
    public String toString() {
        return "LoginTicket{" +
                "id=" + id +
                ", userId=" + userId +
                ", ticket='" + ticket + '\'' +
                ", status=" + status +
                ", expired=" + expired +
                '}';
    }
}
```

##### 2.2 创建 实体类对应的 mapper

在 mapper 文件夹里新建一个 LoginTicketMapper，代码如下所示：

```java
@Mapper
public interface LoginTicketMapper {

    /**
     * 插入登录凭证
     *
     * @param loginTicket 登录凭证信息
     * @return int
     */
    @Insert({
            "insert into login_ticket(user_id,ticket,status,expired) ",
            "values(#{userId},#{ticket},#{status},#{expired})"
    })
    @Options(useGeneratedKeys = true, keyProperty = "id") 
    int insertLoginTicket(LoginTicket loginTicket);

    /**
     * 按照凭证号来查询登录凭证
     *
     * @param ticket 凭证号
     * @return 登录凭证信息
     */
    @Select({
            "select id,user_id,ticket,status,expired ",
            "from login_ticket where ticket=#{ticket}"
    })
    LoginTicket selectByTicket(String ticket);

    /**
     * 更新凭证状态
     *
     * @param ticket 登录凭证
     * @param status 状态
     * @return int
     */
    @Update({
            "<script>",
            "update login_ticket set status=#{status} where ticket=#{ticket} ",
            "<if test=\"ticket!=null\"> ",
            "and 1=1 ",
            "</if>",
            "</script>"
    })
    int updateStatus(String ticket, int status);
}
```

> ```java
> @Options(useGeneratedKeys = true, keyProperty = "id") 
> //主键自动生成
> ```
>
> ```java
> @Update({
>     "<script>",
>     "update login_ticket set status=#{status} where ticket=#{ticket} ",
>     "<if test=\"ticket!=null\"> ",
>     "and 1=1 ",
>     "</if>",
>     "</script>"
> })
> //这里是为了演示可以在注解里写判定，实际不需要写这个
> ```

为了防止 sql 语句出错，在类名处按住 alt + enter，创建测试类，代码如下：

```java
@SpringBootTest
class LoginTicketMapperTest {

    @Resource
    private LoginTicketMapper loginTicketMapper;

    @Test
    void testInsertLoginTicket() {
        LoginTicket loginTicket = new LoginTicket();
        loginTicket.setUserId(101);
        loginTicket.setTicket("abc");
        loginTicket.setStatus(0);
        loginTicket.setExpired(new Date(System.currentTimeMillis() + 1000 * 60 * 10));

        loginTicketMapper.insertLoginTicket(loginTicket);
    }

    @Test
    void testSelectLoginTicket() {
        LoginTicket loginTicket = loginTicketMapper.selectByTicket("abc");
        System.out.println(loginTicket);
        // LoginTicket{id=1, userId=101, ticket='abc', status=0, expired=Wed Jul 13 08:53:39 CST 2022}
    }

    @Test
    void testUpdateLoginTicket() {
        LoginTicket loginTicket = loginTicketMapper.selectByTicket("abc");

        loginTicketMapper.updateStatus("abc", 1);
        loginTicket = loginTicketMapper.selectByTicket("abc");
        System.out.println(loginTicket);
        // LoginTicket{id=1, userId=101, ticket='abc', status=1, expired=Wed Jul 13 08:53:39 CST 2022}
    }
}
```

##### 2.3 修改 service 层

在 UserService 中注入 LoginTicketMapper

```java
@Resource
private LoginTicketMapper loginTicketMapper;
```

增加一个 login() 方法

```java
public Map<String, Object> login(String username, String password, int expireSeconds) {
    Map<String, Object> map = new HashMap<>();

    // 空值处理
    if (StringUtils.isBlank(username)) {
        map.put("msg", "账号不能为空");
        return map;
    }

    if (StringUtils.isBlank(password)) {
        map.put("msg", "密码不能为空");
        return map;
    }

    // 验证账号
    User user = userMapper.selectByName(username);
    if (user == null) {
        map.put("usernameMsg", "该账户不存在");
        return map;
    }

    // 验证状态
    if (user.getStatus() == 0) {
        map.put("usernameMsg", "该账户未激活");
        return map;
    }

    // 验证密码
    password = CommunityUtil.md5(password + user.getSalt());
    if (!user.getPassword().equals(password)) {
        map.put("passwordMsg", "密码不正确");
        return map;
    }

    // 生成登录凭证
    LoginTicket loginTicket = new LoginTicket();
    loginTicket.setUserId(user.getId());
    loginTicket.setTicket(CommunityUtil.generateUUID());
    loginTicket.setStatus(0);
    loginTicket.setExpired(new Date(System.currentTimeMillis() + expireSeconds * 1000));
    loginTicketMapper.insertLoginTicket(loginTicket);

    map.put("ticket", loginTicket.getTicket());
    return map;
}
```

##### 2.4 修改 controller 层

先在 constant 包里的 CommunityConstant 接口中增加两个常量

```java
/**
 * 默认状态的登录凭证的超时时间
 */
int DEFAULT_EXPIRED_SECONDS = 3600 * 12;

/**
 * 记住状态的登录凭证超时时间
 */
int REMEMBER_EXPIRED_SECONDS = 3600 * 24 * 100;
```

在 LoginController 中注入一个路径变量

```java
@Value("${server.servlet.context-path}")
private String contextPath;
```

再创建 post 请求的 login() 方法，代码如下：

```java
@PostMapping("/login")
public String login(String username, String password, String code, boolean rememberMe,
                    Model model, httpession session, httpervletResponse response) {
    // 检查验证码
    String kaptcha = (String) session.getAttribute("kaptcha");

    if (StringUtils.isBlank(kaptcha) || StringUtils.isBlank(code) || !kaptcha.equalsIgnoreCase(code)) {
        model.addAttribute("codeMsg", "验证码不正确");
        return "/site/login";
    }

    // 检查账号,密码
    int expireSeconds = rememberMe ? REMEMBER_EXPIRED_SECONDS : DEFAULT_EXPIRED_SECONDS;
    Map<String, Object> map = userService.login(username, password, expireSeconds);
    if (map.containsKey("ticket")) {
        Cookie cookie = new Cookie("ticket", map.get("ticket").toString());
        cookie.setPath(contextPath);
        cookie.setMaxAge(expireSeconds);
        response.addCookie(cookie);

        return "redirect:/index";
    } else {
        model.addAttribute("usernameMsg", map.get("usernameMsg"));
        model.addAttribute("passwordMsg", map.get("passwordMsg"));

        return "/site/login";
    }
}
```

>return "redirect:/index";代表重定向到 controller 层的 /index 请求，
>return "/site/login";代表单纯的跳转到静态界面

2.5 修改前端界面

修改 login.html 中内容部分的代码如下所示：

先给表单添加请求方式为 post，指定跳转的页面为 /login

```html
<form class="mt-5" method="post" th:action="@{/login}">
```

再给账户、密码、验证码和记住我增加加一个 name 属性

```html
<input type="text" class="form-control is-invalid" name="username" id="username" placeholder="请输入您的账号!" required>
```

```html
<input type="password" class="form-control is-invalid" name="password" id="password" placeholder="请输入您的密码!" required>
```

```html
<input type="text" class="form-control is-invalid" name="code" id="verifycode" placeholder="请输入验证码!">
```

```html
<input type="checkbox" name="rememberme" id="remember-me" checked="checked">
```

给账户、密码一个默认值

```html
<input type="text" class="form-control is-invalid"
       th:value="${param.username}"
       name="username" id="username" placeholder="请输入您的账号!" required>
```

```html
<input type="password" class="form-control is-invalid"
       th:value="${param.password}"
       name="password" id="password" placeholder="请输入您的密码!" required>
```

> 记住我按钮的状态应该也是动态显示的，因此也需要修改

```html
<input type="checkbox" name="rememberme" id="remember-me" 
       th:checked="${param.rememberme}">
```

将错误信息更改为动态显示的并且将样式修改为在输入数据之后再显示：

```html
<input type="text" th:class="|form-control ${usernameMsg!=null ? 'is-invalid' :''}|"
       th:value="${param.username}"
       name="username" id="username" placeholder="请输入您的账号!" required>
<div class="invalid-feedback" th:text="${usernameMsg}">
    该账号不存在!
</div>
```

密码和验证码也这样修改。

内容部分的完整代码如下所示：

```html
<div class="main">
    <div class="container pl-5 pr-5 pt-3 pb-3 mt-3 mb-3">
        <h3 class="text-center text-info border-bottom pb-3">登&nbsp;&nbsp;录</h3>
        <form class="mt-5" method="post" th:action="@{/login}">
            <div class="form-group row">
                <label for="username" class="col-sm-2 col-form-label text-right">账号:</label>
                <div class="col-sm-10">
                    <input type="text" th:class="|form-control ${usernameMsg!=null ? 'is-invalid' :''}|"
                           th:value="${param.username}"
                           name="username" id="username" placeholder="请输入您的账号!" required>
                    <div class="invalid-feedback" th:text="${usernameMsg}">
                        该账号不存在!
                    </div>
                </div>
            </div>
            <div class="form-group row mt-4">
                <label for="password" class="col-sm-2 col-form-label text-right">密码:</label>
                <div class="col-sm-10">
                    <input type="password" th:class="|form-control ${passwordMsg!=null ? 'is-invalid' :''}|"
                           th:value="${param.password}"
                           name="password" id="password" placeholder="请输入您的密码!" required>
                    <div class="invalid-feedback" th:text="${passwordMsg}">
                        密码长度不能小于8位!
                    </div>
                </div>
            </div>
            <div class="form-group row mt-4">
                <label for="verifycode" class="col-sm-2 col-form-label text-right">验证码:</label>
                <div class="col-sm-6">
                    <input type="text" th:class="|form-control ${codeMsg!=null ? 'is-invalid' :''}|" name="code"
                           id="verifycode" placeholder="请输入验证码!">
                    <div class="invalid-feedback" th:text="${codeMsg}">
                        验证码不正确!
                    </div>
                </div>
                <div class="col-sm-4">
                    <qiniu th:src="@{/kaptcha}" id="kaptcha" style="width:100px;height:40px;" class="mr-2"/>
                    <a href="javascript:refresh_kaptcha();" class="font-size-12 align-bottom">刷新验证码</a>
                </div>
            </div>
            <div class="form-group row mt-4">
                <div class="col-sm-2"></div>
                <div class="col-sm-10">
                    <input type="checkbox" name="rememberme" id="remember-me"
                           th:checked="${param.rememberme}">
                    <label class="form-check-label" for="remember-me">记住我</label>
                    <a href="forget.html" class="text-danger float-right">忘记密码?</a>
                </div>
            </div>
            <div class="form-group row mt-4">
                <div class="col-sm-2"></div>
                <div class="col-sm-10 text-center">
                    <button type="submit" class="btn btn-info text-white form-control">立即登录</button>
                </div>
            </div>
        </form>
    </div>
</div>
```

运行 CommunityApplication ，在浏览器中输入 http://localhost:8080/community/login，输出结果:

![image-20220713094832655](http://qiniu.dyl.fit/Interview/image-20220713094832655.png)

> 此时刚进入登录界面不会再报错了

![动画2](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB2.gif)

登录成功后在数据库中可以看到一个新的数据

![image-20220713095608857](http://qiniu.dyl.fit/Interview/image-20220713095608857.png)

#### 3、退出

* 将登录凭证修改为失效状态。
* 跳转至网站首页。

##### 3.1 修改 service 层

在 UserService 中添加 logout() 方法，代码如下：

```java
public void logout(String ticket) {
    loginTicketMapper.updateStatus(ticket, 1);
}
```

##### 3.2 修改 controller 层

在 LoginController 中增加一个 get 方式的请求

```java
@GetMapping("/logout")
public String logout(@CookieValue("ticket") String ticket) {
    userService.logout(ticket);
    return "redirect:/login";
    //默认是get请求
}
```

> @CookieValue("ticket") String ticket 中可以获取请求中 cookie 的 ticket 信息

![image-20220713100608945](http://qiniu.dyl.fit/Interview/image-20220713100608945.png)

##### 3.3 修改前端代码

修改 index.html 中的退出登录的跳转链接为动态的，代码如下

```html
<a class="dropdown-item text-center" th:href="@{/logout}">退出登录</a>
```

点击退出登录之后可以在数据库中看到登录状态变为1，即无效

![image-20220713100644560](http://qiniu.dyl.fit/Interview/image-20220713100644560.png)

### 2.6 显示登陆信息

#### 1、拦截器示例

##### 1.1 定义拦截器，实现HandlerInterceptor

在controller包内新建一个interceptor包，并新建一个 AlphaInterceptor,代码如下：

```java
@Component
public class AlphaInterceptor implements HandlerInterceptor {
    private static final Logger logger = LoggerFactory.getLogger(AlphaInterceptor.class);

    //在controller之前执行
    @Override
    public boolean preHandle(httpervletRequest request, httpervletResponse response, Object handler) throws Exception {
        logger.debug("preHandle " + handler.toString());
        return true;
    }

    //在controller之后执行
    @Override
    public void postHandle(httpervletRequest request, httpervletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        logger.debug("postHandle " + handler.toString());
    }

    //在TemplateEngine渲染之后执行
    @Override
    public void afterCompletion(httpervletRequest request, httpervletResponse response, Object handler, Exception ex) throws Exception {
        logger.debug("afterCompletion " + handler.toString());
    }
}
```

##### 1.2 配置拦截器，为它指定拦截、排除的路径

在config 包内新建 WebMvcConfig，代码如下所示

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    @Resource
    private AlphaInterceptor alphaInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(alphaInterceptor)
                .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg")
                .addPathPatterns("/register", "/login");
    }
}
```

运行程序后，发现在index界面并不会拦截（因为只配置拦截 register 和 login），点击 login 界面后发现控制台拦截了该方法。

![image-20220713101920937](http://qiniu.dyl.fit/Interview/image-20220713101920937.png)

#### 2、拦截器应用

![image-20220713103110603](http://qiniu.dyl.fit/Interview/image-20220713103110603.png)

##### 2.1 拦截流程

在请求开始时查询登录用户 -> 在本次请求中持有用户数据 -> 在模板视图上显示用户数据 -> 在请求结束时清理用户数据

##### 2.2 具体实现

在 utils 包内创建 CookieUtil 类来实现通过 request 请求来获取 cookie，以便后续拦截器获取 cookie 中的信息，代码如下：

```java
public class CookieUtil {
    public static String getValue(httpervletRequest request, String name) {
        if (request == null || name == null) {
            throw new IllegalArgumentException("参数为空");
        }
        Cookie[] cookies = request.getCookies();
        if (cookies != null) {
            for (Cookie cookie : cookies) {
                if (cookie.getName().equals(name)) {
                    return cookie.getValue();
                }
            }
        }
        return null;
    }
}
```

在 UserService 中添加 findLoginTicket() 方法，代码如下：

```java
public LoginTicket findLoginTicket(String ticket) {
    return loginTicketMapper.selectByTicket(ticket);
}
```

接着在 interceptor 包内新建一个 LoginTicketInterceptor,代码如下：

```java
@Component
public class LoginTicketInterceptor implements HandlerInterceptor {

    @Resource
    private UserService userService;

    @Resource
    private HostHolder hostHolder;

    @Override
    public boolean preHandle(httpervletRequest request, httpervletResponse response, Object handler) throws Exception {
        //从cookie中获取凭证
        String ticket = CookieUtil.getValue(request, "ticket");

        if (ticket != null) {
            //查询凭证
            LoginTicket loginTicket = userService.findLoginTicket(ticket);
            //检查凭证是否有效
            if (loginTicket != null && loginTicket.getStatus() == 0 && loginTicket.getExpired().after(new Date())) {
                //根据凭证查询用户
                User user = userService.findUserById(loginTicket.getUserId());
                //在本次请求中持有用户,要考虑多线程的情况,考虑线程隔离
                hostHolder.setUser(user);
            }
        }
        return true;
    }

    @Override
    public void postHandle(httpervletRequest request, httpervletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        User user = hostHolder.getUser();
        if (user != null && modelAndView != null) {
            modelAndView.addObject("loginUser", user);
        }
    }

    @Override
    public void afterCompletion(httpervletRequest request, httpervletResponse response, Object handler, Exception ex) throws Exception {
        hostHolder.clear();
    }
}
```

在 utils 包内创建 HostHolder 类来实现持有用户信息,用于代替 session 对象，以便拦截器在每次请求中持有用户时考虑多线程的情况以及考虑线程隔离，代码如下：

```java
@Component
public class HostHolder {

    private ThreadLocal<User> users = new ThreadLocal<>();

    public void setUser(User user) {
        users.set(user);
    }

    public User getUser() {
        return users.get();
    }

    public void clear() {
        users.remove();
    }
}
```

修改 WebMvcConfig：注入 LoginTicketInterceptor，添加 loginTicketInterceptor

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    @Resource
    private AlphaInterceptor alphaInterceptor;

    @Resource
    private LoginTicketInterceptor loginTicketInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(alphaInterceptor)
                .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg")
                .addPathPatterns("/register", "/login");

        registry.addInterceptor(loginTicketInterceptor)
                .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg");
    }
}
```

修改前端界面：将首页的消息、注册、登录以及头像设置了拦截的逻辑，将头像的路径和用户名更改为了 th 的形式

```html
<ul class="navbar-nav mr-auto">
    <li class="nav-item ml-3 btn-group-vertical">
        <a class="nav-link" th:href="@{/index}">首页</a>
    </li>
    <li class="nav-item ml-3 btn-group-vertical" th:if="${loginUser!=null}">
        <a class="nav-link position-relative" href="site/letter.html">消息<span
                class="badge badge-danger">12</span></a>
    </li>
    <li class="nav-item ml-3 btn-group-vertical" th:if="${loginUser==null}">
        <a class="nav-link" th:href="@{/register}">注册</a>
    </li>
    <li class="nav-item ml-3 btn-group-vertical" th:if="${loginUser==null}">
        <a class="nav-link" th:href="@{/login}">登录</a>
    </li>
    <li class="nav-item ml-3 btn-group-vertical dropdown" th:if="${loginUser!=null}">
        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <qiniu th:src="${loginUser.headerUrl}" class="rounded-circle"
                 style="width:30px;"/>
        </a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="dropdown-item text-center" href="site/profile.html">个人主页</a>
            <a class="dropdown-item text-center" href="site/setting.html">账号设置</a>
            <a class="dropdown-item text-center" th:href="@{/logout}">退出登录</a>
            <div class="dropdown-divider"></div>
            <span class="dropdown-item text-center text-secondary" th:utext="${loginUser.username}">nowcoder</span>
        </div>
    </li>
</ul>
```

### 2.7 账号设置

> 上传文件的请求必须是 POST 请求,表单是 enctype=“multipart/form-data”，通过 Spring MVC 的 MultipartFile 处理上传文件

#### 1、访问账号设置页面

##### 1.1 创建 controller 层

在 controller 包内新建 UserController，代码如下所示：

```java
@Controller
@RequestMapping("/user")
public class UserController {

    @GetMapping("/setting")
    public String getSettingPage() {
        return "/site/setting";
    }
}
```

##### 1.2 修改前端界面

修改 setting.html：

先引入 thymeleaf 

```html
xmlns:th="http://www.thymeleaf.org"
```

再将页头和页脚出的静态资源路径修改为 th 的格式，然后把头部和尾部复用 index.html 的内容

修改 index.html：

```html
<a class="dropdown-item text-center" th:href="@{/user/setting}">账号设置</a>
```

#### 2、上传和获取头像

##### 2.1 配置上传资源路径

在 application.yaml 中配置上传文件的路径

```yaml
# 自定义属性
community:
  path:
    domain: http://127.0.0.1:8080
    upload: D:/Learn/牛客网论坛项目/upload
```

> 先在本地创建好目录

##### 2.2 修改 service 层

在 UserService 中添加 updateHeader() 方法

```java
public int updateHeader(int userId, String headerUrl) {
    return userMapper.updateHeader(userId, headerUrl);
}
```

##### 2.3 修改 controller 层

在 UserController 中注入上传路径、上传域名、UserService、HostHolder，添加 post 请求的上传头像方法 uploadHeader() 和 get 请求的获取头像 getHeader() 方法，完整代码如下：

```java
@Controller
@RequestMapping("/user")
public class UserController {

    private static final Logger logger = LoggerFactory.getLogger(UserController.class);

    @Value("${community.path.upload}")
    private String uploadPath;

    @Value("${community.path.domain}")
    private String domain;

    @Value("${server.servlet.context-path}")
    private String contextPath;

    @Resource
    private UserService userService;

    @Resource
    private HostHolder hostHolder;

    @GetMapping("/setting")
    public String getSettingPage() {
        return "/site/setting";
    }

    @PostMapping("/upload")
    private String uploadHeader(MultipartFile headerImage, Model model) {
        if (headerImage == null) {
            model.addAttribute("error", "您还没有选择图片！");
            return "/site/setting";
        }

        String fileName = headerImage.getOriginalFilename();
        // 获取文件的类型作为后缀
        String suffix = fileName.substring(fileName.lastIndexOf("."));
        if (StringUtils.isBlank(suffix)) {
            model.addAttribute("error", "文件的格式不正确!");
            return "/site/setting";
        }

        // 生成随机文件名
        fileName = CommunityUtil.generateUUID().replace("-", "") + suffix;
        // 确定文件存放的路径
        File dest = new File(uploadPath + "/" + fileName);
        try {
            // 存储文件
            headerImage.transferTo(dest);
        } catch (IOException e) {
            logger.error("上传文件失败: " + e.getMessage());
            throw new RuntimeException("上传文件失败,服务器发生异常!", e);
        }

        // 更新当前用户的头像的路径(web访问路径)
        // http://localhost:8080/community/user/header/xxx.png
        User user = hostHolder.getUser();
        String headerUrl = domain + contextPath + "/user/header/" + fileName;
        userService.updateHeader(user.getId(), headerUrl);

        return "redirect:/index";
    }

    @GetMapping("/header/{fileName}")
    public void getHeader(@PathVariable("fileName") String fileName, httpervletResponse response) {
        // 服务器存放路径
        fileName = uploadPath + "/" + fileName;
        // 文件后缀
        String suffix = fileName.substring(fileName.lastIndexOf("."));
        // 响应图片
        response.setContentType("image/" + suffix);
        try (
                FileInputStream fis = new FileInputStream(fileName);
                OutputStream os = response.getOutputStream();
        ) {
            byte[] buffer = new byte[1024];
            int b = 0;
            while ((b = fis.read(buffer)) != -1) {
                os.write(buffer, 0, b);
            }
        } catch (IOException e) {
            logger.error("读取头像失败: " + e.getMessage());
        }
    }
}
```

##### 2.4 修改前端界面

修改 setting.html 文件如下：

```html
<!-- 上传头像 -->
<h6 class="text-left text-info border-bottom pb-2">上传头像</h6>
<form class="mt-5" method="post" enctype="multipart/form-data" th:action="@{/user/upload}">
    <div class="form-group row mt-4">
        <label class="col-sm-2 col-form-label text-right">选择头像:</label>
        <div class="col-sm-10">
            <div class="custom-file">
                <input type="file" th:class="|custom-file-input ${error!=null?'is-invalid':''}|"
                       id="head-image" name="headerImage" lang="es" required="">
                <label class="custom-file-label" for="head-image" data-browse="文件">选择一张图片</label>
                <div class="invalid-feedback" th:text="${error}">
                    上传失败
                </div>
            </div>
        </div>
    </div>
    <div class="form-group row mt-4">
        <div class="col-sm-2"></div>
        <div class="col-sm-10 text-center">
            <button type="submit" class="btn btn-info text-white form-control">立即上传</button>
        </div>
    </div>
</form>
```

##### 2.5 运行结果

![动画3](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB3.gif)

![image-20220713145243439](http://qiniu.dyl.fit/Interview/image-20220713145243439.png)

#### 3、修改密码

##### 3.1 修改 service 层

在 UserService 中添加 updatePassword() 方法，代码如下：

```java
public Map<String, Object> updatePassword(String password, String newPassword, int id) {
    Map<String, Object> map = new HashMap<>();
    User user = userMapper.selectById(id);
    password = CommunityUtil.md5(password + user.getSalt());
    if (!user.getPassword().equals(password)) {
        map.put("passwordMsg", "输入密码错误！");
        return map;
    } else {
        //注意：存入新密码要以加密后的形式存进去
        newPassword = CommunityUtil.md5(newPassword + user.getSalt());
        userMapper.updatePassword(id, newPassword);
    }

    return map;
}
```

##### 3.2 修改 controller 层

在 UserController 中添加 post 请求的更改密码方法 updatePassword()，代码如下：

```java
@PostMapping("/change")
public String updatePassword(Model model, String password, String newPassword, String confirmPassword) {
    if (StringUtils.isBlank(password)) {
        model.addAttribute("passwordMsg", "请输入原来密码！");
        return "/site/setting";
    }
    if (StringUtils.isBlank(newPassword)) {
        model.addAttribute("newPasswordMsg", "请输入新密码！");
        return "/site/setting";
    }
    if (StringUtils.isBlank(confirmPassword)) {
        model.addAttribute("confirmPasswordMsg", "请再次输入新密码！");
        return "/site/setting";
    }
    if (!confirmPassword.equals(newPassword)) {
        model.addAttribute("newPasswordMsg", "两次输入的新密码不相同！");
        return "/site/setting";
    }
    User user = hostHolder.getUser();
    Map<String, Object> map = userService.updatePassword(password, newPassword, user.getId());
    if (map == null || map.isEmpty()) {
        //传给templates注册成功信息
        model.addAttribute("msg", "密码修改成功");
        //跳到回个人设置页面
        model.addAttribute("target", "/logout");
        return "/site/operate-result";
    } else {
        //失败了传失败信息，跳到到原来的页面
        model.addAttribute("passwordMsg", "输入的原始密码错误！");
        return "/site/setting";
    }
}
```

##### 3.3 修改前端界面

修改 setting.html 文件如下：

```html
<!-- 修改密码 -->
<h6 class="text-left text-info border-bottom pb-2 mt-5">修改密码</h6>
<form class="mt-5" method="post" th:action="@{/user/change}">
    <div class="form-group row mt-4">
        <label for="old-password" class="col-sm-2 col-form-label text-right">原密码:</label>
        <div class="col-sm-10">
            <input type="password"
                   th:class="|form-control ${passwordMsg != null?'is-invalid':'' }|"
                   id="old-password"
                   th:value="${param.password}"
                   name="password" placeholder="请输入原始密码!" required>
            <div class="invalid-feedback" th:text="${passwordMsg}">
                密码长度不能小于8位!
            </div>
        </div>
    </div>
    <div class="form-group row mt-4">
        <label for="new-password" class="col-sm-2 col-form-label text-right">新密码:</label>
        <div class="col-sm-10">
            <input type="password"
                   class="form-control"
                   id="new-password"
                   th:value="${param.newPassword}"
                   name="newPassword" placeholder="请输入新的密码!" required>
            <div class="invalid-feedback" th:text="${newPasswordMsg}">
                密码长度不能小于8位!
            </div>
        </div>
    </div>
    <div class="form-group row mt-4">
        <label for="confirm-password" class="col-sm-2 col-form-label text-right">确认密码:</label>
        <div class="col-sm-10">
            <input type="password"
                   th:class="|form-control ${newPasswordMsg != null?'is-invalid':'' }|"
                   id="confirm-password"
                   th:value="${param.confirmPassword}"
                   name=confirmPassword placeholder="再次输入新密码!" required>
            <div class="invalid-feedback">
                两次输入的密码不一致!
            </div>
        </div>
    </div>
    <div class="form-group row mt-4">
        <div class="col-sm-2"></div>
        <div class="col-sm-10 text-center">
            <button type="submit" class="btn btn-info text-white form-control">立即保存</button>
        </div>
    </div>
</form>
```

##### 3.4 运行结果

![动画4](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB4.gif)

##### 3.5 存在 bug (todo)

如果先输入一个错误的原密码，新密码和确认密码都输入进去，这个时候会提示原密码错误，但是接着把原密码改成正确的，然后如果把那个新密码输入的删掉的话，就会提示要输入新密码，但是之前的那个原密码错误的信息还会在界面上显示

如果密码都是相同的，也能更改，应该是提示自己原密码和新密码相同

![Snipaste_2022-07-13_15-25-46](http://qiniu.dyl.fit/Interview/Snipaste_2022-07-13_15-25-46.png)

### 2.8 检查登录状态

#### 1、使用自定义注解的拦截器

常用的元注解：@Target、@Retention、@Document、@Inherited

如何读取注解：
```java
Method.getDeclaredAnnotations ()	Method.getAnnotation (Class<T> annotationClass)
```
在方法前标注自定义注解后拦截所有请求，只处理带有该注解的方法

##### 1.1 创建 annotation 

创建 annotation 包，并在包内创建一个 LoginRequired 注解，代码如下：

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface LoginRequired {
}
```

> @Target(ElementType.METHOD) -> 代表拦截的类型是方法
>
> @Retention(RetentionPolicy.RUNTIME) -> 代表运行时拦截

##### 1.2 标注拦截方法

在 UserController 中的 getSettingPage() 和 uploadHeader() 方法前添加注解 @LoginRequired，代码如下：

```java
@LoginRequired
@GetMapping("/setting")
public String getSettingPage() {
    return "/site/setting";
}
@LoginRequired
@PostMapping("/upload")
public String uploadHeader(MultipartFile headerImage, Model model) {
    ...
}
```

##### 1.3 配置拦截规则

在 interceptor 包内新建 LoginRequiredInterceptor，代码如下：

```java
@Component
public class LoginRequiredInterceptor implements HandlerInterceptor {

    @Resource
    private HostHolder hostHolder;

    @Override
    public boolean preHandle(httpervletRequest request, httpervletResponse response, Object handler) throws Exception {
        // 判断所要拦截的类型是不是方法类型
        if (handler instanceof HandlerMethod) {
            HandlerMethod handlerMethod = (HandlerMethod) handler;
            Method method = handlerMethod.getMethod();
            LoginRequired loginRequired = method.getAnnotation(LoginRequired.class);
            // 如果没有登录但是发起了请求，重定向到登录界面
            if (loginRequired != null && hostHolder.getUser() == null) {
                response.sendRedirect(request.getContextPath() + "/login");
                return false;
            }
        }
        return true;
    }
}
```

##### 1.4 添加拦截器

在 WebMvcConfig 中注入 LoginRequiredInterceptor，并添加排除静态资源的路径，代码如下：

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    @Resource
    private AlphaInterceptor alphaInterceptor;

    @Resource
    private LoginTicketInterceptor loginTicketInterceptor;

    @Resource
    private LoginRequiredInterceptor loginRequiredInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(alphaInterceptor)
                .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg")
                .addPathPatterns("/register", "/login");

        registry.addInterceptor(loginTicketInterceptor)
                .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg");

        registry.addInterceptor(loginRequiredInterceptor)
                .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg");
    }
}
```

##### 1.5 运行结果

直接在浏览器栏中输入http://localhost:8080/community/user/setting，强制跳转到登录界面

![动画5](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB5.gif)

## 第3章 Spring Boot进阶，开发社区核心功能

### 3.1 过滤敏感词

#### 1、前缀树简介

名称：Trie、字典树、查找树

特点：查找效率高，消耗内存大

应用：字符串检索、词频统计、字符串排序等

> Java实现过滤敏感词的文章：http://cloud.tencent.com/developer/article/1936955
>
> 过滤敏感词的类库：http://github.com/toolgood/ToolGood.Words

#### 2、敏感词过滤器

##### 2.1 步骤概述

定义前缀树 -> 根据敏感词，初始化前缀树 -> 编写过滤敏感词的方法

##### 2.2 实现

先导入敏感词的资源到 resource 中

> 敏感词资源链接：http://pan.baidu.com/s/1yvuSrAmJH299rDMnQkOc4A 提取码：cq9m

在 utils 包下创建 SensitiveFilter，代码如下：

```java
@Component
public class SensitiveFilter {

    private static final Logger logger = LoggerFactory.getLogger(SensitiveFilter.class);

    /**
     * 替换符
     */
    private static final String REPLACEMENT = "***";

    /**
     * 根节点
     */
    private TrieNode rootNode = new TrieNode();

    @PostConstruct
    public void init() {
        try (
                InputStream is = this.getClass().getClassLoader().getResourceAsStream("sensitive-words.txt");
                BufferedReader reader = new BufferedReader(new InputStreamReader(is));
        ) {
            String keyword;
            while ((keyword = reader.readLine()) != null) {
                // 添加到前缀树
                this.addKeyword(keyword);
            }
        } catch (IOException e) {
            logger.error("加载敏感词文件失败: " + e.getMessage());
        }
    }

    // 将一个敏感词添加到前缀树中
    private void addKeyword(String keyword) {
        TrieNode tempNode = rootNode;
        for (int i = 0; i < keyword.length(); i++) {
            char c = keyword.charAt(i);
            TrieNode subNode = tempNode.getSubNode(c);

            if (subNode == null) {
                // 初始化子节点
                subNode = new TrieNode();
                tempNode.addSubNode(c, subNode);
            }

            // 指向子节点,进入下一轮循环
            tempNode = subNode;

            // 设置结束标识
            if (i == keyword.length() - 1) {
                tempNode.setKeywordEnd(true);
            }
        }
    }

    /**
     * 过滤敏感词
     *
     * @param text 待过滤的文本
     * @return 过滤后的文本
     */
    public String filter(String text) {
        if (StringUtils.isBlank(text)) {
            return null;
        }

        // 指针1
        TrieNode tempNode = rootNode;
        // 指针2
        int begin = 0;
        // 指针3
        int position = 0;
        // 结果
        StringBuilder sb = new StringBuilder();

        while (position < text.length()) {
            char c = text.charAt(position);

            // 跳过符号
            if (isSymbol(c)) {
                // 若指针1处于根节点,将此符号计入结果,让指针2向下走一步
                if (tempNode == rootNode) {
                    sb.append(c);
                    begin++;
                }
                // 无论符号在开头或中间,指针3都向下走一步
                position++;
                continue;
            }

            // 检查下级节点
            tempNode = tempNode.getSubNode(c);
            if (tempNode == null) {
                // 以begin开头的字符串不是敏感词
                sb.append(text.charAt(begin));
                // 进入下一个位置
                position = ++begin;
                // 重新指向根节点
                tempNode = rootNode;
            } else if (tempNode.isKeywordEnd()) {
                // 发现敏感词,将begin~position字符串替换掉
                sb.append(REPLACEMENT);
                // 进入下一个位置
                begin = ++position;
                // 重新指向根节点
                tempNode = rootNode;
            } else {
                // 检查下一个字符
                position++;
            }
        }

        // 将最后一批字符计入结果
        sb.append(text.substring(begin));

        return sb.toString();
    }

    // 判断是否为符号
    private boolean isSymbol(Character c) {
        // 0x2E80~0x9FFF 是东亚文字范围
        return !CharUtils.isAsciiAlphanumeric(c) && (c < 0x2E80 || c > 0x9FFF);
    }

    // 前缀树
    private class TrieNode {

        // 关键词结束标识
        private boolean isKeywordEnd = false;

        // 子节点(key是下级字符,value是下级节点)
        private Map<Character, TrieNode> subNodes = new HashMap<>();

        public boolean isKeywordEnd() {
            return isKeywordEnd;
        }

        public void setKeywordEnd(boolean keywordEnd) {
            isKeywordEnd = keywordEnd;
        }

        // 添加子节点
        public void addSubNode(Character c, TrieNode node) {
            subNodes.put(c, node);
        }

        // 获取子节点
        public TrieNode getSubNode(Character c) {
            return subNodes.get(c);
        }

    }
}
```

创建测试类

```java
@SpringBootTest
class SensitiveFilterTest {

    @Resource
    private SensitiveFilter sensitiveFilter;

    @Test
    void testSensitiveFilter() {
        String text = "这里可以赌博,可以嫖娼,可以吸毒,可以开票,哈哈哈!";
        text = sensitiveFilter.filter(text);
        System.out.println(text);

        text = "这里可以☆赌☆博☆,可以☆嫖☆娼☆,可以☆吸☆毒☆,可以☆开☆票☆,哈哈哈!";
        text = sensitiveFilter.filter(text);
        System.out.println(text);
    }

}
```

运行结果：

```shell
这里可以***,可以******,可以***,可以***,哈哈哈!
这里可以☆***☆,可以☆***☆***☆,可以☆***☆,可以☆***☆,哈哈哈!
```

### 3.2 发布帖子

#### 1、AJAX 介绍

* Asynchronous JavaScript and XML
* 异步的JavaScript与XML，不是一门新技术，只是一个新的术语。
* 使用AJAX，网页能够将增量更新呈现在页面上，而不需要刷新整个页面。
* 虽然X代表XML，但目前JSON的使用比XML更加普遍。
* http://developer.mozilla.org/zh-CN/docs/Web/Guide/AJAX

#### 2、示例

使用jQuery发送AJAX请求。

##### 2.1 引入依赖

先引入处理 json 的依赖

```xml
<!-- http://mvnrepository.com/artifact/com.alibaba/fastjson -->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>fastjson</artifactId>
    <version>1.2.58</version>
</dependency>
```

##### 2.2 修改工具类

在 CommunityUtil 添加方法

```java
public static String getJSONString(int code, String msg, Map<String, Object> map) {
    JSONObject json = new JSONObject();
    json.put("code", code);
    json.put("msg", msg);
    if (map != null) {
        for (String key : map.keySet()) {
            json.put(key, map.get(key));
        }
    }
    return json.toJSONString();
}

public static String getJSONString(int code, String msg) {
    return getJSONString(code, msg, null);
}

public static String getJSONString(int code) {
    return getJSONString(code, null, null);
}
```

##### 2.3 测试方法

在本类中写个测试方法

```java
public static void main(String[] args) {
    Map<String, Object> map = new HashMap<>();
    map.put("name", "zhangsan");
    map.put("age", 25);
    System.out.println(getJSONString(0, "ok", map));
}
```

##### 2.4 运行结果

上述测试类运行结果

```she
{"msg":"ok","code":0,"name":"zhangsan","age":25}
```

在 AlphaController 增加一个示例，代码如下

```java
//ajax示例
@PostMapping("/ajax")
@ResponseBody
public String testAjax(String name, int age) {
    System.out.println(name);
    System.out.println(age);
    return CommunityUtil.getJSONString(0, "操作成功！");
}
```

在 static 的 html 文件夹中添加一个 ajax-demo.html，代码如下：

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ajax</title>
</head>
<body>

<p>
    <input type="button" value="发送" onclick="send();">
</p>
<script src="http://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
<script>
    function send() {
        $.post(
            "/community/alpha/ajax",
            {"name": "张三", "age": 23},
            function (data) {
                console.log(typeof (data));
                console.log(data);

                data = $.parseJSON(data);
                console.log(typeof (data));
                console.log(data.code);
                console.log(data.msg);
            }
        )
    }
</script>
</body>
</html>
```

运行 CommunityApplication，在浏览器中输入 http://localhost:8080/community/html/ajax-demo.html，输出结果:

![image-20220714101457770](http://qiniu.dyl.fit/Interview/image-20220714101457770.png)

#### 3、实践

采用AJAX请求，实现发布帖子的功能。

##### 3.1 修改 mapper 层

在 DiscussPostMapper 中添加方法

```java
int insertDiscussPost(DiscussPost discussPost);
```

在 DiscussPostMapper.xml 中增加对应的 sql 语句

```xml
<insert id="insertDiscussPost" parameterType="DiscussPost" keyProperty="id">
    insert into discuss_post(<include refid="insertFields"/>)
    values(#{userId},#{title},#{content},#{type},#{status},#{createTime},#{commentCount},#{score})
</insert>
```

> 这里最好测试一下

##### 3.2 修改 service 层

在 DiscussPostService 中先注入 SensitiveFilter

```java
@Resource
private SensitiveFilter sensitiveFilter;
```

然后添加 addDiscussPost() 方法

```java
public int addDiscussPost(DiscussPost post) {
    if (post == null) {
        throw new IllegalArgumentException("参数不能为空！");
    }

    // 转义HTML标记
    post.setTitle(HtmlUtils.htmlEscape(post.getTitle()));
    post.setContent(HtmlUtils.htmlEscape(post.getContent()));
    // 过滤敏感词
    post.setTitle(sensitiveFilter.filter(post.getTitle()));
    post.setContent(sensitiveFilter.filter(post.getContent()));

    return discussPostMapper.insertDiscussPost(post);
}
```

##### 3.3 修改 controller 层

新建 DiscussPostController，代码如下:

```java
@Controller
@RequestMapping("/discuss")
public class DiscussPostController {

    @Resource
    private DiscussPostService discussPostService;

    @Resource
    private HostHolder hostHolder;

    @PostMapping("/add")
    @ResponseBody
    public String addDiscussPost(String title, String content) {

        User user = hostHolder.getUser();
        if (user == null) {
            return CommunityUtil.getJSONString(403, "你还没有登录！");
        }

        DiscussPost post = new DiscussPost();
        post.setUserId(user.getId());
        post.setTitle(title);
        post.setContent(content);
        post.setCreateTime(new Date());
        discussPostService.addDiscussPost(post);

        //报错情况,将来统一处理
        return CommunityUtil.getJSONString(0, "发布成功！");
    }
}
```

##### 3.4 修改前端界面

修改index.html:

增加对用户是否登录的判断来决定是否显示我要发布这个按钮

```html
<button type="button" class="btn btn-primary btn-sm position-absolute rt-0" data-toggle="modal"
        data-target="#publishModal" th:if="${loginUser!=null}">我要发布
</button>
```

修改 index.js:

```js
$(function () {
    $("#publishBtn").click(publish);
});

function publish() {
    $("#publishModal").modal("hide");
    
    // 获取标题和内容
    var title = $("#recipient-name").val();
    var content = $("#message-text").val();
    // 发送异步请求(POST)
    $.post(
        CONTEXT_PATH + "/discuss/add",
        {"title": title, "content": content},
        function (data) {
            data = $.parseJSON(data);
            // 在提示框中显示返回信息
            $("#hintBody").text(data.msg);
            // 显示提示框
            $("#hintModal").modal("show");
            // 2秒后自动隐藏提示框
            setTimeout(function () {
                $("#hintModal").modal("hide");
                // 刷新页面
                if (data.code == 0) {
                    window.location.reload();
                }
            }, 2000);
        }
    )
}
```

##### 3.5 运行结果

![动画6](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB6.gif)

### 3.3 帖子详情

* DiscussPostMapper
* DiscussPostService
* DiscussPostController
* index.html
  * 在帖子标题上增加访问详情页面的链接
* discuss-detail.html
  * 处理静态资源的访问路径
  * 复用index.html的header区域
  * 显示标题、作者、发布时间、帖子正文等内容

#### 1、修改 mapper 层

在 DiscussPostMapper 中添加 selectDiscussPostById() 方法

```java
DiscussPost selectDiscussPostById(int id);
```

在 DiscussPostMapper.xml 中配置对应的 sql 语句

```xml
<select id="selectDiscussPostById" resultType="DiscussPost">
    select
    <include refid="selectFields"/>
    from discuss_post
    where id = #{id}
</select>
```

#### 2、修改 service 层

在 DiscussPostService 中添加 findDiscussPostById() 方法

```java
public DiscussPost findDiscussPostById(int id) {
    return discussPostMapper.selectDiscussPostById(id);
}
```

#### 3、修改 controller 层

在 DiscussPostController 中添加 get 请求的 getDiscussPost() 方法

```java
@GetMapping("/detail/{discussPostId}")
public String getDiscussPost(@PathVariable("discussPostId") int discussPostId, Model model) {
    // 帖子
    DiscussPost post = discussPostService.findDiscussPostById(discussPostId);
    model.addAttribute("post", post);

    // 作者
    User user = userService.findUserById(post.getUserId());
    model.addAttribute("user", user);

    return "/site/discuss-detail";
}
```

#### 4、修改前端界面

##### 4.1 修改 index.html

修改每个帖子的跳转链接

```html
<a th:href="@{|/discuss/detail/${map.post.id}|}" th:utext="${map.post.title}">备战春招，面试刷题跟他复习，一个月全搞定！</a>
```

> th:href="@{|/discuss/detail/${map.post.id}|}" 既有变量又有常量时候需要用双竖线||括住

##### 4.2 修改 discuss-detail.html

注入 thymeleaf 语法，更改路径，复用 index.html 的页头页脚

修改标题部分的内容为 th 语法

```html
<span th:utext="${post.title}">备战春招，面试刷题跟他复习，一个月全搞定！</span>
```

修改作者部分的内容为 th 语法

```html
<div class="media pb-3 border-bottom">
    <a href="profile.html">
        <qiniu th:src="${user.headerUrl}"
             class="align-self-start mr-4 rounded-circle user-header" alt="用户头像">
    </a>
    <div class="media-body">
        <div class="mt-0 text-warning" th:utext="${user.username}">寒江雪</div>
        <div class="text-muted mt-3">
            发布于 <b th:text="${#dates.format(post.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 15:32:18</b>
            <ul class="d-inline float-right">
                <li class="d-inline ml-2"><a href="#" class="text-primary">赞 11</a></li>
                <li class="d-inline ml-2">|</li>
                <li class="d-inline ml-2"><a href="#replyform" class="text-primary">回帖 7</a></li>
            </ul>
        </div>
    </div>
</div>
```

修改正文部分的内容为 th 语法

```html
<div class="mt-4 mb-3 content" th:utext="${post.content}">
    金三银四的金三已经到了，你还沉浸在过年的喜悦中吗？
</div>
```

#### 5、运行结果

![动画7](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB7.gif)

### 3.4 事务管理

#### 1、事务概念

##### 1.1 什么是事务

事务是由N步数据库操作序列组成的逻辑执行单元，这系列操作要么全执行，要么全放弃执行。

##### 1.2 事务的特性（ACID）

* 原子性（Atomicity）：事务是应用中不可再分的最小执行体。
* 一致性（Consistency）：事务执行的结果，须使数据从一个一致性状态，变为另一个一致性状态。
* 隔离性（Isolation）：各个事务的执行互不干扰，任何事务的内部操作对其他的事务都是隔离的。
* 持久性（Durability）：事务一旦提交，对数据所做的任何改变都要记录到永久存储器中。

#### 2、事务的隔离性

##### 2.1 常见的并发异常

* 第一类丢失更新、第二类丢失更新。
* 脏读、不可重复读、幻读。

##### 2.2 常见的隔离级别

* Read Uncommitted：读取未提交的数据。
* Read Committed：读取已提交的数据。
* Repeatable Read：可重复读。
* Serializable：串行化。

**第一类丢失更新**：某一个事务的回滚，导致另外一个事务已更新的数据丢失了。

![image-20220714135154449](http://qiniu.dyl.fit/Interview/image-20220714135154449.png)

**第二类丢失更新**：某一个事务的提交，导致另外一个事务已更新的数据丢失了。

![image-20220714135242818](http://qiniu.dyl.fit/Interview/image-20220714135242818.png)

**脏读**：某一个事务，读取了另外一个事务未提交的数据。

![image-20220714135304521](http://qiniu.dyl.fit/Interview/image-20220714135304521.png)

**不可重复读**：某一个事务，对同一个数据前后读取的结果不一致。(一条数据)

![image-20220714135319964](http://qiniu.dyl.fit/Interview/image-20220714135319964.png)

**幻读**：某一个事务，对同一个表前后查询到的行数不一致。（多条数据）

![image-20220714135336706](http://qiniu.dyl.fit/Interview/image-20220714135336706.png)

**事务隔离级别**：

<qiniu src="http://qiniu.dyl.fit/Interview/20191121211321.png" alt="avater" style="zoom:60%;" />

#### 3、实现机制

##### 3.1 悲观锁（数据库）

* 共享锁（S锁）
  事务A对某数据加了共享锁后，其他事务只能对该数据加共享锁，但不能加排他锁。
* 排他锁（X锁）
  事务A对某数据加了排他锁后，其他事务对该数据既不能加共享锁，也不能加排他锁。

##### 3.2 乐观锁（自定义）

* 版本号、时间戳等
  在更新数据前，检查版本号是否发生变化。若变化则取消本次更新，否则就更新数据（版本号 + 1）。

#### 4、Spring事务管理

##### 4.1 声明式事务（常用）

通过 XML 配置或者注解，声明某方法的事务特征。

##### 4.2 编程式事务

通过 TransactionTemplate 管理事务，并通过它执行数据库的操作。

#### 5、示例演示

在 AlphaService 中注入 UserMapper、DiscussPostMapper、TransactionTemplate

```java
@Resource
private UserMapper userMapper;

@Resource
private DiscussPostMapper discussPostMapper;

@Resource
private TransactionTemplate transactionTemplate;
```

添加方法

```java
//事务的传播机制：
// REQUIRED: 支持当前事务(外部事务),如果不存在则创建新事务.
// REQUIRES_NEW: 创建一个新事务,并且暂停当前事务(外部事务).
// NESTED: 如果当前存在事务(外部事务),则嵌套在该事务中执行(独立的提交和回滚),否则就会REQUIRED一样.
@Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)
public Object save1() {
    // 新增用户
    User user = new User();
    user.setUsername("alpha");
    user.setSalt(CommunityUtil.generateUUID().substring(0, 5));
    user.setPassword(CommunityUtil.md5("123" + user.getSalt()));
    user.setEmail("alpha@qq.com");
    user.setHeaderUrl("http://image.nowcoder.com/head/99t.png");
    user.setCreateTime(new Date());
    userMapper.insertUser(user);

    // 新增帖子
    DiscussPost post = new DiscussPost();
    post.setUserId(user.getId());
    post.setTitle("Hello");
    post.setContent("新人报道!");
    post.setCreateTime(new Date());
    discussPostMapper.insertDiscussPost(post);

    Integer.valueOf("abc");

    return "ok";
}

public Object save2() {
    transactionTemplate.setIsolationLevel(TransactionDefinition.ISOLATION_READ_COMMITTED);
    transactionTemplate.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);

    return transactionTemplate.execute(new TransactionCallback<Object>() {
        @Override
        public Object doInTransaction(TransactionStatus status) {
            // 新增用户
            User user = new User();
            user.setUsername("beta");
            user.setSalt(CommunityUtil.generateUUID().substring(0, 5));
            user.setPassword(CommunityUtil.md5("123" + user.getSalt()));
            user.setEmail("beta@qq.com");
            user.setHeaderUrl("http://image.nowcoder.com/head/999t.png");
            user.setCreateTime(new Date());
            userMapper.insertUser(user);

            // 新增帖子
            DiscussPost post = new DiscussPost();
            post.setUserId(user.getId());
            post.setTitle("你好");
            post.setContent("我是新人!");
            post.setCreateTime(new Date());
            discussPostMapper.insertDiscussPost(post);

            Integer.valueOf("abc");

            return "ok";
        }
    });
}
```

创建测试类

```java
@SpringBootTest
class TransactionTest {

    @Resource
    private AlphaService alphaService;

    @Test
    void testSave1() {
        Object obj = alphaService.save1();
        System.out.println(obj);
    }

    @Test
    void testSave2() {
        Object obj = alphaService.save2();
        System.out.println(obj);
    }
}
```

运行结果

![动画8](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB8.gif)

两次插入操作均失败回滚，数据库中没有

### 3.5 显示评论

* 数据层
  * 根据实体查询一页评论数据。
  * 根据实体查询评论的数量。
* 业务层
  * 处理查询评论的业务。
  * 处理查询评论数量的业务。
* 表现层
  * 显示帖子详情数据时，同时显示该帖子所有的评论数据。

#### 1、修改数据层

在 domain 包中创建实体类 Comment

```java
public class Comment {

    private int id;
    private int userId;
    private int entityType;
    private int entityId;
    private int targetId;
    private String content;
    private int status;
    private Date createTime;

    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    public int getUserId() {
        return userId;
    }

    public void setUserId(int userId) {
        this.userId = userId;
    }

    public int getEntityType() {
        return entityType;
    }

    public void setEntityType(int entityType) {
        this.entityType = entityType;
    }

    public int getEntityId() {
        return entityId;
    }

    public void setEntityId(int entityId) {
        this.entityId = entityId;
    }

    public int getTargetId() {
        return targetId;
    }

    public void setTargetId(int targetId) {
        this.targetId = targetId;
    }

    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public int getStatus() {
        return status;
    }

    public void setStatus(int status) {
        this.status = status;
    }

    public Date getCreateTime() {
        return createTime;
    }

    public void setCreateTime(Date createTime) {
        this.createTime = createTime;
    }

    @Override
    public String toString() {
        return "Comment{" +
                "id=" + id +
                ", userId=" + userId +
                ", entityType=" + entityType +
                ", entityId=" + entityId +
                ", targetId=" + targetId +
                ", content='" + content + '\'' +
                ", status=" + status +
                ", createTime=" + createTime +
                '}';
    }
}
```

在 mapper 包中创建 CommentMapper

```java
@Mapper
public interface CommentMapper {

    List<Comment> selectCommentsByEntity(int entityType, int entityId, int offset, int limit);

    int selectCountByEntity(int entityType, int entityId);
}
```

配置相应的 CommentMapper.xml 中的 sql 语句

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dyl.community.mapper.CommentMapper">

    <sql id="selectFields">
        id, user_id, entity_type, entity_id, target_id, content, status, create_time
    </sql>

    <sql id="insertFields">
        user_id, entity_type, entity_id, target_id, content, status, create_time
    </sql>
    <update id="updateStatus">
        update comment set status = #{status} where entity_id = #{entityId} and entity_type=1
    </update>

    <select id="selectCommentsByEntity" resultType="Comment">
        select
        <include refid="selectFields"/>
        from comment
        where status = 0
        and entity_type = #{entityType}
        and entity_id = #{entityId}
        order by create_time asc
        limit #{offset}, #{limit}
    </select>

    <select id="selectCountByEntity" resultType="int">
        select count(id)
        from comment
        where status = 0
        and entity_type = #{entityType}
        and entity_id = #{entityId}
    </select>
</mapper>
```

#### 2、修改业务层

在 DiscussPostController 注入 CommentService

```java
@Resource
private CommentService commentService;
```

在CommunityConstant新增实体类型的常量

```java
/**
 * 实体类型: 帖子
 */
int ENTITY_TYPE_POST = 1;

/**
 * 实体类型: 评论
 */
int ENTITY_TYPE_COMMENT = 2;
```

在 DiscussPostController 实现 CommunityConstant 接口

修改 getDiscussPost() 方法，完整代码：

```java
@GetMapping("/detail/{discussPostId}")
public String getDiscussPost(@PathVariable("discussPostId") int discussPostId, Model model, Page page) {
    // 帖子
    DiscussPost post = discussPostService.findDiscussPostById(discussPostId);
    model.addAttribute("post", post);

    // 作者
    User user = userService.findUserById(post.getUserId());
    model.addAttribute("user", user);

    // 评论的分页信息
    page.setLimit(5);
    page.setPath("/discuss/detail/" + discussPostId);
    page.setRows(post.getCommentCount());

    // 评论：给帖子的评论
    // 回复：给评论的评论
    // 评论列表
    List<Comment> commentList = commentService.findCommentsByEntity(
            ENTITY_TYPE_POST, post.getId(), page.getOffset(), page.getLimit());
    // 评论VO列表
    List<Map<String, Object>> commentVoList = new ArrayList<>();
    if (commentList != null) {
        for (Comment comment : commentList) {
            // 评论VO
            Map<String, Object> commentVo = new HashMap<>();
            // 评论
            commentVo.put("comment", comment);
            // 作者
            commentVo.put("user", userService.findUserById(comment.getUserId()));

            // 回复列表 不再分页了
            // todo
            List<Comment> replyList = commentService.findCommentsByEntity(
                    ENTITY_TYPE_COMMENT, comment.getId(), 0, Integer.MAX_VALUE);
            // 回复VO列表
            List<Map<String, Object>> replyVoList = new ArrayList<>();
            if (replyList != null) {
                for (Comment reply : replyList) {
                    // 回复VO
                    Map<String, Object> replyVo = new HashMap<>();
                    // 回复
                    replyVo.put("reply", reply);
                    // 作者
                    replyVo.put("user", userService.findUserById(reply.getUserId()));
                    // 回复的目标
                    User target = reply.getTargetId() == 0 ? null : userService.findUserById(reply.getTargetId());
                    replyVo.put("target", target);

                    replyVoList.add(replyVo);
                }
            }
            commentVo.put("replys", replyVoList);

            // 回复数量
            int replyCount = commentService.findCommentCount(ENTITY_TYPE_COMMENT, comment.getId());
            commentVo.put("replyCount", replyCount);

            commentVoList.add(commentVo);
        }
    }
    model.addAttribute("comments", commentVoList);

    return "/site/discuss-detail";
}
```

#### 3、修改表现层(前端界面)

##### 3.1 修改 index.html

```html
<li class="d-inline ml-2" >回帖 <span th:text="${map.post.commentCount}">7</span></li>
```

```html
<!-- 分页 -->
<nav class="mt-5" th:if="${page.rows > 0}" th:fragment="pagination">
```

##### 3.2 修改 discuss-detail.html

```html
<!-- 内容 -->
<div class="main">
    <!-- 帖子详情 -->
    <div class="container">
        <!-- 标题 -->
        <h6 class="mb-4">
            <qiniu src="http://static.nowcoder.com/images/qiniu/icons/ico-discuss.png"/>
            <span th:utext="${post.title}">备战春招，面试刷题跟他复习，一个月全搞定！</span>
            <div class="float-right">
                <button type="button" class="btn btn-danger btn-sm">置顶</button>
                <button type="button" class="btn btn-danger btn-sm">加精</button>
                <button type="button" class="btn btn-danger btn-sm">删除</button>
            </div>
        </h6>
        <!-- 作者 -->
        <div class="media pb-3 border-bottom">
            <a href="profile.html">
                <qiniu th:src="${user.headerUrl}"
                     class="align-self-start mr-4 rounded-circle user-header" alt="用户头像">
            </a>
            <div class="media-body">
                <div class="mt-0 text-warning" th:utext="${user.username}">寒江雪</div>
                <div class="text-muted mt-3">
                    发布于 <b th:text="${#dates.format(post.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 15:32:18</b>
                    <ul class="d-inline float-right">
                        <li class="d-inline ml-2"><a href="#" class="text-primary">赞 11</a></li>
                        <li class="d-inline ml-2">|</li>
                        <li class="d-inline ml-2"><a href="#replyform" class="text-primary">回帖 <i th:text="${post.commentCount}">7</i></a></li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- 正文 -->
        <div class="mt-4 mb-3 content" th:utext="${post.content}">
            金三银四的金三已经到了，你还沉浸在过年的喜悦中吗？
        </div>
    </div>
    <!-- 回帖 -->
    <div class="container mt-3">
        <!-- 回帖数量 -->
        <div class="row">
            <div class="col-8">
                <h6><b class="square"></b> <i th:text="${post.commentCount}">30</i>条回帖</h6>
            </div>
            <div class="col-4 text-right">
                <a href="#replyform" class="btn btn-primary btn-sm">&nbsp;&nbsp;回&nbsp;&nbsp;帖&nbsp;&nbsp;</a>
            </div>
        </div>
        <!-- 回帖列表 -->
        <ul class="list-unstyled mt-4">
            <li class="media pb-3 pt-3 mb-3 border-bottom" th:each="cvo:${comments}">
                <a href="profile.html">
                    <qiniu th:src="${cvo.user.headerUrl}"
                         class="align-self-start mr-4 rounded-circle user-header" alt="用户头像">
                </a>
                <div class="media-body">
                    <div class="mt-0">
                        <span class="font-size-12 text-success" th:utext="${cvo.user.username}">掉脑袋切切</span>
                        <span class="badge badge-secondary float-right floor">
                            <i th:text="${page.offset + cvoStat.count}">1</i>#
                        </span>
                    </div>
                    <div class="mt-2" th:utext="${cvo.comment.content}">
                        这开课时间是不是有点晚啊。。。
                    </div>
                    <div class="mt-4 text-muted font-size-12">
                        <span>发布于 <b th:text="${#dates.format(cvo.comment.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 15:32:18</b></span>
                        <ul class="d-inline float-right">
                            <li class="d-inline ml-2"><a href="#" class="text-primary">赞(1)</a></li>
                            <li class="d-inline ml-2">|</li>
                            <li class="d-inline ml-2"><a href="#" class="text-primary">回复(<i
                                    th:text="${cvo.replyCount}">2</i>)</a></li>
                        </ul>
                    </div>
                    <!-- 回复列表 -->
                    <ul class="list-unstyled mt-4 bg-gray p-3 font-size-12 text-muted">
                        <li class="pb-3 pt-3 mb-3 border-bottom" th:each="rvo:${cvo.replys}">
                            <div>
                                <span th:if="${rvo.target ==null}">
                                    <b class="text-info" th:text="${rvo.user.username}">寒江雪</b>:&nbsp;&nbsp;
                                </span>
                                <span th:if="${rvo.target !=null}">
                                    <i class="text-info" th:text="${rvo.user.username}">Sissi</i>回复
                                    <b class="text-info" th:text="${rvo.target.username}">寒江雪</b>:&nbsp;&nbsp;
                                </span>
                                <span th:utext="${rvo.reply.content}">这个是直播时间哈，觉得晚的话可以直接看之前的完整录播的~</span>
                            </div>
                            <div class="mt-3">
                                <span th:text="${#dates.format(rvo.reply.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 15:32:18</span>
                                <ul class="d-inline float-right">
                                    <li class="d-inline ml-2"><a href="#" class="text-primary">赞(1)</a></li>
                                    <li class="d-inline ml-2">|</li>
                                    <li class="d-inline ml-2"><a th:href="|#huifu-${rvoStat.count}|" data-toggle="collapse"
                                                                 class="text-primary">回复</a></li>
                                </ul>
                                <div th:id="|huifu-${rvoStat.count}|" class="mt-4 collapse">
                                    <div>
                                        <input type="text" class="input-size" placeholder="回复寒江雪"/>
                                    </div>
                                    <div class="text-right mt-2">
                                        <button type="button" class="btn btn-primary btn-sm" onclick="#">&nbsp;&nbsp;回&nbsp;&nbsp;复&nbsp;&nbsp;</button>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <!-- 回复输入框 -->
                        <li class="pb-3 pt-3">
                            <div>
                                <input type="text" class="input-size" placeholder="请输入你的观点"/>
                            </div>
                            <div class="text-right mt-2">
                                <button type="button" class="btn btn-primary btn-sm" onclick="#">&nbsp;&nbsp;回&nbsp;&nbsp;复&nbsp;&nbsp;</button>
                            </div>
                        </li>
                    </ul>
                </div>
            </li>
        </ul>
        <!-- 分页 -->
        <nav class="mt-5" th:replace="index::pagination">
            <ul class="pagination justify-content-center">
                <li class="page-item"><a class="page-link" href="#">首页</a></li>
                <li class="page-item disabled"><a class="page-link" href="#">上一页</a></li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item"><a class="page-link" href="#">4</a></li>
                <li class="page-item"><a class="page-link" href="#">5</a></li>
                <li class="page-item"><a class="page-link" href="#">下一页</a></li>
                <li class="page-item"><a class="page-link" href="#">末页</a></li>
            </ul>
        </nav>
    </div>
    <!-- 回帖输入 -->
    <div class="container mt-3">
        <form class="replyform">
            <p class="mt-3">
                <a name="replyform"></a>
                <textarea placeholder="在这里畅所欲言你的看法吧!"></textarea>
            </p>
            <p class="text-right">
                <button type="submit" class="btn btn-primary btn-sm">&nbsp;&nbsp;回&nbsp;&nbsp;帖&nbsp;&nbsp;</button>
            </p>
        </form>
    </div>
</div>
```

> 分页那里复用了 index.html 的分页

##### 3.3 运行结果

![image-20220714155118982](http://qiniu.dyl.fit/Interview/image-20220714155118982.png)

### 3.6 添加评论（使用了事务管理）

* 数据层
  * 增加评论数据。
  * 修改帖子的评论数量。
* 业务层
  * 处理添加评论的业务：先增加评论、再更新帖子的评论数量。
* 表现层
  * 处理添加评论数据的请求。
  * 设置添加评论的表单。

#### 1、修改数据层

在 CommentMapper 中添加 insertComment() 方法

```java
int insertComment(Comment comment);
```

配置相应的 CommentMapper.xml 中的 sql 语句

```xml
<insert id="insertComment" parameterType="Comment">
    insert into comment(<include refid="insertFields"/>)
    values(#{userId},#{entityType},#{entityId},#{targetId},#{content},#{status},#{createTime})
</insert>
```

在 DiscussPostMapper 中添加 updateCommentCount() 方法

```java
int updateCommentCount(int id, int commentCount);
```

配置相应的 DiscussPostMapper.xml 中的 sql 语句

```xml
<update id="updateCommentCount">
    update discuss_post set comment_count = #{commentCount} where id = #{id}
</update>
```

#### 2、修改业务层

##### 2.1 修改 service 层

在 DiscussPostService 中添加 updateCommentCount() 方法

```java
public int updateCommentCount(int id, int commentCount) {
    return discussPostMapper.updateCommentCount(id, commentCount);
}
```

在 CommentService 中注入 SensitiveFilter、DiscussPostService 同时实现 CommunityConstant 接口

```java
@Resource
private SensitiveFilter sensitiveFilter;

@Resource
private DiscussPostService discussPostService;
```

添加 addComment() 方法

```java
@Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)
public int addComment(Comment comment) {
    if (comment == null) {
        throw new IllegalArgumentException("参数不能为空!");
    }

    // 添加评论
    comment.setContent(HtmlUtils.htmlEscape(comment.getContent()));
    comment.setContent(sensitiveFilter.filter(comment.getContent()));
    int rows = commentMapper.insertComment(comment);

    // 更新帖子评论数量
    if (comment.getEntityType() == ENTITY_TYPE_POST) {
        int count = commentMapper.selectCountByEntity(comment.getEntityType(), comment.getEntityId());
        discussPostService.updateCommentCount(comment.getEntityId(), count);
    }

    return rows;
}
```

##### 2.2 修改 controller 层

创建 CommentController

```java
@Controller
@RequestMapping("/comment")
public class CommentController {

    @Resource
    private CommentService commentService;

    @Resource
    private HostHolder hostHolder;

    @PostMapping("/add/{discussPostId}")
    public String addComment(@PathVariable("discussPostId") int discussPostId, Comment comment) {
        comment.setUserId(hostHolder.getUser().getId());
        comment.setStatus(0);
        comment.setCreateTime(new Date());
        commentService.addComment(comment);

        return "redirect:/discuss/detail/" + discussPostId;
    }
}
```

#### 3、修改表现层（前端界面）

修改 discuss-detail.html

```html
<!-- 回帖输入 -->
<div class="container mt-3">
    <form class="replyform" method="post" th:action="@{|/comment/add/${post.id}|}">
        <p class="mt-3">
            <a name="replyform"></a>
            <textarea placeholder="在这里畅所欲言你的看法吧!" name="content"></textarea>
            <input type="hidden" name="entityType" value="1">
            <input type="hidden" name="entityType" th:value="${post.id}">
        </p>
        <p class="text-right">
            <button type="submit" class="btn btn-primary btn-sm">&nbsp;&nbsp;回&nbsp;&nbsp;帖&nbsp;&nbsp;</button>
        </p>
    </form>
</div>
```

```html
<!-- 回复输入框 -->
<li class="pb-3 pt-3">
    <form method="post" th:action="@{|/comment/add/${post.id}|}">
        <div>
            <input type="text" class="input-size" name="content" placeholder="请输入你的观点"/>
            <input type="hidden" name="entityType" value="2">
            <input type="hidden" name="entityId" th:value="${cvo.comment.id}">
        </div>
        <div class="text-right mt-2">
            <button type="submit" class="btn btn-primary btn-sm" onclick="#">&nbsp;&nbsp;回&nbsp;&nbsp;复&nbsp;&nbsp;</button>
        </div>
    </form>
</li>
```

```html
<div th:id="|huifu-${rvoStat.count}|" class="mt-4 collapse">
    <form method="post" th:action="@{|/comment/add/${post.id}|}">
        <div>
            <input type="text" class="input-size" name="content" th:placeholder="|回复${rvo.user.username}|"/>
            <input type="hidden" name="entityType" value="2">
            <input type="hidden" name="entityId" th:value="${cvo.comment.id}">
            <input type="hidden" name="targetId" th:value="${rvo.user.id}">
        </div>
        <div class="text-right mt-2">
            <button type="submit" class="btn btn-primary btn-sm" onclick="#">&nbsp;&nbsp;回&nbsp;&nbsp;复&nbsp;&nbsp;</button>
        </div>
    </form>
</div>
```

### 3.7 私信列表

* 私信列表
  * 查询当前用户的会话列表，每个会话只显示一条最新的私信。
  * 支持分页显示。
* 私信详情
  * 查询某个会话所包含的私信。
  * 支持分页显示。

#### 1、私信列表

##### 1.1 创建实体类

创建 Message 实体类

```java
public class Message {

    private int id;
    private int fromId;
    private int toId;
    private String conversationId;
    private String content;
    private int status;
    private Date createTime;

    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    public int getFromId() {
        return fromId;
    }

    public void setFromId(int fromId) {
        this.fromId = fromId;
    }

    public int getToId() {
        return toId;
    }

    public void setToId(int toId) {
        this.toId = toId;
    }

    public String getConversationId() {
        return conversationId;
    }

    public void setConversationId(String conversationId) {
        this.conversationId = conversationId;
    }

    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public int getStatus() {
        return status;
    }

    public void setStatus(int status) {
        this.status = status;
    }

    public Date getCreateTime() {
        return createTime;
    }

    public void setCreateTime(Date createTime) {
        this.createTime = createTime;
    }

    @Override
    public String toString() {
        return "Message{" +
                "id=" + id +
                ", fromId=" + fromId +
                ", toId=" + toId +
                ", conversationId='" + conversationId + '\'' +
                ", content='" + content + '\'' +
                ", status=" + status +
                ", createTime=" + createTime +
                '}';
    }
}
```

##### 1.2 创建 mapper

创建 MessageMapper

```java
@Mapper
public interface MessageMapper {

    // 查询当前用户的会话列表,针对每个会话只返回一条最新的私信.
    List<Message> selectConversations(int userId, int offset, int limit);

    // 查询当前用户的会话数量.
    int selectConversationCount(int userId);

    // 查询某个会话所包含的私信列表.
    List<Message> selectLetters(String conversationId, int offset, int limit);

    // 查询某个会话所包含的私信数量.
    int selectLetterCount(String conversationId);

    // 查询未读私信的数量
    int selectLetterUnreadCount(int userId, String conversationId);
}
```

##### 1.3 配置相应的 sql 语句

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dyl.community.mapper.MessageMapper">

    <sql id="selectFields">
        id, from_id, to_id, conversation_id, content, status, create_time
    </sql>

    <sql id="insertFields">
        from_id, to_id, conversation_id, content, status, create_time
    </sql>

    <select id="selectConversations" resultType="Message">
        select
        <include refid="selectFields"/>
        from message
        where id in (
        select max(id) from message
        where status != 2
        and from_id != 1
        and (from_id = #{userId} or to_id = #{userId})
        group by conversation_id
        )
        order by id desc
        limit #{offset}, #{limit}
    </select>

    <select id="selectConversationCount" resultType="int">
        select count(m.maxid)
        from (
                 select max(id) as maxid
                 from message
                 where status != 2
                   and from_id != 1
                   and (from_id = #{userId} or to_id = #{userId})
                 group by conversation_id
             ) as m
    </select>

    <select id="selectLetters" resultType="Message">
        select
        <include refid="selectFields"/>
        from message
        where status != 2
        and from_id != 1
        and conversation_id = #{conversationId}
        order by id desc
        limit #{offset}, #{limit}
    </select>

    <select id="selectLetterCount" resultType="int">
        select count(id)
        from message
        where status != 2
          and from_id != 1
          and conversation_id = #{conversationId}
    </select>

    <select id="selectLetterUnreadCount" resultType="int">
        select count(id)
        from message
        where status = 0
        and from_id != 1
        and to_id = #{userId}
        <if test="conversationId!=null">
            and conversation_id = #{conversationId}
        </if>
    </select>

</mapper>
```

##### 1.4 创建测试类

```java
@SpringBootTest
class MessageMapperTest {

    @Resource
    private MessageMapper messageMapper;


    @Test
    void testSelectLetters() {
        List<Message> list = messageMapper.selectConversations(111, 0, 20);
        for (Message message : list) {
            System.out.println(message);
        }

        int count = messageMapper.selectConversationCount(111);
        System.out.println(count);

        list = messageMapper.selectLetters("111_112", 0, 10);
        for (Message message : list) {
            System.out.println(message);
        }

        count = messageMapper.selectLetterCount("111_112");
        System.out.println(count);

        count = messageMapper.selectLetterUnreadCount(131, "111_131");
        System.out.println(count);
    }

}
```

##### 1.5 创建 Service

创建 MessageService

```java
@Service
public class MessageService {

    @Resource
    private MessageMapper messageMapper;


    public List<Message> findConversations(int userId, int offset, int limit) {
        return messageMapper.selectConversations(userId, offset, limit);
    }

    public int findConversationCount(int userId) {
        return messageMapper.selectConversationCount(userId);
    }

    public List<Message> findLetters(String conversationId, int offset, int limit) {
        return messageMapper.selectLetters(conversationId, offset, limit);
    }

    public int findLetterCount(String conversationId) {
        return messageMapper.selectLetterCount(conversationId);
    }

    public int findLetterUnreadCount(int userId, String conversationId) {
        return messageMapper.selectLetterUnreadCount(userId, conversationId);
    }
}
```

##### 1.6 创建 controller

创建 MessageController

```java
@Controller
public class MessageController {

    @Resource
    private MessageService messageService;

    @Resource
    private HostHolder hostHolder;

    @Resource
    private UserService userService;

    // 私信列表
    @GetMapping("/letter/list")
    public String getLetterList(Model model, Page page) {
        User user = hostHolder.getUser();
        // 分页信息
        page.setLimit(5);
        page.setPath("/letter/list");
        page.setRows(messageService.findConversationCount(user.getId()));

        // 会话列表
        List<Message> conversationList = messageService.findConversations(
                user.getId(), page.getOffset(), page.getLimit());
        List<Map<String, Object>> conversations = new ArrayList<>();
        if (conversationList != null) {
            for (Message message : conversationList) {
                Map<String, Object> map = new HashMap<>();
                map.put("conversation", message);
                map.put("letterCount", messageService.findLetterCount(message.getConversationId()));
                map.put("unreadCount", messageService.findLetterUnreadCount(user.getId(), message.getConversationId()));
                int targetId = user.getId() == message.getFromId() ? message.getToId() : message.getFromId();
                map.put("target", userService.findUserById(targetId));

                conversations.add(map);
            }
        }
        model.addAttribute("conversations", conversations);

        // 查询未读消息数量
        int letterUnreadCount = messageService.findLetterUnreadCount(user.getId(), null);
        model.addAttribute("letterUnreadCount", letterUnreadCount);

        return "/site/letter";
    }
}
```

##### 1.7 修改前端界面

修改 index.html

```html
<li class="nav-item ml-3 btn-group-vertical" th:if="${loginUser!=null}">
    <a class="nav-link position-relative" th:href="@{/letter/list}">消息<span
            class="badge badge-danger">12</span></a>
</li>
```

修改 letter.html

```html
<li class="nav-item">
    <a class="nav-link position-relative active"
       th:href="@{/letter/list}">朋友私信<span
            class="badge badge-danger" th:text="${letterUnreadCount}"
            th:if="${letterUnreadCount!=0}">3</span></a>
</li>
```

```html
<li class="media pb-3 pt-3 mb-3 border-bottom position-relative" th:each="map:${conversations}">
    <span class="badge badge-danger" th:text="${map.unreadCount}" th:if="${map.unreadCount!=0}">3</span>
    <a href="profile.html">
        <qiniu th:src="${map.target.headerUrl}" class="mr-4 rounded-circle user-header"
             alt="用户头像">
    </a>
    <div class="media-body">
        <h6 class="mt-0 mb-3">
            <span class="text-success" th:utext="${map.target.username}">落基山脉下的闲人</span>
            <span class="float-right text-muted font-size-12" th:text="${#dates.format(map.conversation.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-28 14:13:25</span>
        </h6>
        <div>
            <a href="letter-detail.html" th:utext="${map.conversation.content}">米粉车, 你来吧!</a>
            <ul class="d-inline font-size-12 float-right">
                <li class="d-inline ml-2"><a href="#" class="text-primary">共<i th:text="${map.letterCount}">5</i>条会话</a></li>
            </ul>
        </div>
    </div>
</li>
```

##### 1.8 运行结果

![image-20220715095717102](http://qiniu.dyl.fit/Interview/image-20220715095717102.png)

#### 2、私信详情

##### 2.1 修改 controller

在 MessageController 添加方法

```java
//私信详细信息
@GetMapping("/letter/detail/{conversationId}")
public String getLetterDetail(@PathVariable("conversationId") String conversationId, Page page, Model model) {
    // 分页信息
    page.setLimit(5);
    page.setPath("/letter/detail/" + conversationId);
    page.setRows(messageService.findLetterCount(conversationId));

    // 私信列表
    List<Message> letterList = messageService.findLetters(conversationId, page.getOffset(), page.getLimit());
    List<Map<String, Object>> letters = new ArrayList<>();
    if (letterList != null) {
        for (Message message : letterList) {
            Map<String, Object> map = new HashMap<>();
            map.put("letter", message);
            map.put("fromUser", userService.findUserById(message.getFromId()));
            letters.add(map);
        }
    }
    model.addAttribute("letters", letters);

    // 私信目标
    model.addAttribute("target", getLetterTarget(conversationId));

    return "/site/letter-detail";
}

private User getLetterTarget(String conversationId) {
    String[] ids = conversationId.split("_");
    int id0 = Integer.parseInt(ids[0]);
    int id1 = Integer.parseInt(ids[1]);

    if (hostHolder.getUser().getId() == id0) {
        return userService.findUserById(id1);
    } else {
        return userService.findUserById(id0);
    }
}
```

##### 2.2 修改前端界面

修改 letter.html

```html
<div>
    <a th:href="@{|/letter/detail/${map.conversation.conversationId}|}" th:utext="${map.conversation.content}">米粉车, 你来吧!</a>
    <ul class="d-inline font-size-12 float-right">
        <li class="d-inline ml-2"><a href="#" class="text-primary">共<i
                th:text="${map.letterCount}">5</i>条会话</a></li>
    </ul>
</div>
```

修改 letter_detail.html

```html
<div class="col-8">
    <h6><b class="square"></b> 来自 <i class="text-success" th:utext="${target.username}">落基山脉下的闲人</i> 的私信
    </h6>
</div>
```

```html
<!-- 内容 -->
<div class="main">
    <div class="container">
        <div class="row">
            <div class="col-8">
                <h6><b class="square"></b> 来自 <i class="text-success" th:utext="${target.username}">落基山脉下的闲人</i> 的私信
                </h6>
            </div>
            <div class="col-4 text-right">
                <button type="button" class="btn btn-secondary btn-sm" onclick="back()">返回
                </button>
                <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#sendModal">
                    给TA私信
                </button>
            </div>
        </div>
        <!-- 弹出框 -->
        <div class="modal fade" id="sendModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">发私信</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="form-group">
                                <label for="recipient-name" class="col-form-label">发给：</label>
                                <input type="text" class="form-control" id="recipient-name" value="落基山脉下的闲人">
                            </div>
                            <div class="form-group">
                                <label for="message-text" class="col-form-label">内容：</label>
                                <textarea class="form-control" id="message-text" rows="10"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="sendBtn">发送</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- 提示框 -->
        <div class="modal fade" id="hintModal" tabindex="-1" role="dialog" aria-labelledby="hintModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="hintModalLabel">提示</h5>
                    </div>
                    <div class="modal-body" id="hintBody">
                        发送完毕!
                    </div>
                </div>
            </div>
        </div>

        <!-- 私信列表 -->
        <ul class="list-unstyled mt-4">
            <li class="media pb-3 pt-3 mb-2" th:each="map:${letters}">
                <a href="profile.html">
                    <qiniu th:src="${map.fromUser.headerUrl}" class="mr-4 rounded-circle user-header"
                         alt="用户头像">
                </a>
                <div class="toast show d-lg-block" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <strong class="mr-auto" th:utext="${map.fromUser.username}">落基山脉下的闲人</strong>
                        <small th:text="${#dates.format(map.letter.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-25
                            15:49:32</small>
                        <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="toast-body" th:utext="${map.letter.content}">
                        君不见, 黄河之水天上来, 奔流到海不复回!
                    </div>
                </div>
            </li>
        </ul>
        <!-- 分页 -->
        <nav class="mt-5" th:replace="index::pagination"></nav>
    </div>
</div>
```

```html
<script>
    function back() {
        location.href = CONTEXT_PATH + "/letter/list"
    }
</script>
```

##### 2.3 运行结果

![image-20220715095734596](http://qiniu.dyl.fit/Interview/image-20220715095734596.png)

### 3.8 发送私信

* 发送私信
  * 采用异步的方式发送私信。
  * 发送成功后刷新私信列表。
* 设置已读
  * 访问私信详情时，将显示的私信设置为已读状态。

#### 1、发送私信

##### 1.1 修改 mapper

在 MessageMapper 增加方法

```java
// 新增消息
int insertMessage(Message message);

// 修改消息的状态
int updateStatus(List<Integer> ids, int status);
```

##### 1.2 配置 xml

在 MessageMapper.xml 中配置相应的 sql 语句

```xml
<insert id="insertMessage" parameterType="Message" keyProperty="id">
    insert into message(<include refid="insertFields"/>)
    values(#{fromId},#{toId},#{conversationId},#{content},#{status},#{createTime})
</insert>

<update id="updateStatus">
    update message set status = #{status}
    where id in
    <foreach collection="ids" item="id" open="(" separator="," close=")">
        #{id}
    </foreach>
</update>
```

##### 1.3 修改 service

在 MessageService 中添加方法

```java
public int addMessage(Message message) {
    message.setContent(HtmlUtils.htmlEscape(message.getContent()));
    message.setContent(sensitiveFilter.filter(message.getContent()));
    return messageMapper.insertMessage(message);
}

public int readMessage(List<Integer> ids) {
    return messageMapper.updateStatus(ids, 1);
}
```

1.4 修改 Controller

在 MessageController 中添加方法

```java
//发私信
@PostMapping("/letter/send")
@ResponseBody
public String sendLetter(String toName, String content) {
    User target = userService.findUserByName(toName);
    if (target == null) {
        return CommunityUtil.getJSONString(1, "目标用户不存在!");
    }

    Message message = new Message();
    message.setFromId(hostHolder.getUser().getId());
    message.setToId(target.getId());
    // todo
    // message.setConversationId(Math.max(message.getFromId(), message.getFromId()), Math.min(message.getFromId(), message.getFromId());
    if (message.getFromId() < message.getToId()) {
        message.setConversationId(message.getFromId() + "_" + message.getToId());
    } else {
        message.setConversationId(message.getToId() + "_" + message.getFromId());
    }
    message.setContent(content);
    message.setCreateTime(new Date());
    messageService.addMessage(message);

    return CommunityUtil.getJSONString(0);
}
```

此时也需要在 UserService 中添加方法

```java
public User findUserByName(String username) {
    return userMapper.selectByName(username);
}
```

##### 1.5 修改前端界面

修改 letter.js

```js
$(function(){
   $("#sendBtn").click(send_letter);
   $(".close").click(delete_msg);
});

function send_letter() {
   $("#sendModal").modal("hide");

   var toName = $("#recipient-name").val();
   var content = $("#message-text").val();
   $.post(
      CONTEXT_PATH + "/letter/send",
      {"toName": toName, "content": content},
      function (data) {
         data = $.parseJSON(data);
         if (data.code === 0) {
            $("#hintBody").text("发送成功!");
         } else {
            $("#hintBody").text(data.msg);
         }

         $("#hintModal").modal("show");
         setTimeout(function () {
            $("#hintModal").modal("hide");
            if (data.code == 0) {
               window.location.reload();
            }
         }, 2000);
      }
   );
}

function delete_msg() {
   // TODO 删除数据
   $(this).parents(".media").remove();
}
```

修改 letter-detail.html 

修改 letter-detail.html 中提示框里的代码

```html
<div class="form-group">
    <label for="recipient-name" class="col-form-label">发给：</label>
    <input type="text" class="form-control" id="recipient-name"
           th:value="${target.username}">
</div>
```

##### 1.6 运行结果

![动画9](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB9.gif)

#### 2、设置已读

##### 2.1 修改 controller

修改 MessageController

```java
//得到未读的id集合
private List<Integer> getLetterIds(List<Message> letterList) {
    List<Integer> ids = new ArrayList<>();

    if (letterList != null) {
        for (Message message : letterList) {
            if (hostHolder.getUser().getId() == message.getToId() && message.getStatus() == 0) {
                ids.add(message.getId());
            }
        }
    }
    return ids;
}
```

将以下代码加入到 getLetterDetail() 方法中

```java
List<Integer> ids = getLetterIds(letterList);
if (!ids.isEmpty()) {
    messageService.readMessage(ids);
}
```

完整方法的代码如下

```java
//私信详细信息
@GetMapping("/letter/detail/{conversationId}")
public String getLetterDetail(@PathVariable("conversationId") String conversationId, Page page, Model model) {
    // 分页信息
    page.setLimit(5);
    page.setPath("/letter/detail/" + conversationId);
    page.setRows(messageService.findLetterCount(conversationId));

    // 私信列表
    List<Message> letterList = messageService.findLetters(conversationId, page.getOffset(), page.getLimit());
    List<Map<String, Object>> letters = new ArrayList<>();
    if (letterList != null) {
        for (Message message : letterList) {
            Map<String, Object> map = new HashMap<>();
            map.put("letter", message);
            map.put("fromUser", userService.findUserById(message.getFromId()));
            letters.add(map);
        }
    }
    model.addAttribute("letters", letters);

    // 私信目标
    model.addAttribute("target", getLetterTarget(conversationId));

    List<Integer> ids = getLetterIds(letterList);
    if (!ids.isEmpty()) {
        messageService.readMessage(ids);
    }

    return "/site/letter-detail";
}
```

##### 2.2 运行结果

![动画10](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB10.gif)

### 3.9 统一处理异常

* @ControllerAdvice
  * 用于修饰类，表示该类是Controller的全局配置类。
  * 在此类中，可以对Controller进行如下三种全局配置：异常处理方案、绑定数据方案、绑定参数方案。
* @ExceptionHandler
  * 用于修饰方法，该方法会在Controller出现异常后被调用，用于处理捕获到的异常。
* @ModelAttribute
  * 用于修饰方法，该方法会在Controller方法执行前被调用，用于为Model对象绑定参数。
* @DataBinder
  * 用于修饰方法，该方法会在Controller方法执行前被调用，用于绑定参数的转换器。

#### 1、实现步骤

将 error 包从 site 包下移动到 templates 包下就可以生效

##### 1.1 修改前端界面

将 404.html 和 500.html 按照 thymeleaf 语法改一下

##### 1.2 运行结果

浏览器中输入 http://localhost:8080/community/index/abc （404错误）

![image-20220715104217243](http://qiniu.dyl.fit/Interview/image-20220715104217243.png)

浏览器中输入 http://localhost:8080/community/letter/list（500错误）

![image-20220715104245638](http://qiniu.dyl.fit/Interview/image-20220715104245638.png)

##### 1.3 修改 Controller 层

在 HomeController 中添加方法

```java
@GetMapping("/error")
public String getErrorPage() {
    return "/error/500";
}
```

在 controller 包内创建 advice 包并新建 ExceptionAdvice 类

```java
@ControllerAdvice(annotations = Controller.class)
public class ExceptionAdvice {

    private static final Logger logger = LoggerFactory.getLogger(ExceptionAdvice.class);

    @ExceptionHandler({Exception.class})
    public void handleException(Exception e, httpervletRequest request, httpervletResponse response) throws IOException {
        logger.error("服务器发生异常: " + e.getMessage());
        for (StackTraceElement element : e.getStackTrace()) {
            logger.error(element.toString());
        }

        // 判断是否为异步对象
        String xRequestedWith = request.getHeader("x-requested-with");
        if ("XMLHttpRequest".equals(xRequestedWith)) {
            response.setContentType("application/plain;charset=utf-8");
            PrintWriter writer = response.getWriter();
            writer.write(CommunityUtil.getJSONString(1, "服务器异常!"));
        } else {
            response.sendRedirect(request.getContextPath() + "/error");
        }
    }
}
```

##### 1.4 运行结果

![image-20220715105354793](http://qiniu.dyl.fit/Interview/image-20220715105354793.png)

### 3.10 统一记录日志

#### 1、AOP

##### 1.1 AOP 的概念

* Aspect Oriented Programing，即面向方面（切面）编程。
* AOP是一种编程思想，是对OOP的补充，可以进一步提高编程的效率。

<qiniu src="http://qiniu.dyl.fit/Interview/20191121213702.png" style="zoom: 67%;" />

##### 1.2 AOP 的术语

<qiniu src="http://qiniu.dyl.fit/Interview/20191121214201.png" style="zoom:60%;" />

##### 1.3 AOP 的实现

* AspectJ
  * AspectJ是语言级的实现，它扩展了Java语言，定义了AOP语法。
  * AspectJ在编译期织入代码，它有一个专门的编译器，用来生成遵守Java字节码规范的class文件。
* Spring AOP
  * Spring AOP使用纯Java实现，它不需要专门的编译过程，也不需要特殊的类装载器。
  * Spring AOP在运行时通过代理的方式织入代码，只支持方法类型的连接点。
  * Spring支持对AspectJ的集成。

##### 1.4 Spring AOP

* JDK动态代理
  * Java提供的动态代理技术，可以在运行时创建接口的代理实例。
  * Spring AOP默认采用此种方式，在接口的代理实例中织入代码。
* CGLib动态代理
  * 采用底层的字节码技术，在运行时创建子类代理实例。
  * 当目标对象不存在接口时，Spring AOP会采用此种方式，在子类实例中织入代码。

#### 2、实现步骤

##### 2.1 需求

* 帖子模块
* 评论模块
* 消息模块

##### 2.2 创建示例

新建 aspect 包，在包内新建 AlphaAspect

```java
@Component
@Aspect
public class AlphaAspect {

    @Pointcut("execution(* com.dyl.community.service.*.*(..))")
    public void pointcut() {

    }

    @Before("pointcut()")
    public void before() {
        System.out.println("before");
    }

    @After("pointcut()")
    public void after() {
        System.out.println("after");
    }

    @AfterReturning("pointcut()")
    public void afterRetuning() {
        System.out.println("afterRetuning");
    }

    @AfterThrowing("pointcut()")
    public void afterThrowing() {
        System.out.println("afterThrowing");
    }

    @Around("pointcut()")
    public Object around(ProceedingJoinPoint joinPoint) throws Throwable {
        System.out.println("around before");
        Object obj = joinPoint.proceed();
        System.out.println("around after");
        return obj;
    }
}
```

运行结果

![image-20220715134345521](http://qiniu.dyl.fit/Interview/image-20220715134345521.png)

##### 2.3 创建 Aspect

在包内新建 ServiceLogAspect

```java
@Component
@Aspect
public class ServiceLogAspect {

    private static final Logger logger = LoggerFactory.getLogger(ServiceLogAspect.class);

    @Pointcut("execution(* com.dyl.community.service.*.*(..))")
    public void pointcut() {

    }

    @Before("pointcut()")
    public void before(JoinPoint joinPoint) {
        // 用户[1.2.3.4],在[xxx],访问了[com.dyl.community.service.xxx()].
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        if (attributes == null) {
            return;
        }
        httpervletRequest request = attributes.getRequest();
        String ip = request.getRemoteHost();
        String now = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date());
        String target = joinPoint.getSignature().getDeclaringTypeName() + "." + joinPoint.getSignature().getName();
        logger.info(String.format("用户[%s],在[%s],访问了[%s].", ip, now, target));
    }
}
```

##### 2.4 运行结果

![image-20220715133434233](http://qiniu.dyl.fit/Interview/image-20220715133434233.png)

## 第4章 Redis，一站式高性能存储方案

### 4.1 Redis入门

* Redis是一款基于键值对的NoSQL数据库，它的值支持多种数据结构：
  字符串(strings)、哈希(hashes)、列表(lists)、集合(sets)、有序集合(sorted sets)等。
* Redis将所有的数据都存放在内存中，所以它的读写性能十分惊人。
  同时，Redis还可以将内存中的数据以快照或日志的形式保存到硬盘上，以保证数据的安全性。
* Redis典型的应用场景包括：缓存、排行榜、计数器、社交网络、消息队列等。

### 4.2 Spring整合Redis

* 配置Redis
  * 配置数据库参数
  * 编写配置类，构造RedisTemplate
* 访问Redis
  * redisTemplate.opsForValue()
  * redisTemplate.opsForHash()
  * redisTemplate.opsForList()
  * redisTemplate.opsForSet()
  * redisTemplate.opsForZSet()

#### 1、引入依赖

在 pom.xml 中添加 spring-boot-starter-data-redis 的依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

#### 2、配置 Redis

##### 2.1 配置数据库参数

```yaml
# RedisProperties
spring: 
    redis:
      database: 11
      host: localhost
      port: 6379
```

##### 2.2 编写配置类，构造 RedisTemplate

在 config 包内创建 RedisConfig

```java
@Configuration
public class RedisConfig {

    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);

        // 设置 key 的序列化方式
        template.setKeySerializer(RedisSerializer.string());
        // 设置 value 的序列化方式
        template.setValueSerializer(RedisSerializer.json());
        // 设置 hash 的 key 的序列化方式
        template.setHashKeySerializer(RedisSerializer.string());
        // 设置 hash 的 value 的序列化方式
        template.setHashValueSerializer(RedisSerializer.json());

        template.afterPropertiesSet();
        return template;
    }
}
```

创建测试类

```java
@SpringBootTest
class RedisConfigTest {

    @Resource
    private RedisTemplate redisTemplate;

    @Test
    void testStrings() {
        String redisKey = "test:count";

        redisTemplate.opsForValue().set(redisKey, 1);

        System.out.println(redisTemplate.opsForValue().get(redisKey));
        System.out.println(redisTemplate.opsForValue().increment(redisKey));
        System.out.println(redisTemplate.opsForValue().decrement(redisKey));
    }

    @Test
    void testHashes() {
        String redisKey = "test:user";

        redisTemplate.opsForHash().put(redisKey, "id", 1);
        redisTemplate.opsForHash().put(redisKey, "username", "zhangsan");

        System.out.println(redisTemplate.opsForHash().get(redisKey, "id"));
        System.out.println(redisTemplate.opsForHash().get(redisKey, "username"));
    }

    @Test
    void testLists() {
        String redisKey = "test:ids";

        redisTemplate.opsForList().leftPush(redisKey, 101);
        redisTemplate.opsForList().leftPush(redisKey, 102);
        redisTemplate.opsForList().leftPush(redisKey, 103);

        System.out.println(redisTemplate.opsForList().size(redisKey));
        System.out.println(redisTemplate.opsForList().index(redisKey, 0));
        System.out.println(redisTemplate.opsForList().range(redisKey, 0, 2));

        System.out.println(redisTemplate.opsForList().leftPop(redisKey));
        System.out.println(redisTemplate.opsForList().leftPop(redisKey));
        System.out.println(redisTemplate.opsForList().leftPop(redisKey));
    }

    @Test
    void testSets() {
        String redisKey = "test:teachers";

        redisTemplate.opsForSet().add(redisKey, "刘备", "关羽", "张飞", "赵云", "诸葛亮");

        System.out.println(redisTemplate.opsForSet().size(redisKey));
        System.out.println(redisTemplate.opsForSet().pop(redisKey));
        System.out.println(redisTemplate.opsForSet().members(redisKey));
    }

    @Test
    void testSortedSets() {
        String redisKey = "test:students";

        redisTemplate.opsForZSet().add(redisKey, "唐僧", 80);
        redisTemplate.opsForZSet().add(redisKey, "悟空", 90);
        redisTemplate.opsForZSet().add(redisKey, "八戒", 50);
        redisTemplate.opsForZSet().add(redisKey, "沙僧", 70);
        redisTemplate.opsForZSet().add(redisKey, "白龙马", 60);

        System.out.println(redisTemplate.opsForZSet().zCard(redisKey));
        System.out.println(redisTemplate.opsForZSet().score(redisKey, "八戒"));
        System.out.println(redisTemplate.opsForZSet().reverseRank(redisKey, "八戒"));
        System.out.println(redisTemplate.opsForZSet().reverseRange(redisKey, 0, 2));
    }

    @Test
    void testKeys() {
        redisTemplate.delete("test:user");

        System.out.println(redisTemplate.hasKey("test:user"));

        redisTemplate.expire("test:students", 10, TimeUnit.SECONDS);
    }

    // 多次访问同一个key
    @Test
    void testBoundOperations() {
        String redisKey = "test:count";
        BoundValueOperations operations = redisTemplate.boundValueOps(redisKey);
        operations.increment();
        operations.increment();
        operations.increment();
        operations.increment();
        operations.increment();
        System.out.println(operations.get());
    }

    // 编程式事务
    @Test
    void testTransactional() {
        Object obj = redisTemplate.execute(new SessionCallback() {
            @Override
            public Object execute(RedisOperations operations) throws DataAccessException {
                String redisKey = "test:tx";

                operations.multi();// 启用事务

                operations.opsForSet().add(redisKey, "zhangsan");
                operations.opsForSet().add(redisKey, "lisi");
                operations.opsForSet().add(redisKey, "wangwu");

                System.out.println(operations.opsForSet().members(redisKey));

                return operations.exec();
            }
        });
        System.out.println(obj);
    }
}
```

### 4.3 点赞

* 点赞
  * 支持对帖子、评论点赞。
  * 第1次点赞，第2次取消点赞。
* 首页点赞数量
  * 统计帖子的点赞数量。
* 详情页点赞数量
  * 统计点赞数量。
  * 显示点赞状态。

#### 1、点赞基础功能

##### 1.1 创建工具类

在 utils 包内创建 RedisKeyUtil

```java
public class RedisKeyUtil {
    private static final String SPLIT = ":";
    private static final String PREFIX_ENTITY_LIKE = "like:entity";

    // 某个实体的赞
    // like:entity:entityType:entityId -> set(userId)
    public static String getEntityLikeKey(int entityType, int entityId) {
        return PREFIX_ENTITY_LIKE + SPLIT + entityType + SPLIT + entityId;
    }
}
```

##### 1.2 创建service

创建 LikeService

```java
@Service
public class LikeService {

    @Resource
    private RedisTemplate redisTemplate;

    public void like(int userId, int entityType, int entityId) {
        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);

        boolean isMember = redisTemplate.opsForSet().isMember(entityLikeKey, userId);

        if (isMember) {
            redisTemplate.opsForSet().remove(entityLikeKey, userId);
        } else {
            redisTemplate.opsForSet().add(entityLikeKey, userId);
        }
    }

    // 查询某实体点赞的数量
    public long findEntityLikeCount(int entityType, int entityId) {
        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
        return redisTemplate.opsForSet().size(entityLikeKey);
    }

    // 查询某人对某实体的点赞状态
    public int findEntityLikeStatus(int userId, int entityType, int entityId) {
        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
        return redisTemplate.opsForSet().isMember(entityLikeKey, userId) ? 1 : 0;
    }
}
```

##### 1.3 创建 controller

创建 LikeController

```java
@Controller
public class LikeController {

    @Resource
    private LikeService likeService;

    @Resource
    private HostHolder hostHolder;

    @PostMapping("/like")
    @ResponseBody
    public String like(int entityType, int entityId) {
        User user = hostHolder.getUser();

        // 点赞
        likeService.like(user.getId(), entityType, entityId);
        // 数量
        long likeCount = likeService.findEntityLikeCount(entityType, entityId);
        // 状态
        int likeStatus = likeService.findEntityLikeStatus(user.getId(), entityType, entityId);
        // 返回结果
        Map<String, Object> map = new HashMap<>();
        map.put("likeCount", likeCount);
        map.put("likeStatus", likeStatus);

        return CommunityUtil.getJSONString(0, null, map);
    }
}
```

##### 1.4 修改前端界面

在 discuss-detail.html 中引入新的 discuss.js

```html
<script th:src="@{/js/discuss.js}"></script>
```

discuss.js 代码如下

```js
$(function () {
    $("#topBtn").click(setTop);
    $("#wonderfulBtn").click(setWonderful);
    $("#deleteBtn").click(setDelete);
});

function like(btn, entityType, entityId) {
    $.post(
        CONTEXT_PATH + "/like",
        {"entityType": entityType, "entityId": entityId},
        function (data) {
            data = $.parseJSON(data);
            if (data.code === 0) {
                $(btn).children("i").text(data.likeCount);
                $(btn).children("b").text(data.likeStatus === 1 ? '已赞' : "赞");
            } else {
                alert(data.msg);
            }
        }
    );
}
```

修改 discuss-detail.html 点赞的位置的代码为点击动作

```html
<li class="d-inline ml-2">
    <a href="javascript:;" th:onclick="|like(this,1,${post.id});|" class="text-primary">
        <b>赞</b> <i>11</i>
    </a>
</li>
```

```html
<li class="d-inline ml-2">
    <a href="javascript:;" th:onclick="|like(this,2,${cvo.comment.id});|" class="text-primary">
        <b>赞</b>(<i>1</i>)
    </a>
</li>
```

```html
<li class="d-inline ml-2">
    <a href="javascript:;" th:onclick="|like(this,2,${rvo.reply.id});|" class="text-primary">
        <b>赞</b>(<i>1</i>)
    </a>
</li>
```

##### 1.5 运行结果

![image-20220715153947646](http://qiniu.dyl.fit/Interview/image-20220715153947646.png)

> 这里赞的数量应该都是显示 11 ，此处的运行截图是用的完整完成功能后的截图，此处功能只有点击的时候显示已赞，再次点击就显示为赞为0

#### 2、显示首页点赞数量

##### 2.1 修改 controller

修改 HomeController

注入 LikeService,实现 CommunityConstant接口

```java
@Resource
private LikeService likeService;
```

修改 getIndexPage() 方法，在 for 语句其中添加

```java
        long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId());
        map.put("likeCount", likeCount);
```

完整的方法代码如下

```java
@GetMapping("/index")
public String getIndexPage(Model model, Page page) {
    // 方法调用之前，springMVC会自动实例化Model和Page，并将Page注入Model
    // 所以在thymeleaf中可以直接访问Page对象的数据
    page.setRows(discussPostservice.findDiscussPostRows(0));
    page.setPath("/index");

    List<DiscussPost> list = discussPostservice.findDiscussPosts(0, page.getOffset(), page.getLimit());
    List<Map<String, Object>> discussPosts = new ArrayList<>();
    if (list != null) {
        for (DiscussPost post : list) {
            Map<String, Object> map = new HashMap<>();
            map.put("post", post);
            User user = userService.findUserById(post.getUserId());
            map.put("user", user);
            discussPosts.add(map);

            long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId());
            map.put("likeCount", likeCount);
        }
    }
    model.addAttribute("discussPosts", discussPosts);
    return "/index";
}
```

##### 2.2 修改前端界面

修改 index.html 中赞数量的位置代码

```html
<li class="d-inline ml-2">赞 <span th:text="${map.likeCount}">11</span></li>
```

##### 2.3 运行结果

![image-20220715154905724](http://qiniu.dyl.fit/Interview/image-20220715154905724.png)

#### 3、显示帖子详情点赞数量

##### 3.1 修改 controller

修改 DiscussPostController

注入 LikeService

```java
@Resource
private LikeService likeService;
```

修改 getDiscussPost() 方法，在其中添加

```java
// 点赞数量
long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, discussPostId);
model.addAttribute("likeCount", likeCount);
// 点赞状态
int likeStatus = hostHolder.getUser() == null ? 0 :
        likeService.findEntityLikeStatus(hostHolder.getUser().getId(), ENTITY_TYPE_POST, discussPostId);
model.addAttribute("likeStatus", likeStatus);
```

然后在 for 语句中添加

```java
// 点赞数量
likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_COMMENT, comment.getId());
commentVo.put("likeCount", likeCount);
// 点赞状态
likeStatus = hostHolder.getUser() == null ? 0 :
        likeService.findEntityLikeStatus(hostHolder.getUser().getId(), ENTITY_TYPE_COMMENT, comment.getId());
commentVo.put("likeStatus", likeStatus);
```

然后再在下一个 for 语句中添加

```java
// 点赞数量
likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_COMMENT, reply.getId());
replyVo.put("likeCount", likeCount);
// 点赞状态
likeStatus = hostHolder.getUser() == null ? 0 :
        likeService.findEntityLikeStatus(hostHolder.getUser().getId(), ENTITY_TYPE_COMMENT, reply.getId());
replyVo.put("likeStatus", likeStatus);
```

完整的方法代码如下

```java
@GetMapping("/detail/{discussPostId}")
public String getDiscussPost(@PathVariable("discussPostId") int discussPostId, Model model, Page page) {
    // 帖子
    DiscussPost post = discussPostService.findDiscussPostById(discussPostId);
    model.addAttribute("post", post);

    // 作者
    User user = userService.findUserById(post.getUserId());
    model.addAttribute("user", user);

    // 点赞数量
    long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, discussPostId);
    model.addAttribute("likeCount", likeCount);
    // 点赞状态
    int likeStatus = hostHolder.getUser() == null ? 0 :
            likeService.findEntityLikeStatus(hostHolder.getUser().getId(), ENTITY_TYPE_POST, discussPostId);
    model.addAttribute("likeStatus", likeStatus);

    // 评论的分页信息
    page.setLimit(5);
    page.setPath("/discuss/detail/" + discussPostId);
    page.setRows(post.getCommentCount());

    // 评论：给帖子的评论
    // 回复：给评论的评论
    // 评论列表
    List<Comment> commentList = commentService.findCommentsByEntity(
            ENTITY_TYPE_POST, post.getId(), page.getOffset(), page.getLimit());
    // 评论VO列表
    List<Map<String, Object>> commentVoList = new ArrayList<>();
    if (commentList != null) {
        for (Comment comment : commentList) {
            // 评论VO
            Map<String, Object> commentVo = new HashMap<>();
            // 评论
            commentVo.put("comment", comment);
            // 作者
            commentVo.put("user", userService.findUserById(comment.getUserId()));

            // 点赞数量
            likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_COMMENT, comment.getId());
            commentVo.put("likeCount", likeCount);
            // 点赞状态
            likeStatus = hostHolder.getUser() == null ? 0 :
                    likeService.findEntityLikeStatus(hostHolder.getUser().getId(), ENTITY_TYPE_COMMENT, comment.getId());
            commentVo.put("likeStatus", likeStatus);


            // 回复列表 不再分页了
            // todo
            List<Comment> replyList = commentService.findCommentsByEntity(
                    ENTITY_TYPE_COMMENT, comment.getId(), 0, Integer.MAX_VALUE);
            // 回复VO列表
            List<Map<String, Object>> replyVoList = new ArrayList<>();
            if (replyList != null) {
                for (Comment reply : replyList) {
                    // 回复VO
                    Map<String, Object> replyVo = new HashMap<>();
                    // 回复
                    replyVo.put("reply", reply);
                    // 作者
                    replyVo.put("user", userService.findUserById(reply.getUserId()));
                    // 回复的目标
                    User target = reply.getTargetId() == 0 ? null : userService.findUserById(reply.getTargetId());
                    replyVo.put("target", target);

                    // 点赞数量
                    likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_COMMENT, reply.getId());
                    replyVo.put("likeCount", likeCount);
                    // 点赞状态
                    likeStatus = hostHolder.getUser() == null ? 0 :
                            likeService.findEntityLikeStatus(hostHolder.getUser().getId(), ENTITY_TYPE_COMMENT, reply.getId());
                    replyVo.put("likeStatus", likeStatus);

                    replyVoList.add(replyVo);
                }
            }
            commentVo.put("replys", replyVoList);

            // 回复数量
            int replyCount = commentService.findCommentCount(ENTITY_TYPE_COMMENT, comment.getId());
            commentVo.put("replyCount", replyCount);

            commentVoList.add(commentVo);
        }
    }
    model.addAttribute("comments", commentVoList);

    return "/site/discuss-detail";
}
```

##### 3.2 修改前端界面

修改 discuss-detail.html 中赞数量的位置代码

```html
<li class="d-inline ml-2">
    <a href="javascript:;" th:onclick="|like(this,1,${post.id});|" class="text-primary">
        <b th:text="${likeStatus==1?'已赞':'赞'}">赞</b> 
        <i th:text="${likeCount}">11</i>
    </a>
</li>
```

```html
<li class="d-inline ml-2">
    <a href="javascript:;" th:onclick="|like(this,2,${cvo.comment.id});|" class="text-primary">
        <b th:text="${cvo.likeStatus==1?'已赞':'赞'}">赞</b>
        (<i th:text="${cvo.likeCount}">1</i>)
    </a>
</li>
```

```html
<li class="d-inline ml-2">
    <a href="javascript:;" th:onclick="|like(this,2,${rvo.reply.id});|"
       class="text-primary">
        <b th:text="${rvo.likeStatus==1?'已赞':'赞'}">赞</b>
        (<i th:text="${rvo.likeCount}">1</i>)
    </a>
</li>
```

##### 3.3 运行结果

![image-20220715155638088](http://qiniu.dyl.fit/Interview/image-20220715155638088.png)

### 4.4 收到的赞

* 重构点赞功能
  * 以用户为key，记录点赞数量
  * increment(key)，decrement(key)
* 开发个人主页
  * 以用户为key，查询点赞数量

#### 1、重构点赞功能

##### 1.1 修改 RedisKeyUtil

```java
private static final String PREFIX_USER_LIKE = "like:user";

// 某个用户的赞
// like:user:userId -> int
public static String getUserLikeKey(int userId) {
    return PREFIX_USER_LIKE + SPLIT + userId;
}
```

##### 1.2 重构 LikeService

在 like() 方法中添加事务，并且添加参数 entityUserId

```java
public void like(int userId, int entityType, int entityId,int entityUserId) {
//        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
//
//        boolean isMember = redisTemplate.opsForSet().isMember(entityLikeKey, userId);
//
//        if (isMember) {
//            redisTemplate.opsForSet().remove(entityLikeKey, userId);
//        } else {
//            redisTemplate.opsForSet().add(entityLikeKey, userId);
//        }

        // 重构加上了获取用户收到的赞
        redisTemplate.execute(new SessionCallback() {
            @Override
            public Object execute(RedisOperations operations) throws DataAccessException {
                String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
                String userLikeKey = RedisKeyUtil.getUserLikeKey(entityUserId);

                boolean isMember = operations.opsForSet().isMember(entityLikeKey, userId);

                operations.multi();

                if (isMember) {
                    operations.opsForSet().remove(entityLikeKey, userId);
                    operations.opsForValue().decrement(userLikeKey);
                } else {
                    operations.opsForSet().add(entityLikeKey, userId);
                    operations.opsForValue().increment(userLikeKey);
                }

                return operations.exec();
            }
        });
    }
```

添加方法 findUserLikeCount()

```java
// 查询某个用户获得的赞
public int findUserLikeCount(int userId) {
    String userLikeKey = RedisKeyUtil.getUserLikeKey(userId);
    Integer count = (Integer) redisTemplate.opsForValue().get(userLikeKey);
    return count == null ? 0 : count.intValue();
}
```

##### 1.3 修改controller

修改 LikeController

在 like() 方法中添加参数 entityUserId

```java
@PostMapping("/like")
@ResponseBody
public String like(int entityType, int entityId, int entityUserId) {
    User user = hostHolder.getUser();

    // 点赞
    likeService.like(user.getId(), entityType, entityId, entityUserId);
    // 数量
    long likeCount = likeService.findEntityLikeCount(entityType, entityId);
    // 状态
    int likeStatus = likeService.findEntityLikeStatus(user.getId(), entityType, entityId);
    // 返回结果
    Map<String, Object> map = new HashMap<>();
    map.put("likeCount", likeCount);
    map.put("likeStatus", likeStatus);

    return CommunityUtil.getJSONString(0, null, map);
}
```

##### 1.4 修改前端界面

修改 discuss.js,添加 entityUserId 参数

```js
function like(btn, entityType, entityId, entityUserId) {
    $.post(
        CONTEXT_PATH + "/like",
        {"entityType": entityType, "entityId": entityId, "entityUserId": entityUserId},
        function (data) {
            data = $.parseJSON(data);
            if (data.code === 0) {
                $(btn).children("i").text(data.likeCount);
                $(btn).children("b").text(data.likeStatus === 1 ? '已赞' : "赞");
            } else {
                alert(data.msg);
            }
        }
    );
}
```

修改 discuss-detail.html

在原来赞的位置为 entityUserId 参数赋值

```html
<li class="d-inline ml-2">
    <a href="javascript:;" th:onclick="|like(this,1,${post.id},${post.userId});|" class="text-primary">
        <b th:text="${likeStatus==1?'已赞':'赞'}">赞</b> 
        <i th:text="${likeCount}">11</i>
    </a>
</li>
```

```html
<li class="d-inline ml-2">
    <a href="javascript:;" th:onclick="|like(this,2,${cvo.comment.id},${cvo.comment.userId});|" class="text-primary">
        <b th:text="${cvo.likeStatus==1?'已赞':'赞'}">赞</b>
        (<i th:text="${cvo.likeCount}">1</i>)
    </a>
</li>
```

```html
<li class="d-inline ml-2">
    <a href="javascript:;" th:onclick="|like(this,2,${rvo.reply.id},);|"
       class="text-primary">
        <b th:text="${rvo.likeStatus==1?'已赞':'赞'}">赞</b>
        (<i th:text="${rvo.likeCount}">1</i>)
    </a>
</li>
```

#### 2、开发个人主页

##### 2.1 修改 UserController

注入 LikeService

```java
@Resource
private LikeService likeService;
```

添加方法 getProfilePage()

```java
// 个人主页
@GetMapping("/profile/{userId}")
public String getProfilePage(@PathVariable("userId") int userId, Model model) {
    User user = userService.findUserById(userId);
    if (user == null) {
        throw new RuntimeException("该用户不存在");
    }

    // 用户
    model.addAttribute("user", user);
    // 获赞数量
    int likeCount = likeService.findUserLikeCount(userId);
    model.addAttribute("likeCount", likeCount);

    return "/site/profile";
}
```

##### 2.2 修改前端界面

修改 index.html

```html
<a class="dropdown-item text-center" th:href="@{|/user/profile/${loginUser.id}|}">个人主页</a>
```

```html
<a th:href="@{|/user/profile/${map.user.id}|}">
    <qiniu th:src="${map.user.headerUrl}" class="mr-4 rounded-circle" alt="用户头像"
         style="width:50px;height:50px;">
</a>
```

修改 profile.html

修改静态资源路径为 th 语法，然后修改个人信息处的代码

```html
<!-- 个人信息 -->
<div class="media mt-5">
    <qiniu th:src="${user.headerUrl}" class="align-self-start mr-4 rounded-circle"
         alt="用户头像" style="width:50px;">
    <div class="media-body">
        <h5 class="mt-0 text-warning">
            <span th:utext="${user.username}">nowcoder</span>
            <button type="button" class="btn btn-info btn-sm float-right mr-5 follow-btn">关注TA</button>
        </h5>
        <div class="text-muted mt-3">
            <span>注册于 <i class="text-muted"
                         th:text="${#dates.format(user.createTime,'yyyy-MM-dd HH:mm:ss')}">2015-06-12 15:20:12</i></span>
        </div>
        <div class="text-muted mt-3 mb-5">
            <span>关注了 <a class="text-primary" href="followee.html">5</a> 人</span>
            <span class="ml-4">关注者 <a class="text-primary" href="follower.html">123</a> 人</span>
            <span class="ml-4">获得了 <i class="text-danger" th:text="${likeCount}">87</i> 个赞</span>
        </div>
    </div>
</div>
```

##### 2.3 运行结果

![动画11](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB11.gif)

### 4.5 关注、取消关注

* 需求
  * 开发关注、取消关注功能。
  * 统计用户的关注数、粉丝数。
* 关注
  * 若A关注了B，则A是B的Follower（粉丝），B是A的Followee（目标）。
  * 关注的目标可以是用户、帖子、题目等，在实现时将这些目标抽象为实体。

#### 1、实现

##### 1.1 修复 utils 

在 RedisKeyUtil 中添加如下代码

```java
private static final String PREFIX_FOLLOWEE = "followee";
private static final String PREFIX_FOLLOWER = "follower";

// 某个用户关注的实体
// followee:userId:entityType -> zset(entityId,now)
public static String getFolloweeKey(int userId, int entityType) {
    return PREFIX_FOLLOWEE + SPLIT + userId + SPLIT + entityType;
}

// 某个实体拥有的粉丝
// follower:entityType:entityId -> zset(userId,now)
public static String getFollowerKey(int entityType, int entityId) {
    return PREFIX_FOLLOWER + SPLIT + entityType + SPLIT + entityId;
}
```

##### 1.2 修改 service

新z增 FollowService

```java
@Service
public class FollowService {

    @Resource
    private RedisTemplate redisTemplate;

    public void follow(int userId, int entityType, int entityId) {
        redisTemplate.execute(new SessionCallback() {
            @Override
            public Object execute(RedisOperations operations) throws DataAccessException {
                String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);
                String followerKey = RedisKeyUtil.getFollowerKey(entityType, entityId);

                operations.multi();

                operations.opsForZSet().add(followeeKey, entityId, System.currentTimeMillis());
                operations.opsForZSet().add(followerKey, userId, System.currentTimeMillis());

                return operations.exec();
            }
        });
    }

    public void unfollow(int userId, int entityType, int entityId) {
        redisTemplate.execute(new SessionCallback() {
            @Override
            public Object execute(RedisOperations operations) throws DataAccessException {
                String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);
                String followerKey = RedisKeyUtil.getFollowerKey(entityType, entityId);

                operations.multi();

                operations.opsForZSet().remove(followeeKey, entityId);
                operations.opsForZSet().remove(followerKey, userId);

                return operations.exec();
            }
        });
    }

    // 查询关注的实体的数量
    public long findFolloweeCount(int userId, int entityType) {
        String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);
        return redisTemplate.opsForZSet().zCard(followeeKey);
    }

    // 查询实体的粉丝的数量
    public long findFollowerCount(int entityType, int entityId) {
        String followerKey = RedisKeyUtil.getFollowerKey(entityType, entityId);
        return redisTemplate.opsForZSet().zCard(followerKey);
    }

    // 查询当前用户是否已关注该实体
    public boolean hasFollowed(int userId, int entityType, int entityId) {
        String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);
        return redisTemplate.opsForZSet().score(followeeKey, entityId) != null;
    }
}
```

##### 1.3 修改 Controller

新增 FollowController

```java
@Controller
public class FollowController {

    @Resource
    private FollowService followService;

    @Resource
    private HostHolder hostHolder;

    @PostMapping("/follow")
    @ResponseBody
    public String follow(int entityType, int entityId) {
        User user = hostHolder.getUser();

        followService.follow(user.getId(), entityType, entityId);

        return CommunityUtil.getJSONString(0, "已关注");
    }

    @PostMapping("/unfollow")
    @ResponseBody
    public String unfollow(int entityType, int entityId) {
        User user = hostHolder.getUser();

        followService.unfollow(user.getId(), entityType, entityId);

        return CommunityUtil.getJSONString(0, "已取消关注");
    }
}
```

修改 UserController 

在 CommunityConstant 中添加常量

```java
/**
 * 实体类型: 用户
 */
int ENTITY_TYPE_USER = 3;
```

接着 UserController 实现该接口，再注入 FollowService，显示关注数量和粉丝数量

```java
@Resource
private FollowService followService;
```

```java
// 个人主页

@GetMapping("/profile/{userId}")
public String getProfilePage(@PathVariable("userId") int userId, Model model) {
    User user = userService.findUserById(userId);
    if (user == null) {
        throw new RuntimeException("该用户不存在");
    }

    // 用户
    model.addAttribute("user", user);
    // 获赞数量
    int likeCount = likeService.findUserLikeCount(userId);
    model.addAttribute("likeCount", likeCount);

    // 关注数量
    long followeeCount = followService.findFolloweeCount(userId, ENTITY_TYPE_USER);
    model.addAttribute("followeeCount", followeeCount);

    // 粉丝数量
    long followerCount = followService.findFollowerCount(ENTITY_TYPE_USER, userId);
    model.addAttribute("followerCount", followerCount);

    // 是否已关注
    boolean hasFollowed = false;
    if (hostHolder.getUser() != null) {
        hasFollowed = followService.hasFollowed(hostHolder.getUser().getId(), ENTITY_TYPE_USER, userId);

    }
    model.addAttribute("hasFollowed", hasFollowed);

    return "/site/profile";
}
```

##### 1.4 修改前端界面

修改 profile.js

```js
function follow() {
    var btn = this;
    if ($(btn).hasClass("btn-info")) {
        // 关注TA
        $.post(
            CONTEXT_PATH + "/follow",
            {"entityType": 3, "entityId": $(btn).prev().val()},
            function (data) {
                data = $.parseJSON(data);
                if (data.code === 0) {
                    window.location.reload();
                } else {
                    alert(data.msg);
                }
            }
        );

        // $(btn).text("已关注").removeClass("btn-info").addClass("btn-secondary");
    } else {
        // 取消关注
        $.post(
            CONTEXT_PATH + "/unfollow",
            {"entityType": 3, "entityId": $(btn).prev().val()},
            function (data) {
                data = $.parseJSON(data);
                if (data.code === 0) {
                    window.location.reload();
                } else {
                    alert(data.msg);
                }
            }
        );

        // $(btn).text("关注TA").removeClass("btn-secondary").addClass("btn-info");
    }
}
```

修改 profile.html

```html
<!-- 个人信息 -->
<div class="media mt-5">
    <qiniu th:src="${user.headerUrl}" class="align-self-start mr-4 rounded-circle"
         alt="用户头像" style="width:50px;">
    <div class="media-body">
        <h5 class="mt-0 text-warning">
            <span th:utext="${user.username}">nowcoder</span>
            <input type="hidden" id="entityId" th:value="${user.id}">
            <button type="button"
                    th:class="|btn ${hasFollowed?'btn-secondary':'btn-info'} btn-sm float-right mr-5 follow-btn|"
                    th:text="${hasFollowed?'已关注':'关注TA'}"
                    th:if="${loginUser!=null && loginUser.id!=user.id}">
                关注TA
            </button>
        </h5>
        <div class="text-muted mt-3">
            <span>注册于 <i class="text-muted"
                         th:text="${#dates.format(user.createTime,'yyyy-MM-dd HH:mm:ss')}">2015-06-12 15:20:12</i></span>
        </div>
        <div class="text-muted mt-3 mb-5">
            <span>关注了 <a class="text-primary" href="followee.html" th:text="${followeeCount}">5</a> 人</span>
            <span class="ml-4">关注者 <a class="text-primary" href="follower.html" th:text="${followerCount}">123</a> 人</span>
            <span class="ml-4">获得了 <i class="text-danger" th:text="${likeCount}">87</i> 个赞</span>
        </div>
    </div>
</div>
```

##### 1.5 运行结果

![动画12](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB12.gif)

### 4.6 关注列表、粉丝列表

* 业务层
  * 查询某个用户关注的人，支持分页。
  * 查询某个用户的粉丝，支持分页。
* 表现层
  * 处理“查询关注的人”、“查询粉丝”请求。
  * 编写“查询关注的人”、“查询粉丝”模板。

#### 1、修改 service

修改 FollowService，实现 CommunityConstant 接口，新增方法

```java
// 查询某用户关注的人
public List<Map<String, Object>> findFollowees(int userId, int offset, int limit) {
    String followeeKey = RedisKeyUtil.getFolloweeKey(userId, ENTITY_TYPE_USER);
    Set<Integer> targetIds = redisTemplate.opsForZSet().reverseRange(followeeKey, offset, offset + limit - 1);

    if (targetIds == null) {
        return null;
    }

    List<Map<String, Object>> list = new ArrayList<>();
    for (Integer targetId : targetIds) {
        Map<String, Object> map = new HashMap<>();
        User user = userService.findUserById(targetId);
        map.put("user", user);
        Double score = redisTemplate.opsForZSet().score(followeeKey, targetId);
        map.put("followTime", new Date(score.longValue()));
        list.add(map);
    }

    return list;
}

// 查询某用户的粉丝
public List<Map<String, Object>> findFollowers(int userId, int offset, int limit) {
    String followerKey = RedisKeyUtil.getFollowerKey(ENTITY_TYPE_USER, userId);
    Set<Integer> targetIds = redisTemplate.opsForZSet().reverseRange(followerKey, offset, offset + limit - 1);
    // 虽然Set集合是无序的，但是在此时 Redis 内部将其变成了有序的

    if (targetIds == null) {
        return null;
    }

    List<Map<String, Object>> list = new ArrayList<>();
    for (Integer targetId : targetIds) {
        Map<String, Object> map = new HashMap<>();
        User user = userService.findUserById(targetId);
        map.put("user", user);
        Double score = redisTemplate.opsForZSet().score(followerKey, targetId);
        map.put("followTime", new Date(score.longValue()));
        list.add(map);
    }

    return list;
}
```

#### 2、修改 controller

修改 FollowController

```java
@GetMapping("/followees/{userId}")
public String getFollowees(@PathVariable("userId") int userId, Page page, Model model) {
    User user = userService.findUserById(userId);
    if (user == null) {
        throw new RuntimeException("该用户不存在!");
    }
    model.addAttribute("user", user);

    page.setLimit(5);
    page.setPath("/followees/" + userId);
    page.setRows((int) followService.findFolloweeCount(userId, ENTITY_TYPE_USER));

    List<Map<String, Object>> userList = followService.findFollowees(userId, page.getOffset(), page.getLimit());
    if (userList != null) {
        for (Map<String, Object> map : userList) {
            User u = (User) map.get("user");
            map.put("hasFollowed", hasFollowed(u.getId()));
        }
    }
    model.addAttribute("users", userList);

    return "/site/followee";
}

@GetMapping("/followers/{userId}")
public String getFollowers(@PathVariable("userId") int userId, Page page, Model model) {
    User user = userService.findUserById(userId);
    if (user == null) {
        throw new RuntimeException("该用户不存在!");
    }
    model.addAttribute("user", user);

    page.setLimit(5);
    page.setPath("/followers/" + userId);
    page.setRows((int) followService.findFollowerCount(ENTITY_TYPE_USER, userId));

    List<Map<String, Object>> userList = followService.findFollowers(userId, page.getOffset(), page.getLimit());
    if (userList != null) {
        for (Map<String, Object> map : userList) {
            User u = (User) map.get("user");
            map.put("hasFollowed", hasFollowed(u.getId()));
        }
    }
    model.addAttribute("users", userList);

    return "/site/follower";
}

private boolean hasFollowed(int userId) {
    if (hostHolder.getUser() == null) {
        return false;
    }

    return followService.hasFollowed(hostHolder.getUser().getId(), ENTITY_TYPE_USER, userId);
}
```

#### 3、修改前端界面

修改 profile.html

```html
<div class="text-muted mt-3 mb-5">
    <span>关注了 <a class="text-primary" th:href="@{|/followees/${user.id}|}" th:text="${followeeCount}">5</a> 人</span>
    <span class="ml-4">关注者 <a class="text-primary" th:href="@{|/followers/${user.id}|}" th:text="${followerCount}">123</a> 人</span>
    <span class="ml-4">获得了 <i class="text-danger" th:text="${likeCount}">87</i> 个赞</span>
</div>
```

修改 followee.html

```html
<!-- 内容 -->
<div class="main">
    <div class="container">
        <div class="position-relative">
            <!-- 选项 -->
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <a class="nav-link position-relative active" th:href="@{|/followees/${user.id}|}">
                        <i class="text-info" th:utext="${user.username}">Nowcoder</i> 关注的人</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link position-relative" th:href="@{|/followers/${user.id}|}">关注
                        <i class="text-info" th:utext="${user.username}">Nowcoder</i>的人
                    </a>
                </li>
            </ul>
            <a th:href="@{|/user/profile/${user.id}|}" class="text-muted position-absolute rt-0">返回个人主页&gt;</a>
        </div>

        <!-- 关注列表 -->
        <ul class="list-unstyled">
            <li class="media pb-3 pt-3 mb-3 border-bottom position-relative" th:each="map:${users}">
                <a th:href="@{|/user/profile/${map.user.id}|}">
                    <qiniu th:src="${map.user.headerUrl}" class="mr-4 rounded-circle user-header"
                         alt="用户头像">
                </a>
                <div class="media-body">
                    <h6 class="mt-0 mb-3">
                        <span class="text-success" th:utext="${map.user.username}">落基山脉下的闲人</span>
                        <span class="float-right text-muted font-size-12"
                              th:text="${#dates.format(map.followTime,'yyyy-MM-dd HH:mm:ss')}">关注于 <i>2019-04-28 14:13:25</i></span>
                    </h6>
                    <div>
                        <input type="hidden" id="entityId" th:value="${map.user.id}">
                        <button type="button"
                                th:class="|btn ${map.hasFollowed?'btn-secondary':'btn-info'} btn-sm float-right mr-5 follow-btn|"
                                th:text="${map.hasFollowed?'已关注':'关注TA'}"
                                th:if="${loginUser!=null&&loginUser.id!=map.user.id}">关注TA
                        </button>
                    </div>
                </div>
            </li>
        </ul>
        <!-- 分页 -->
        <nav class="mt-5" th:replace="index::pagination"></nav>
    </div>
</div>
```

修改 follower.html

```html
<!-- 内容 -->
<div class="main">
    <div class="container">
        <div class="position-relative">
            <!-- 选项 -->
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <a class="nav-link position-relative" th:href="@{|/followees/${user.id}|}">
                        <i class="text-info" th:utext="${user.username}">Nowcoder</i> 关注的人
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link position-relative active" th:href="@{|/followers/${user.id}|}">
                        关注 <i class="text-info" th:utext="${user.username}">Nowcoder</i> 的人
                    </a>
                </li>
            </ul>
            <a th:href="@{|/user/profile/${user.id}|}" class="text-muted position-absolute rt-0">返回个人主页&gt;</a>
        </div>

        <!-- 粉丝列表 -->
        <ul class="list-unstyled">
            <li class="media pb-3 pt-3 mb-3 border-bottom position-relative" th:each="map:${users}">
                <a th:href="@{|/user/profile/${map.user.id}|}">
                    <qiniu th:src="${map.user.headerUrl}" class="mr-4 rounded-circle user-header" alt="用户头像">
                </a>
                <div class="media-body">
                    <h6 class="mt-0 mb-3">
                        <span class="text-success" th:utext="${map.user.username}">落基山脉下的闲人</span>
                        <span class="float-right text-muted font-size-12">
                            关注于 <i th:text="${#dates.format(map.followTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-28 14:13:25</i>
                        </span>
                    </h6>
                    <div>
                        <input type="hidden" id="entityId" th:value="${map.user.id}">
                        <button type="button"
                                th:class="|btn ${map.hasFollowed?'btn-secondary':'btn-info'} btn-sm float-right mr-5 follow-btn|"
                                th:text="${map.hasFollowed?'已关注':'关注TA'}"
                                th:if="${loginUser!=null && loginUser.id!=map.user.id}">关注TA
                        </button>
                    </div>
                </div>
            </li>
        </ul>
        <!-- 分页 -->
        <nav class="mt-5" th:replace="index::pagination"></nav>
    </div>
</div>
```

#### 4、运行结果

![动画13](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB13.gif)

### 4.7 优化登录模块

* 使用Redis存储验证码
  * 验证码需要频繁的访问与刷新，对性能要求较高。
  * 验证码不需永久保存，通常在很短的时间后就会失效。
  * 分布式部署时，存在Session共享的问题。
* 使用Redis存储登录凭证
  * 处理每次请求时，都要查询用户的登录凭证，访问的频率非常高。
* 使用Redis缓存用户信息
  * 处理每次请求时，都要根据凭证查询用户信息，访问的频率非常高。

#### 1、使用Redis存储验证码

##### 1.1 修改 util

在 RedisKeyUtil 中新增

```java
private static final String PREFIX_KAPTCHA = "kaptcha";
```

```java
// 登录验证码
public static String getKaptchaKey(String owner) {
    return PREFIX_KAPTCHA + SPLIT + owner;
}
```

##### 1.2 修改 controller

修改 LoginController 中的两个方法

```java
@GetMapping("/kaptcha")
    public void getKaptcha(httpervletResponse response/*, httpession session*/) {
        // 生成验证码
        String text = kaptchaProducer.createText();
        BufferedImage image = kaptchaProducer.createImage(text);

        // 将验证码存入session
//        session.setAttribute("kaptcha", text);

        // 验证码的归属
        String kaptchaOwner = CommunityUtil.generateUUID();
        Cookie cookie = new Cookie("kaptchaOwner", kaptchaOwner);
        cookie.setMaxAge(60);
        cookie.setPath(contextPath);
        response.addCookie(cookie);
        // 将验证码存入Redis
        String redisKey = RedisKeyUtil.getKaptchaKey(kaptchaOwner);
        redisTemplate.opsForValue().set(redisKey, text, 60, TimeUnit.SECONDS);

        // 将图片输出给浏览器
        response.setContentType("image/png");
        try {
            OutputStream os = response.getOutputStream();
            ImageIO.write(image, "png", os);
        } catch (IOException e) {
            logger.error("响应验证码失败" + e.getMessage());
        }
    }

    @PostMapping("/login")
    public String login(String username, String password, String code, boolean rememberMe,
                        Model model/*, httpession session*/, httpervletResponse response,
                        @CookieValue(value = "kaptchaOwner") String kaptchaOwner) {
        // 检查验证码
//        String kaptcha = (String) session.getAttribute("kaptcha");

        String kaptcha = null;
        if (StringUtils.isNotBlank(kaptchaOwner)) {
            String redisKey = RedisKeyUtil.getKaptchaKey(kaptchaOwner);
            kaptcha = (String) redisTemplate.opsForValue().get(redisKey);
        }

        if (StringUtils.isBlank(kaptcha) || StringUtils.isBlank(code) || !kaptcha.equalsIgnoreCase(code)) {
            model.addAttribute("codeMsg", "验证码不正确");
            return "/site/login";
        }

        // 检查账号,密码
        int expireSeconds = rememberMe ? REMEMBER_EXPIRED_SECONDS : DEFAULT_EXPIRED_SECONDS;
        Map<String, Object> map = userService.login(username, password, expireSeconds);
        if (map.containsKey("ticket")) {
            Cookie cookie = new Cookie("ticket", map.get("ticket").toString());
            cookie.setPath(contextPath);
            cookie.setMaxAge(expireSeconds);
            response.addCookie(cookie);

            return "redirect:/index";
        } else {
            model.addAttribute("usernameMsg", map.get("usernameMsg"));
            model.addAttribute("passwordMsg", map.get("passwordMsg"));

            return "/site/login";
        }
    }
```

##### 1.3 运行结果

![动画14](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB14.gif)

#### 2、使用Redis存储登录凭证

##### 2.1 修改 util 

在 RedisKeyUtil 中新增

```java
private static final String PREFIX_TICKET = "ticket";
```

```java
// 登录的凭证
public static String getTicketKey(String ticket) {
    return PREFIX_TICKET + SPLIT + ticket;
}
```

##### 2.2 修改 mapper

在 LoginTicketMapper中添加注解，代表不使用了

```java
@Deprecated
```

##### 2.3 修改 service

修改 UserService，注释掉 LoginTicketMapper，新注入 RedisTemplate

```java
//    @Resource
//    private LoginTicketMapper loginTicketMapper;

    @Resource
    private RedisTemplate redisTemplate;
```

修改 login() 、logout() 、findLoginTicket() 方法

```java
        // 生成登录凭证
        LoginTicket loginTicket = new LoginTicket();
        loginTicket.setUserId(user.getId());
        loginTicket.setTicket(CommunityUtil.generateUUID());
        loginTicket.setStatus(0);
        loginTicket.setExpired(new Date(System.currentTimeMillis() + expireSeconds * 1000));
//        loginTicketMapper.insertLoginTicket(loginTicket);

        String redisKey = RedisKeyUtil.getTicketKey(loginTicket.getTicket());
        redisTemplate.opsForValue().set(redisKey, loginTicket);
```

```java
    public void logout(String ticket) {
//        loginTicketMapper.updateStatus(ticket, 1);
        String redisKey = RedisKeyUtil.getTicketKey(ticket);
        LoginTicket loginTicket = (LoginTicket) redisTemplate.opsForValue().get(redisKey);
        loginTicket.setStatus(1);
        redisTemplate.opsForValue().set(redisKey, loginTicket);
    }

    public LoginTicket findLoginTicket(String ticket) {
//        return loginTicketMapper.selectByTicket(ticket);
        String redisKey = RedisKeyUtil.getTicketKey(ticket);
        return (LoginTicket) redisTemplate.opsForValue().get(redisKey);
    }
```

#### 3、使用Redis缓存用户信息

##### 3.1 修改 util

修改 RedisKeyUtil

```java
private static final String PREFIX_USER = "user";
```

```java
// 用户
public static String getUserKey(int userId) {
    return PREFIX_USER + SPLIT + userId;
}
```

##### 3.2 修改service

修改 UserService，新增方法

```java
// 1.优先从缓存中取值
private User getCache(int userId) {
    String redisKey = RedisKeyUtil.getUserKey(userId);
    return (User) redisTemplate.opsForValue().get(redisKey);
}

// 2.取不到时初始化缓存数据
private User initCache(int userId) {
    User user = userMapper.selectById(userId);
    String redisKey = RedisKeyUtil.getUserKey(userId);
    redisTemplate.opsForValue().set(redisKey, user, 3600, TimeUnit.SECONDS);
    return user;
}

// 3.数据变更时清除缓存数据
private void clearCache(int userId) {
    String redisKey = RedisKeyUtil.getUserKey(userId);
    redisTemplate.delete(redisKey);
}
```

修改 findUserById() 方法

```java
    public User findUserById(int id) {
//        return userMapper.selectById(id);
        User user = getCache(id);
        if (user == null) {
            user = initCache(id);
        }
        return user;
    }
```

修改 activation() 方法

```java
public int activation(int userId, String code) {
    User user = userMapper.selectById(userId);
    if (user.getStatus() == 1) {
        return ACTIVATION_REPEAT;
    } else if (user.getActivationCode().equals(code)) {
        userMapper.updateStatus(userId, 1);
        clearCache(userId);
        return ACTIVATION_SUCCESS;
    } else {
        return ACTIVATION_FAILURE;
    }
}
```

修改 updateHeader() 方法

```java
    public int updateHeader(int userId, String headerUrl) {
//        return userMapper.updateHeader(userId, headerUrl);
        int rows = userMapper.updateHeader(userId, headerUrl);
        clearCache(userId);
        return rows;
    }
```

修改 updatePassword() 方法

```java
public Map<String, Object> updatePassword(String password, String newPassword, int id) {
    Map<String, Object> map = new HashMap<>();
    User user = userMapper.selectById(id);
    password = CommunityUtil.md5(password + user.getSalt());
    if (!user.getPassword().equals(password)) {
        map.put("passwordMsg", "输入密码错误！");
        return map;
    } else {
        //注意：存入新密码要以加密后的形式存进去
        newPassword = CommunityUtil.md5(newPassword + user.getSalt());
        userMapper.updatePassword(id, newPassword);
    }

    clearCache(user.getId());
    return map;
}
```

##### 3.3 运行结果

![image-20220718102257875](http://qiniu.dyl.fit/Interview/image-20220718102257875.png)

## 第5章 Kafka，构建TB级异步消息系统

### 5.1 阻塞队列

* BlockingQueue
  * 解决线程通信的问题。
  * 阻塞方法：put、take。

![avatar](http://qiniu.dyl.fit/Interview/20191114195406.png)

* 生产者消费者模式
  * 生产者：产生数据的线程。
  * 消费者：使用数据的线程。

* 实现类
  * ArrayBlockingQueue
  * LinkedBlockingQueue
  * PriorityBlockingQueue、SynchronousQueue、DelayQueue等。

创建测试类 BlockingQueueTest

```java
class BlockingQueueTest {

    public static void main(String[] args) {

        BlockingQueue queue = new ArrayBlockingQueue<>(10);
        new Thread(new Producer(queue)).start();
        new Thread(new Consumer(queue)).start();
        new Thread(new Consumer(queue)).start();
        new Thread(new Consumer(queue)).start();
    }
}

class Producer implements Runnable {

    private BlockingQueue<Integer> queue;

    public Producer(BlockingQueue<Integer> queue) {
        this.queue = queue;
    }

    @Override
    public void run() {
        try {
            for (int i = 0; i < 100; i++) {
                Thread.sleep(20);
                queue.put(i);
                System.out.println(Thread.currentThread().getName() + "生产:" + queue.size());
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}

class Consumer implements Runnable {

    private BlockingQueue<Integer> queue;

    public Consumer(BlockingQueue<Integer> queue) {
        this.queue = queue;
    }

    @Override
    public void run() {
        try {
            while (true) {
                Thread.sleep(new Random().nextInt(1000));
                queue.take();
                System.out.println(Thread.currentThread().getName() + "消费:" + queue.size());
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 5.2 Kafka入门

#### 1、Kafka简介

* Kafka是一个分布式的流媒体平台。
* 应用：消息系统、日志收集、用户行为追踪、流式处理。

#### 2、Kafka特点

高吞吐量、消息持久化、高可靠性、高扩展性。

#### 3、Kafka术语

* Broker、Zookeeper
* Topic、Partition、Offset
* Leader Replica 、Follower Replica

#### 4、配置 Kafka

配置 zookeeper.properties

```properties
dataDir=D:/Learn/data/zookeeper
```

配置 server.properties

```properties
listeners=PLAINTEXT://127.0.0.1:9092

log.dirs=D:\Learn\log\data\kafka-logs
```

运行

![Snipaste_2022-07-07_19-24-17](http://qiniu.dyl.fit/Interview/Snipaste_2022-07-07_19-24-17.png)

![Snipaste_2022-07-07_19-24-01](http://qiniu.dyl.fit/Interview/Snipaste_2022-07-07_19-24-01.png)

### 5.3 Spring整合Kafka

* 引入依赖
  * spring-kafka
* 配置Kafka
  * 配置server、consumer
* 访问Kafka
  * 生产者
    kafkaTemplate.send(topic, data);
  * 消费者
    @KafkaListener(topics = {"test"})
    public void handleMessage(ConsumerRecord record) {}

#### 1、引入依赖

```xml
<!-- http://mvnrepository.com/artifact/org.springframework.kafka/spring-kafka -->
<dependency>
    <groupId>org.springframework.kafka</groupId>
    <artifactId>spring-kafka</artifactId>
</dependency>
```

#### 2、配置Kafka

```yaml
spring: 
    # KafkaProperties
    kafka:
      bootstrap-servers: localhost:9092
      consumer:
        auto-commit-interval: 3000
        enable-auto-commit: true
        group-id: test-consumer-group
      listener:
        missing-topics-fatal: false
```

#### 3、访问Kafka

新建测试类 KafkaTest

```java
@SpringBootTest
class KafkaTest {

    @Resource
    private KafkaProducer kafkaProducer;

    @Test
    void testKafka() {
        kafkaProducer.sendMessage("test", "你好");
        kafkaProducer.sendMessage("test", "在吗");

        try {
            Thread.sleep(1000 * 10);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }

}

@Component
class KafkaProducer {

    @Resource
    private KafkaTemplate kafkaTemplate;

    public void sendMessage(String topic, String content) {
        kafkaTemplate.send(topic, content);
    }

}

@Component
class KafkaConsumer {

    @KafkaListener(topics = {"test"})
    public void handleMessage(ConsumerRecord record) {
        System.out.println(record.value());
    }
}
```



### 5.4 发送系统通知

* 触发事件
  * 评论后，发布通知
  * 点赞后，发布通知
  * 关注后，发布通知
* 处理事件
  * 封装事件对象
  * 开发事件的生产者
  * 开发事件的消费者

#### 1、实现步骤

##### 1.1 新增实体类

```java
public class Event {

    private String topic;
    private int userId;
    private int entityType;
    private int entityId;
    private int entityUserId;
    private Map<String, Object> data = new HashMap<>();

    public String getTopic() {
        return topic;
    }

    public Event setTopic(String topic) {
        this.topic = topic;
        return this;
    }

    public int getUserId() {
        return userId;
    }

    public Event setUserId(int userId) {
        this.userId = userId;
        return this;
    }

    public int getEntityType() {
        return entityType;
    }

    public Event setEntityType(int entityType) {
        this.entityType = entityType;
        return this;
    }

    public int getEntityId() {
        return entityId;
    }

    public Event setEntityId(int entityId) {
        this.entityId = entityId;
        return this;
    }

    public int getEntityUserId() {
        return entityUserId;
    }

    public Event setEntityUserId(int entityUserId) {
        this.entityUserId = entityUserId;
        return this;
    }

    public Map<String, Object> getData() {
        return data;
    }

    public Event setData(String key, Object value) {
        this.data.put(key, value);
        return this;
    }
}
```

##### 1.2 新建事件

先在 CommunityConstant 中新增常量

```java
    /**
     * 主题: 评论
     */
    String TOPIC_COMMENT = "comment";

    /**
     * 主题: 点赞
     */
    String TOPIC_LIKE = "like";

    /**
     * 主题: 关注
     */
    String TOPIC_FOLLOW = "follow";

    /**
     * 主题：发帖
     */
    String TOPIC_PUBLISH = "publish";

    /**
     * 系统用户ID
     */
    int SYSTEM_USER_ID = 1;
}
```

新建一个event包，并在包内新建 EventProducer和EventConsumer类

```java
@Component
public class EventProducer {

    @Resource
    private KafkaTemplate kafkaTemplate;

    // 处理事件
    public void fireEvent(Event event) {
        // 将事件发布到指定的主题
        kafkaTemplate.send(event.getTopic(), JSONObject.toJSONString(event));
    }
}
```

```java
@Component
public class EventConsumer implements CommunityConstant {
    private static final Logger logger = LoggerFactory.getLogger(EventConsumer.class);

    @Resource
    private MessageService messageService;

    @KafkaListener(topics = {TOPIC_COMMENT, TOPIC_LIKE, TOPIC_FOLLOW})
    public void handleCommentMessage(ConsumerRecord record) {
        if (record == null || record.value() == null) {
            logger.error("消息的内容为空!");
            return;
        }

        Event event = JSONObject.parseObject(record.value().toString(), Event.class);
        if (event == null) {
            logger.error("消息格式错误!");
            return;
        }

        // 发送站内通知
        Message message = new Message();
        message.setFromId(SYSTEM_USER_ID);
        message.setToId(event.getEntityUserId());
        message.setConversationId(event.getTopic());
        message.setCreateTime(new Date());

        Map<String, Object> content = new HashMap<>();
        content.put("userId", event.getUserId());
        content.put("entityType", event.getEntityType());
        content.put("entityId", event.getEntityId());

        if (!event.getData().isEmpty()) {
            for (Map.Entry<String, Object> entry : event.getData().entrySet()) {
                content.put(entry.getKey(), entry.getValue());
            }
        }

        message.setContent(JSONObject.toJSONString(content));
        messageService.addMessage(message);
    }
}
```

##### 1.3 修改业务层

在CommentMapper中新增方法

```java
Comment selectCommentById(int id);
```

配置相应的sql语句

```xml
<select id="selectCommentById" resultType="Comment">
    select
    <include refid="selectFields"/>
    from comment where id = #{id}
</select>
```

在 CommentService 新增方法

```java
public Comment findCommentById(int id) {
    return commentMapper.selectCommentById(id);
}
```

在 CommentController 中注入 EventProducer 和 DiscussPostService

```java
@Resource
private EventProducer eventProducer;

@Resource
private DiscussPostService discussPostService;
```

新增评论事件

```java
@PostMapping("/add/{discussPostId}")
public String addComment(@PathVariable("discussPostId") int discussPostId, Comment comment) {
    comment.setUserId(hostHolder.getUser().getId());
    comment.setStatus(0);
    comment.setCreateTime(new Date());
    commentService.addComment(comment);

    //触发评论事件
    Event event = new Event()
            .setTopic(TOPIC_COMMENT)
            .setUserId(hostHolder.getUser().getId())
            .setEntityType(comment.getEntityType())
            .setEntityId(comment.getEntityId())
            .setData("postId", discussPostId);
    if (comment.getEntityType() == ENTITY_TYPE_POST) {
        DiscussPost target = discussPostService.findDiscussPostById(comment.getEntityId());
        event.setEntityUserId(target.getUserId());
    } else if (comment.getEntityType() == ENTITY_TYPE_COMMENT) {
        Comment target = commentService.findCommentById(comment.getEntityId());
        event.setEntityUserId(target.getUserId());
    }
    eventProducer.fireEvent(event);

    if (comment.getEntityType() == ENTITY_TYPE_POST) {
        // 触发发帖事件
        event = new Event()
                .setTopic(TOPIC_PUBLISH)
                .setUserId(comment.getUserId())
                .setEntityType(ENTITY_TYPE_POST)
                .setEntityId(discussPostId);
        eventProducer.fireEvent(event);
    }

    return "redirect:/discuss/detail/" + discussPostId;
}
```

在 FollowController 中

注入 EventProducer

```java
@Resource
private EventProducer eventProducer;
```

新增关注事件

```java
@PostMapping("/follow")
@ResponseBody
public String follow(int entityType, int entityId) {
    User user = hostHolder.getUser();

    followService.follow(user.getId(), entityType, entityId);

    // 触发关注事件
    Event event = new Event()
            .setTopic(TOPIC_FOLLOW)
            .setUserId(hostHolder.getUser().getId())
            .setEntityType(entityType)
            .setEntityId(entityId)
            .setEntityUserId(entityId);
    eventProducer.fireEvent(event);

    return CommunityUtil.getJSONString(0, "已关注");
}
```

在 LikeController 中

新增一个 postId 参数和点赞事件

```java
@PostMapping("/like")
@ResponseBody
public String like(int entityType, int entityId, int entityUserId, int postId) {
    User user = hostHolder.getUser();

    // 点赞
    likeService.like(user.getId(), entityType, entityId, entityUserId);
    // 数量
    long likeCount = likeService.findEntityLikeCount(entityType, entityId);
    // 状态
    int likeStatus = likeService.findEntityLikeStatus(user.getId(), entityType, entityId);
    // 返回结果
    Map<String, Object> map = new HashMap<>();
    map.put("likeCount", likeCount);
    map.put("likeStatus", likeStatus);

    // 触发点赞事件
    if (likeStatus == 1) {
        Event event = new Event()
                .setTopic(TOPIC_LIKE)
                .setUserId(hostHolder.getUser().getId())
                .setEntityType(entityType)
                .setEntityId(entityId)
                .setEntityUserId(entityUserId)
                .setData("postId", postId);
        eventProducer.fireEvent(event);
    }

    return CommunityUtil.getJSONString(0, null, map);
}
```

修改相应的 discuss.js 文件

```js
function like(btn, entityType, entityId, entityUserId, postId) {
    $.post(
        CONTEXT_PATH + "/like",
        {"entityType": entityType, "entityId": entityId, "entityUserId": entityUserId, "postId": postId},
        function (data) {
            data = $.parseJSON(data);
            if (data.code === 0) {
                $(btn).children("i").text(data.likeCount);
                $(btn).children("b").text(data.likeStatus === 1 ? '已赞' : "赞");
            } else {
                alert(data.msg);
            }
        }
    );
}
```

修改相应的 discuss-detail.html

```html
<a href="javascript:;" th:onclick="|like(this,1,${post.id},${post.userId},${post.id});|"
   class="text-primary"><b th:text="${likeStatus==1?'已赞':'赞'}">赞</b> 
    <i th:text="${likeCount}">11</i>
</a>
```

```html
<a href="javascript:;" th:onclick="|like(this,2,${cvo.comment.id},${cvo.comment.userId},${post.id});|"
   class="text-primary">
    <b th:text="${cvo.likeStatus==1?'已赞':'赞'}">赞</b>(
    <i th:text="${cvo.likeCount}">1</i>)
</a>
```

```html
<a href="javascript:;" th:onclick="|like(this,2,${rvo.reply.id},,${rvo.reply.userId},${post.id});|"
   class="text-primary">
    <b th:text="${rvo.likeStatus==1?'已赞':'赞'}">赞</b>(
    <i th:text="${rvo.likeCount}">1</i>)
</a>
```

##### 1.4 运行结果

![动画15](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB15.gif)

### 5.5 显示系统通知

* 通知列表
  * 显示评论、点赞、关注三种类型的通知
* 通知详情
  * 分页显示某一类主题所包含的通知
* 未读消息
  * 在页面头部显示所有的未读消息数量

#### 1、显示未读数量

##### 1.1 修改mapper

在 MessageMapper 中添加方法

```java
// 查询某个主题下最新的通知
Message selectLatestNotice(int userId, String topic);

// 查询某个主题所包含的通知数量
int selectNoticeCount(int userId, String topic);

// 查询未读的通知的数量
int selectNoticeUnreadCount(int userId, String topic);
```

配置相应的sql 语句

```xml
<select id="selectLatestNotice" resultType="Message">
    select
    <include refid="selectFields"/>
    from message
    where id in(
    select max(id) from message
    where status != 2
    and from_id = 1
    and to_id = #{userId}
    and conversation_id = #{topic}
    )
</select>

<select id="selectNoticeCount" resultType="int">
    select count(id)
    from message
    where status != 2
      and from_id = 1
      and to_id = #{userId}
      and conversation_id = #{topic}
</select>

<select id="selectNoticeUnreadCount" resultType="int">
    select count(id)
    from message
    where status = 0
    and from_id = 1
    and to_id = #{userId}
    <if test="topic!=null">
        and conversation_id = #{topic}
    </if>
</select>
```

##### 1.2 修改service

在 MessageService 中添加方法

```java
public Message findLatestNotice(int userId, String topic) {
    return messageMapper.selectLatestNotice(userId, topic);
}

public int findNoticeCount(int userId, String topic) {
    return messageMapper.selectNoticeCount(userId, topic);
}

public int findNoticeUnreadCount(int userId, String topic) {
    return messageMapper.selectNoticeUnreadCount(userId, topic);
}
```

##### 1.3 修改controller

在 MessageController 中实现 CommunityConstant 接口

添加方法

```java
@GetMapping("/notice/list")
public String getNoticeList(Model model) {
    User user = hostHolder.getUser();

    // 查询评论类通知
    Message message = messageService.findLatestNotice(user.getId(), TOPIC_COMMENT);

    if (message != null) {
        HashMap<String, Object> messageVO = new HashMap<>();
        messageVO.put("message", message);

        String content = HtmlUtils.htmlUnescape(message.getContent());
        Map<String, Object> data = JSONObject.parseObject(content, HashMap.class);

        messageVO.put("user", userService.findUserById((Integer) data.get("userId")));
        messageVO.put("entityType", data.get("entityType"));
        messageVO.put("entityId", data.get("entityId"));
        messageVO.put("postId", data.get("postId"));

        int count = messageService.findNoticeCount(user.getId(), TOPIC_COMMENT);
        messageVO.put("count", count);

        int unread = messageService.findNoticeUnreadCount(user.getId(), TOPIC_COMMENT);
        messageVO.put("unread", unread);
        model.addAttribute("commentNotice", messageVO);
    }

    // 查询点赞类通知
    message = messageService.findLatestNotice(user.getId(), TOPIC_LIKE);

    if (message != null) {
        HashMap<String, Object> messageVO = new HashMap<>();
        messageVO.put("message", message);

        String content = HtmlUtils.htmlUnescape(message.getContent());
        Map<String, Object> data = JSONObject.parseObject(content, HashMap.class);

        messageVO.put("user", userService.findUserById((Integer) data.get("userId")));
        messageVO.put("entityType", data.get("entityType"));
        messageVO.put("entityId", data.get("entityId"));
        messageVO.put("postId", data.get("postId"));

        int count = messageService.findNoticeCount(user.getId(), TOPIC_LIKE);
        messageVO.put("count", count);

        int unread = messageService.findNoticeUnreadCount(user.getId(), TOPIC_LIKE);
        messageVO.put("unread", unread);
        model.addAttribute("likeNotice", messageVO);
    }

    // 查询关注类通知
    message = messageService.findLatestNotice(user.getId(), TOPIC_FOLLOW);
    if (message != null) {
        HashMap<String, Object> messageVO = new HashMap<>();
        messageVO.put("message", message);

        String content = HtmlUtils.htmlUnescape(message.getContent());
        Map<String, Object> data = JSONObject.parseObject(content, HashMap.class);

        messageVO.put("user", userService.findUserById((Integer) data.get("userId")));
        messageVO.put("entityType", data.get("entityType"));
        messageVO.put("entityId", data.get("entityId"));
        //去掉了postId,用不着

        int count = messageService.findNoticeCount(user.getId(), TOPIC_FOLLOW);
        messageVO.put("count", count);

        int unread = messageService.findNoticeUnreadCount(user.getId(), TOPIC_FOLLOW);
        messageVO.put("unread", unread);
        model.addAttribute("followNotice", messageVO);
    }


    // 查询未读消息数量
    int letterUnreadCount = messageService.findLetterUnreadCount(user.getId(), null);
    model.addAttribute("letterUnreadCount", letterUnreadCount);
    int noticeUnreadCount = messageService.findNoticeUnreadCount(user.getId(), null);
    model.addAttribute("noticeUnreadCount", noticeUnreadCount);

    return "/site/notice";

}
```

##### 1.4 修改前端界面

修改letter.html

```html
<li class="nav-item">
    <a class="nav-link position-relative"
       th:href="@{/notice/list}">系统通知<span
            class="badge badge-danger" th:text="${noticeUnreadCount}"
            th:if="${noticeUnreadCount!=0}">27</span></a>
</li>
```

修改notice.html

引入thymeleaf然后修改内容部分的代码

```html
<div class="main">
    <div class="container">
        <div class="position-relative">
            <!-- 选项 -->
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <a class="nav-link position-relative" th:href="@{/letter/list}">
                        朋友私信
                        <span class="badge badge-danger"
                              th:text="${letterUnreadCount}"
                              th:if="${letterUnreadCount!=0}">3
                        </span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link position-relative active" th:href="@{/notice/list}">
                        系统通知
                        <span class="badge badge-danger"
                              th:text="${noticeUnreadCount}"
                              th:if="${noticeUnreadCount!=0}">27
                        </span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- 通知列表 -->
        <ul class="list-unstyled">
            <!--评论类通知-->
            <li class="media pb-3 pt-3 mb-3 border-bottom position-relative" th:if="${commentNotice!=null}">
                <span class="badge badge-danger"
                      th:text="${commentNotice.unread!=0?commentNotice.unread:''}">3</span>
                <qiniu src="http://static.nowcoder.com/images/head/reply.png" class="mr-4 user-header" alt="通知图标">
                <div class="media-body">
                    <h6 class="mt-0 mb-3">
                        <span>评论</span>
                        <span class="float-right text-muted font-size-12"
                              th:text="${#dates.format(commentNotice.message.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-28 14:13:25</span>
                    </h6>
                    <div>
                        <a href="#">
                            用户
                            <i th:utext="${commentNotice.user.username}">nowcoder</i>
                            评论了你的<b th:text="${commentNotice.entityType==1?'帖子':'回复'}">帖子</b> ...</a>
                        <ul class="d-inline font-size-12 float-right">
                            <li class="d-inline ml-2"><span class="text-primary">共 <i
                                    th:text="${commentNotice.count}">3</i> 条会话</span></li>
                        </ul>
                    </div>
                </div>
            </li>
            <li class="media pb-3 pt-3 mb-3 border-bottom position-relative" th:if="${likeNotice!=null}">
                <span class="badge badge-danger" th:text="${likeNotice.unread!=0?likeNotice.unread:''}">3</span>
                <qiniu src="http://static.nowcoder.com/images/head/like.png" class="mr-4 user-header" alt="通知图标">
                <div class="media-body">
                    <h6 class="mt-0 mb-3">
                        <span>赞</span>
                        <span class="float-right text-muted font-size-12"
                              th:text="${#dates.format(likeNotice.message.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-28 14:13:25</span>
                    </h6>
                    <div>
                        <a href="#">
                            用户
                            <i th:utext="${likeNotice.user.username}">nowcoder</i>
                            点赞了你的<b th:text="${likeNotice.entityType==1?'帖子':'回复'}">帖子</b> ...</a>
                        <ul class="d-inline font-size-12 float-right">
                            <li class="d-inline ml-2"><span class="text-primary">共 <i th:text="${likeNotice.count}">3</i> 条会话</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </li>
            <!--关注类通知-->
            <li class="media pb-3 pt-3 mb-3 border-bottom position-relative" th:if="${followNotice!=null}">
                <span class="badge badge-danger" th:text="${followNotice.unread!=0?followNotice.unread:''}">3</span>
                <qiniu src="http://static.nowcoder.com/images/head/follow.png" class="mr-4 user-header" alt="通知图标">
                <div class="media-body">
                    <h6 class="mt-0 mb-3">
                        <span>关注</span>
                        <span class="float-right text-muted font-size-12"
                              th:text="${#dates.format(followNotice.message.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-28 14:13:25</span>
                    </h6>
                    <div>
                        <a href="#">
                            用户
                            <i th:utext="${followNotice.user.username}">nowcoder</i> 关注了你 ...</a>
                        <ul class="d-inline font-size-12 float-right">
                            <li class="d-inline ml-2"><span class="text-primary">共 <i
                                    th:text="${followNotice.count}">3</i> 条会话</span></li>
                        </ul>
                    </div>
                </div>
            </li>
        </ul>
    </div>
</div>
```

#### 2、开发未读详情

##### 2.1 修改 mapper

在 MessageMapper 中添加方法

```java
// 查询某个主题所包含的通知列表
List<Message> selectNotices(int userId, String topic, int offset, int limit);
```

配置相应的 sql 语句

```xml
<select id="selectNotices" resultType="Message">
    select
    <include refid="selectFields"/>
    from message
    where status != 2
    and from_id = 1
    and to_id = #{userId}
    and conversation_id = #{topic}
    order by create_time desc
    limit #{offset}, #{limit}
</select>
```

##### 2.2 修改 service

在 MessageService 中添加方法

```java
public List<Message> findNotices(int userId, String topic, int offset, int limit) {
    return messageMapper.selectNotices(userId, topic, offset, limit);
}
```

##### 2.3 修改 controller

在 MessageController 中添加方法

```java
@GetMapping("/notice/detail/{topic}")
public String getNoticeDetail(@PathVariable("topic") String topic, Page page, Model model) {
    User user = hostHolder.getUser();

    page.setLimit(5);
    page.setPath("/notice/detail/" + topic);
    page.setRows(messageService.findNoticeCount(user.getId(), topic));

    List<Message> noticeList = messageService.findNotices(user.getId(), topic, page.getOffset(), page.getLimit());
    List<Map<String, Object>> noticeVoList = new ArrayList<>();
    if (noticeList != null) {
        for (Message notice : noticeList) {
            Map<String, Object> map = new HashMap<>();
            // 通知
            map.put("notice", notice);
            // 内容
            String content = HtmlUtils.htmlUnescape(notice.getContent());
            Map<String, Object> data = JSONObject.parseObject(content, HashMap.class);
            map.put("user", userService.findUserById((Integer) data.get("userId")));
            map.put("entityType", data.get("entityType"));
            map.put("entityId", data.get("entityId"));
            map.put("postId", data.get("postId"));
            // 通知作者
            map.put("fromUser", userService.findUserById(notice.getFromId()));

            noticeVoList.add(map);
        }
    }
    model.addAttribute("notices", noticeVoList);

    // 设置已读
    List<Integer> ids = getLetterIds(noticeList);
    if (!ids.isEmpty()) {
        messageService.readMessage(ids);
    }

    return "/site/notice-detail";
}
```

修改方法

```java
// 私信列表
    @GetMapping("/letter/list")
    public String getLetterList(Model model, Page page) {
        // 测试500错误
//        Integer.valueOf("abc");

        User user = hostHolder.getUser();
        // 分页信息
        page.setLimit(5);
        page.setPath("/letter/list");
        page.setRows(messageService.findConversationCount(user.getId()));

        // 会话列表
        List<Message> conversationList = messageService.findConversations(
                user.getId(), page.getOffset(), page.getLimit());
        List<Map<String, Object>> conversations = new ArrayList<>();
        if (conversationList != null) {
            for (Message message : conversationList) {
                Map<String, Object> map = new HashMap<>();
                map.put("conversation", message);
                map.put("letterCount", messageService.findLetterCount(message.getConversationId()));
                map.put("unreadCount", messageService.findLetterUnreadCount(user.getId(), message.getConversationId()));
                int targetId = user.getId() == message.getFromId() ? message.getToId() : message.getFromId();
                map.put("target", userService.findUserById(targetId));

                conversations.add(map);
            }
        }
        model.addAttribute("conversations", conversations);

        // 查询未读消息数量
        int letterUnreadCount = messageService.findLetterUnreadCount(user.getId(), null);
        model.addAttribute("letterUnreadCount", letterUnreadCount);

        int noticeUnreadCount = messageService.findNoticeUnreadCount(user.getId(), null);
        model.addAttribute("noticeUnreadCount", noticeUnreadCount);


        return "/site/letter";
    }
```

##### 2.4 修改前端界面

修改 notice.html

```html
<a th:href="@{/notice/detail/comment}">
    用户
    <i th:utext="${commentNotice.user.username}">nowcoder</i>
    评论了你的<b th:text="${commentNotice.entityType==1?'帖子':'回复'}">帖子</b> ...</a>
```

```html
<a th:href="@{/notice/detail/like}">
    用户
    <i th:utext="${likeNotice.user.username}">nowcoder</i>
    点赞了你的<b th:text="${likeNotice.entityType==1?'帖子':'回复'}">帖子</b> ...</a>
```

```html
<a th:href="@{/notice/detail/follow}">
    用户
    <i th:utext="${followNotice.user.username}">nowcoder</i> 关注了你 ...</a>
```

修改 notice-detail.html

引入thymeleaf，添加js代码

```html
<script>
    function back() {
        location.href = CONTEXT_PATH + "/notice/list";
    }
</script>
```

修改内容部分代码

```html
<!-- 内容 -->
<div class="main">
    <div class="container">
        <div class="row">
            <div class="col-8">
                <h6><b class="square"></b> 系统通知</h6>
            </div>
            <div class="col-4 text-right">
                <button type="button" class="btn btn-secondary btn-sm" onclick="back()">返回
                </button>
            </div>
        </div>

        <!-- 通知列表 -->
        <ul class="list-unstyled mt-4">
            <li class="media pb-3 pt-3 mb-2" th:each="map:${notices}">
                <qiniu th:src="${map.fromUser.headerUrl}" class="mr-4 rounded-circle user-header"
                     alt="系统图标">
                <div class="toast show d-lg-block" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <strong class="mr-auto" th:utext="${map.fromUser.username}">落基山脉下的闲人</strong>
                        <small th:text="${#dates.format(map.notice.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-25
                            15:49:32</small>
                        <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="toast-body">
                        <span th:if="${topic.equals('comment')}">
                            用户
                            <i th:utext="${map.user.username}">nowcoder</i>
                            评论了你的<b th:text="${map.entityType==1?'帖子':'回复'}">帖子</b>,
                            <a class="text-primary" th:href="@{|/discuss/detail/${map.postId}|}">点击查看</a> !
                        </span>
                        <span th:if="${topic.equals('like')}">
                            用户
                            <i th:utext="${map.user.username}">nowcoder</i>
                            点赞了你的<b th:text="${map.entityType==1?'帖子':'回复'}">帖子</b>,
                            <a class="text-primary" th:href="@{|/discuss/detail/${map.postId}|}">点击查看</a> !
                        </span>
                        <span th:if="${topic.equals('follow')}">
                            用户
                            <i th:utext="${map.user.username}">nowcoder</i>
                            关注了你,
                            <a class="text-primary" th:href="@{|/user/profile/${map.user.id}|}">点击查看</a> !
                        </span>
                    </div>
                </div>
            </li>
        </ul>
        <!-- 分页 -->
        <nav class="mt-5" th:replace="index::pagination"></nav>
    </div>
</div>
```

#### 3、头部显示总未读数量

##### 3.1 创建拦截器

在 interceptor 中新建 MessageInterceptor

```java
@Component
public class MessageInterceptor implements HandlerInterceptor {

    @Resource
    private HostHolder hostHolder;

    @Resource
    private MessageService messageService;

    @Override
    public void postHandle(httpervletRequest request, httpervletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        User user = hostHolder.getUser();
        if (user != null && modelAndView != null) {
            int letterUnreadCount = messageService.findLetterUnreadCount(user.getId(), null);
            int noticeUnreadCount = messageService.findNoticeUnreadCount(user.getId(), null);
            modelAndView.addObject("allUnreadCount", letterUnreadCount + noticeUnreadCount);
        }
    }
}
```

##### 3.2 配置拦截器

修改 WebMvcConfig

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    @Resource
    private AlphaInterceptor alphaInterceptor;

    @Resource
    private LoginTicketInterceptor loginTicketInterceptor;

    @Resource
    private LoginRequiredInterceptor loginRequiredInterceptor;

    @Resource
    private MessageInterceptor messageInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(alphaInterceptor)
                .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg")
                .addPathPatterns("/register", "/login");

        registry.addInterceptor(loginTicketInterceptor)
                .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg");

        registry.addInterceptor(loginRequiredInterceptor)
                .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg");

        registry.addInterceptor(messageInterceptor)
                .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg");
    }
}
```

##### 3.3 修改前端界面

修改 index.html

```html
<li class="nav-item ml-3 btn-group-vertical" th:if="${loginUser!=null}">
    <a class="nav-link position-relative" th:href="@{/letter/list}">消息<span
            class="badge badge-danger"
            th:text="${allUnreadCount!=0?allUnreadCount:''}">12</span></a>
</li>
```

##### 3.4 运行结果

![image-20220718162613492](http://qiniu.dyl.fit/Interview/image-20220718162613492.png)

## 第6章 Elasticsearch，分布式搜索引擎

### 6.1 Elasticsearch入门

#### 1、Elasticsearch简介

一个分布式的、Restful风格（请求标准的描述）的搜索引擎。
- 支持对各种类型的数据的检索。
- 搜索速度快，可以提供实时的搜索服务。
- 便于水平扩展，每秒可以处理PB级海量数据。

#### 2、Elasticsearch术语

索引（对应数据库）、类型（对应表）、文档（表里一行）、字段（一列）。

> 最新的版本类型被废弃。                                                                                                                                                                                                                                                                                

集群(服务器组合在一起)、节点（集群中每台服务器）、分片（对索引的划分）、副本（分片的备份）。

通过ES搜索的数据必须要在ES中转存一份，某种角度来说它是一个数据库。

#### 3、Elasticsearch使用

##### 3.1 安装、修改配置文件

修改 config 包内的elasticsearch.yml文件，更改其中的 cluster.name，path.data，path.logs

```yaml
cluster.name: community
path.data: D:\Learn\data\elasticsearch-6.4.3\data
path.logs: D:\Learn\data\elasticsearch-6.4.3\logs
```

然后配置环境变量

![image-20220719095424474](http://qiniu.dyl.fit/Interview/image-20220719095424474.png)

##### 3.2 安装中文分词插件（ES仅支持中文分词）

[插件链接](http://github.com/medcl/elasticsearch-analysis-ik)

此处使用的是 6.4.3 版本 链接：http://github.com/medcl/elasticsearch-analysis-ik/releases/tag/v6.4.3

将 ik 插件安装到 plugins 文件夹下

![image-20220719095942547](http://qiniu.dyl.fit/Interview/image-20220719095942547.png)

##### 3.3 安装 postman (提交 html 数据给 ES )模拟 web 客户端

##### 3.4 启动 ES :打开 bin/elasticsearch.bat

* 查看集群健康状态：curl -X GET "localhost:9200/_cat/health?v"
* 查看节点：curl -X GET "localhost:9200/_cat/nodes?v"
* 查看索引：curl -X GET "localhost:9200/_cat/indices?v"
* 创建索引：curl -X PUT "localhost:9200/test"
* 删除索引：curl -X DELETE "localhost:9200/test"

##### 3.5 使用postman查询

* 提交数据，PUT localhost:9200/test/_doc/1选择 Body, raw, JSON

* 搜索，GET localhost:9200/test/_search?q=title(/content):xxx

* 搜索时ES对关键词进行了分词

* 通过请求体构造复杂搜索条件

### 6.2 Spring 整合Elasticsearch

#### 1、引入依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-elasticsearch</artifactId>
</dependency>
```

#### 2、配置Elasticsearch

##### 2.1 cluster-name、cluster-nodes

配置集群的名字和节点

```yaml
# ElasticsearchProperties
spring:
    data:
      elasticsearch:
        cluster-name: community
        cluster-nodes: 127.0.0.1:9300
```

##### 2.2 解决 Netty 启动冲突

Redis 和 Es 底层都用到了Netty,所以在 CommunityApplication 类加入初始化方法进行配置。

```java
@PostConstruct
public void init() {
    // 解决netty启动冲突问题
    // see Netty4Utils.setAvailableProcessors()
    System.setProperty("es.set.netty.runtime.available.processors", "false");
}
```

#### 3、Spring Data Elasticsearch(调用API)

* ElasticsearchTemplate（集成了Es的CRUD方法）
* ElasticsearchRepository（接口，底层为ElasticsearchTemplate，用起来更方便）

### 6.3 开发社区搜索功能

#### 1、搜索服务

- 将帖子保存至Elasticsearch服务器。
  - 对贴子实体类 DiscussPost 用注解进行相关配置
  - 从 Mybatis 取数据存入
  - 在 dao 层创建 DiscussPostRepository 类，继承 ElasticsearchRepository 接口即可，它集成了 CRUD 方法
- 从 Elasticsearch 服务器删除帖子。
- 从 Elasticsearch 服务器搜索帖子。
  - Es 可以在搜索到的词加标签，达到高亮显示
  - 利用 elasticTemplate.queryForPage() 查询

##### 1.1 配置实体类

将实体类 DiscussPost 创建索引

```java
@Document(indexName = "discusspost", type = "_doc", shards = 6, replicas = 3)
public class DiscussPost {

    @Id
    private int id;

    @Field(type = FieldType.Integer)
    private int userId;

    // 互联网校招
    @Field(type = FieldType.Text, analyzer = "ik_max_word", searchAnalyzer = "ik_smart")
    private String title;

    @Field(type = FieldType.Text, analyzer = "ik_max_word", searchAnalyzer = "ik_smart")
    private String content;

    @Field(type = FieldType.Integer)
    private int type;

    @Field(type = FieldType.Integer)
    private int status;

    @Field(type = FieldType.Date)
    private Date createTime;

    @Field(type = FieldType.Integer)
    private int commentCount;

    @Field(type = FieldType.Double)
    private double score;

    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    public int getUserId() {
        return userId;
    }

    public void setUserId(int userId) {
        this.userId = userId;
    }

    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public int getType() {
        return type;
    }

    public void setType(int type) {
        this.type = type;
    }

    public int getStatus() {
        return status;
    }

    public void setStatus(int status) {
        this.status = status;
    }

    public Date getCreateTime() {
        return createTime;
    }

    public void setCreateTime(Date createTime) {
        this.createTime = createTime;
    }

    public int getCommentCount() {
        return commentCount;
    }

    public void setCommentCount(int commentCount) {
        this.commentCount = commentCount;
    }

    public double getScore() {
        return score;
    }

    public void setScore(double score) {
        this.score = score;
    }

    @Override
    public String toString() {
        return "DiscussPost{" +
                "id=" + id +
                ", userId=" + userId +
                ", title='" + title + '\'' +
                ", content='" + content + '\'' +
                ", type=" + type +
                ", status=" + status +
                ", createTime=" + createTime +
                ", commentCount=" + commentCount +
                ", score=" + score +
                '}';
    }
}
```

##### 1.2 定义 Repository 接口

在 dao 包内新建 elasticsearch 包，并在包内新建 DiscussPostRepository 接口

```java
@Repository
public interface DiscussPostRepository extends ElasticsearchRepository<DiscussPost, Integer> {
}
```

##### 1.3 测试

创建接口对应的测试类 DiscussPostRepositoryTest

```java
@SpringBootTest
class DiscussPostRepositoryTest {

    @Resource
    private DiscussPostMapper discussPostMapper;

    @Resource
    private DiscussPostRepository discussPostRepository;

    @Resource
    private ElasticsearchTemplate elasticsearchTemplate;

    @Test
    void testInsert() {
        discussPostRepository.save(discussPostMapper.selectDiscussPostById(241));
        discussPostRepository.save(discussPostMapper.selectDiscussPostById(242));
        discussPostRepository.save(discussPostMapper.selectDiscussPostById(243));
    }

    @Test
    void testInsertList() {
        discussPostRepository.saveAll(discussPostMapper.selectDiscussPosts(103, 0, 100));
        discussPostRepository.saveAll(discussPostMapper.selectDiscussPosts(111, 0, 100));
        discussPostRepository.saveAll(discussPostMapper.selectDiscussPosts(112, 0, 100));
        discussPostRepository.saveAll(discussPostMapper.selectDiscussPosts(131, 0, 100));
        discussPostRepository.saveAll(discussPostMapper.selectDiscussPosts(132, 0, 100));
        discussPostRepository.saveAll(discussPostMapper.selectDiscussPosts(133, 0, 100));
        discussPostRepository.saveAll(discussPostMapper.selectDiscussPosts(134, 0, 100));
    }

    @Test
    void testUpdate() {
        DiscussPost post = discussPostMapper.selectDiscussPostById(236);
        post.setContent("我是新人,使劲灌水.");
        discussPostRepository.save(post);
    }

    @Test
    void testDelete() {
//        discussPostRepository.deleteById(236);
        discussPostRepository.deleteAll();
    }

    @Test
    void testSearchByRepository() {
        SearchQuery searchQuery = new NativeSearchQueryBuilder()
                .withQuery(QueryBuilders.multiMatchQuery("互联网", "title", "content"))
                .withSort(SortBuilders.fieldSort("type").order(SortOrder.DESC))
                .withSort(SortBuilders.fieldSort("score").order(SortOrder.DESC))
                .withSort(SortBuilders.fieldSort("createTime").order(SortOrder.DESC))
                .withPageable(PageRequest.of(0, 10))
                .withHighlightFields(
                        new HighlightBuilder.Field("title").preTags("<em>").postTags("</em>"),
                        new HighlightBuilder.Field("content").preTags("<em>").postTags("</em>")
                ).build();

        // elasticTemplate.queryForPage(searchQuery, class, SearchResultMapper)
        // 底层获取得到了高亮显示的值, 但是没有返回.下面演示该方法

        Page<DiscussPost> page = discussPostRepository.search(searchQuery);
        System.out.println(page.getTotalElements());
        System.out.println(page.getTotalPages());
        System.out.println(page.getNumber());
        System.out.println(page.getSize());
        for (DiscussPost post : page) {
            System.out.println(post);
        }
    }

    @Test
    void testSearchByTemplate() {
        SearchQuery searchQuery = new NativeSearchQueryBuilder()
                .withQuery(QueryBuilders.multiMatchQuery("互联网寒冬", "title", "content"))
                .withSort(SortBuilders.fieldSort("type").order(SortOrder.DESC))
                .withSort(SortBuilders.fieldSort("score").order(SortOrder.DESC))
                .withSort(SortBuilders.fieldSort("createTime").order(SortOrder.DESC))
                .withPageable(PageRequest.of(0, 10))
                .withHighlightFields(
                        new HighlightBuilder.Field("title").preTags("<em>").postTags("</em>"),
                        new HighlightBuilder.Field("content").preTags("<em>").postTags("</em>")
                ).build();

        Page<DiscussPost> page = elasticsearchTemplate.queryForPage(searchQuery, DiscussPost.class, new SearchResultMapper() {
            @Override
            public <T> AggregatedPage<T> mapResults(SearchResponse response, Class<T> aClass, Pageable pageable) {
                SearchHits hits = response.getHits();
                if (hits.getTotalHits() <= 0) {
                    return null;
                }

                List<DiscussPost> list = new ArrayList<>();
                for (SearchHit hit : hits) {
                    DiscussPost post = new DiscussPost();

                    String id = hit.getSourceAsMap().get("id").toString();
                    post.setId(Integer.parseInt(id));

                    String userId = hit.getSourceAsMap().get("userId").toString();
                    post.setUserId(Integer.parseInt(userId));

                    String title = hit.getSourceAsMap().get("title").toString();
                    post.setTitle(title);

                    String content = hit.getSourceAsMap().get("content").toString();
                    post.setContent(content);

                    String status = hit.getSourceAsMap().get("status").toString();
                    post.setStatus(Integer.parseInt(status));

                    String createTime = hit.getSourceAsMap().get("createTime").toString();
                    post.setCreateTime(new Date(Long.parseLong(createTime)));

                    String commentCount = hit.getSourceAsMap().get("commentCount").toString();
                    post.setCommentCount(Integer.parseInt(commentCount));

                    // 处理高亮显示的结果
                    HighlightField titleField = hit.getHighlightFields().get("title");
                    if (titleField != null) {
                        post.setTitle(titleField.getFragments()[0].toString());
                    }

                    HighlightField contentField = hit.getHighlightFields().get("content");
                    if (contentField != null) {
                        post.setContent(contentField.getFragments()[0].toString());
                    }

                    list.add(post);
                }

                return new AggregatedPageImpl(list, pageable,
                        hits.getTotalHits(), response.getAggregations(), response.getScrollId(), hits.getMaxScore());
            }

            @Override
            public <T> T mapSearchHit(SearchHit searchHit, Class<T> aClass) {
                return null;
            }
        });

        System.out.println(page.getTotalElements());
        System.out.println(page.getTotalPages());
        System.out.println(page.getNumber());
        System.out.println(page.getSize());
        for (DiscussPost post : page) {
            System.out.println(post);
        }
    }
}
```

##### 1.4 运行结果

![image-20220719152733878](http://qiniu.dyl.fit/Interview/image-20220719152733878.png)

![image-20220719152800933](http://qiniu.dyl.fit/Interview/image-20220719152800933.png)

#### 2、发布事件

- 发布帖子时，将帖子异步的提交到 Elasticsearch 服务器。
  - 新建 ElasticsearchService 类，定义 CRUD 和搜索方法。
  - 在 DiscussPostController 类发帖时，定义和触发发帖事件（Event、eventProducer.fireEvent(event)）
- 增加评论时，将帖子异步的提交到 Elasticsearch 服务器。
  - 在 CommentController 类发表评论时，定义和触发发帖事件
- 在消费组件中增加一个方法，消费帖子发布事件。
  - 在 EventConsumer 类增加消费发帖事件的方法
  - 在事件中查询帖子，存到 Es 服务器

##### 2.1 创建 service

创建 ElasticsearchService

```java
@Service
public class ElasticsearchService {

    @Resource
    private DiscussPostRepository discussPostRepository;

    @Resource
    private ElasticsearchTemplate elasticTemplate;

    public void saveDiscussPost(DiscussPost post) {
        discussPostRepository.save(post);
    }

    public void deleteDiscussPost(int id) {
        discussPostRepository.deleteById(id);
    }

    public Page<DiscussPost> searchDiscussPost(String keyword, int current, int limit) {
        SearchQuery searchQuery = new NativeSearchQueryBuilder()
                .withQuery(QueryBuilders.multiMatchQuery(keyword, "title", "content"))
                .withSort(SortBuilders.fieldSort("type").order(SortOrder.DESC))
                .withSort(SortBuilders.fieldSort("score").order(SortOrder.DESC))
                .withSort(SortBuilders.fieldSort("createTime").order(SortOrder.DESC))
                .withPageable(PageRequest.of(current, limit))
                .withHighlightFields(
                        new HighlightBuilder.Field("title").preTags("<em>").postTags("</em>"),
                        new HighlightBuilder.Field("content").preTags("<em>").postTags("</em>")
                ).build();

        return elasticTemplate.queryForPage(searchQuery, DiscussPost.class, new SearchResultMapper() {
            @Override
            public <T> AggregatedPage<T> mapResults(SearchResponse response, Class<T> aClass, Pageable pageable) {
                SearchHits hits = response.getHits();
                if (hits.getTotalHits() <= 0) {
                    return null;
                }

                List<DiscussPost> list = new ArrayList<>();
                for (SearchHit hit : hits) {
                    DiscussPost post = new DiscussPost();

                    String id = hit.getSourceAsMap().get("id").toString();
                    post.setId(Integer.parseInt(id));

                    String userId = hit.getSourceAsMap().get("userId").toString();
                    post.setUserId(Integer.parseInt(userId));

                    String title = hit.getSourceAsMap().get("title").toString();
                    post.setTitle(title);

                    String content = hit.getSourceAsMap().get("content").toString();
                    post.setContent(content);

                    String status = hit.getSourceAsMap().get("status").toString();
                    post.setStatus(Integer.parseInt(status));

                    String createTime = hit.getSourceAsMap().get("createTime").toString();
                    post.setCreateTime(new Date(Long.parseLong(createTime)));

                    String commentCount = hit.getSourceAsMap().get("commentCount").toString();
                    post.setCommentCount(Integer.parseInt(commentCount));

                    // 处理高亮显示的结果
                    HighlightField titleField = hit.getHighlightFields().get("title");
                    if (titleField != null) {
                        post.setTitle(titleField.getFragments()[0].toString());
                    }

                    HighlightField contentField = hit.getHighlightFields().get("content");
                    if (contentField != null) {
                        post.setContent(contentField.getFragments()[0].toString());
                    }

                    list.add(post);
                }

                return new AggregatedPageImpl(list, pageable,
                        hits.getTotalHits(), response.getAggregations(), response.getScrollId(), hits.getMaxScore());
            }

            @Override
            public <T> T mapSearchHit(SearchHit searchHit, Class<T> aClass) {
                return null;
            }
        });
    }
}
```

##### 2.2 修改 controller

在 CommunityConstant 中添加常量

```java
/**
 * 主题：发帖
 */
String TOPIC_PUBLISH = "publish";
```

修改 DiscussPostController 中的 addDiscussPost() 方法

```java
@PostMapping("/add")
@ResponseBody
public String addDiscussPost(String title, String content) {

    User user = hostHolder.getUser();
    if (user == null) {
        return CommunityUtil.getJSONString(403, "你还没有登录！");
    }

    DiscussPost post = new DiscussPost();
    post.setUserId(user.getId());
    post.setTitle(title);
    post.setContent(content);
    post.setCreateTime(new Date());
    discussPostService.addDiscussPost(post);

    // 触发发帖事件
    Event event = new Event()
            .setTopic(TOPIC_PUBLISH)
            .setUserId(user.getId())
            .setEntityType(ENTITY_TYPE_POST)
            .setEntityId(post.getId());
    eventProducer.fireEvent(event);

    //报错情况,将来统一处理
    return CommunityUtil.getJSONString(0, "发布成功！");
}
```

修改 CommentController 中的 addComment() 方法

```java
@PostMapping("/add/{discussPostId}")
public String addComment(@PathVariable("discussPostId") int discussPostId, Comment comment) {
    comment.setUserId(hostHolder.getUser().getId());
    comment.setStatus(0);
    comment.setCreateTime(new Date());
    commentService.addComment(comment);

    //触发评论事件
    Event event = new Event()
            .setTopic(TOPIC_COMMENT)
            .setUserId(hostHolder.getUser().getId())
            .setEntityType(comment.getEntityType())
            .setEntityId(comment.getEntityId())
            .setData("postId", discussPostId);
    if (comment.getEntityType() == ENTITY_TYPE_POST) {
        DiscussPost target = discussPostService.findDiscussPostById(comment.getEntityId());
        event.setEntityUserId(target.getUserId());
    } else if (comment.getEntityType() == ENTITY_TYPE_COMMENT) {
        Comment target = commentService.findCommentById(comment.getEntityId());
        event.setEntityUserId(target.getUserId());
    }
    eventProducer.fireEvent(event);

    if (comment.getEntityType() == ENTITY_TYPE_POST) {
        // 触发发帖事件
        event = new Event()
                .setTopic(TOPIC_PUBLISH)
                .setUserId(comment.getUserId())
                .setEntityType(ENTITY_TYPE_POST)
                .setEntityId(discussPostId);
        eventProducer.fireEvent(event);
    }

    return "redirect:/discuss/detail/" + discussPostId;
}
```

##### 2.3 修改事件

修改 EventConsumer 

```java
// 消费发帖事件
@KafkaListener(topics = {TOPIC_PUBLISH})
public void handlePublishMessage(ConsumerRecord record) {
    if (record == null || record.value() == null) {
        logger.error("消息的内容为空!");
        return;
    }

    Event event = JSONObject.parseObject(record.value().toString(), Event.class);
    if (event == null) {
        logger.error("消息格式错误!");
        return;
    }

    DiscussPost post = discussPostService.findDiscussPostById(event.getEntityId());
    elasticsearchService.saveDiscussPost(post);
}
```

#### 3、显示结果

- 在控制器中处理搜索请求，在HTML上显示搜索结果。
  - 新建SearchController类处理搜索请求
  - 此时为GET请求，keyword的传入（search?keyword=xxx）
  - 修改 index.html,表单提交路径，文本框 name="keyword"
  - 在 search.html 修改，遍历取到帖子。

##### 3.1 新建 controller

新建 SearchController 

```java
@Controller
public class SearchController implements CommunityConstant {

    @Resource
    private ElasticsearchService elasticsearchService;

    @Resource
    private UserService userService;

    @Resource
    private LikeService likeService;

    // search?keyword=xxx
    @GetMapping("/search")
    public String search(String keyword, Page page, Model model) {
        // 搜索帖子
        org.springframework.data.domain.Page<DiscussPost> searchResult =
                elasticsearchService.searchDiscussPost(keyword, page.getCurrent() - 1, page.getLimit());
        // 聚合数据
        List<Map<String, Object>> discussPosts = new ArrayList<>();
        if (searchResult != null) {
            for (DiscussPost post : searchResult) {
                Map<String, Object> map = new HashMap<>();
                // 帖子
                map.put("post", post);
                // 作者
                map.put("user", userService.findUserById(post.getUserId()));
                // 点赞数量
                map.put("likeCount", likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId()));

                discussPosts.add(map);
            }
        }
        model.addAttribute("discussPosts", discussPosts);
        model.addAttribute("keyword", keyword);

        // 分页信息
        page.setPath("/search?keyword=" + keyword);
        page.setRows(searchResult == null ? 0 : (int) searchResult.getTotalElements());

        return "/site/search";
    }
}
```

##### 3.2 修改前端界面

修改 index.html

```html
<!-- 搜索 -->
<form class="form-inline my-2 my-lg-0" method="get" th:action="@{/search}">
    <input class="form-control mr-sm-2" type="search" aria-label="Search" name="keyword"
           th:value="${keyword}"/>
    <button class="btn btn-outline-light my-2 my-sm-0" type="submit">搜索</button>
</form>
```

修改 search.html

用 thymeleaf 重构代码，然后修改内容部分的代码如下

```html
<div class="main">
    <div class="container">
        <h6><b class="square"></b> 相关帖子</h6>
        <!-- 帖子列表 -->
        <ul class="list-unstyled mt-4">
            <li class="media pb-3 pt-3 mb-3 border-bottom" th:each="map:${discussPosts}">
                <qiniu th:src="${map.user.headerUrl}" class="mr-4 rounded-circle" alt="用户头像"
                     style="width:50px;height:50px;">
                <div class="media-body">
                    <h6 class="mt-0 mb-3">
                        <a th:href="@{|/discuss/detail/${map.post.id}|}" th:utext="${map.post.title}">备战<em>春招</em>，面试刷题跟他复习，一个月全搞定！</a>
                    </h6>
                    <div class="mb-3" th:utext="${map.post.content}">
                        金三银四的金三已经到了，你还沉浸在过年的喜悦中吗？ 如果是，那我要让你清醒一下了：目前大部分公司已经开启了内推，正式网申也将在3月份陆续开始，金三银四，<em>春招</em>的求职黄金时期已经来啦！！！
                        再不准备，作为19应届生的你可能就找不到工作了。。。作为20届实习生的你可能就找不到实习了。。。 现阶段时间紧，任务重，能做到短时间内快速提升的也就只有算法了
                    </div>
                    <div class="text-muted font-size-12">
                        <u class="mr-3" th:utext="${map.user.username}">寒江雪</u>
                        发布于 <b th:text="${#dates.format(map.post.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15
                        15:32:18</b>
                        <ul class="d-inline float-right">
                            <li class="d-inline ml-2">赞 <i th:text="${map.likeCount}">11</i></li>
                            <li class="d-inline ml-2">|</li>
                            <li class="d-inline ml-2">回复 <i th:text="${map.post.commentCount}">7</i></li>
                        </ul>
                    </div>
                </div>
            </li>
        </ul>
        <!-- 分页 -->
        <nav class="mt-5" th:replace="index::pagination"></nav>
    </div>
</div>
```

##### 3.3 运行结果

![动画17](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB17.gif)

## 第7章 项目进阶，构建安全高效的企业服务

### 7.1 Spring Security

#### 1、介绍

##### 1.1 简介

Spring Security是一个专注与为Java应用程序提供身份认证和授权的框架，它的强大之处在于它可以轻松扩展以满足自定义的需求。

##### 1.2 特征

* 对身份的认证和授权提供全面的、可扩展的支持。
* 防止各种攻击，如会话固定攻击、点击劫持、csrf 攻击等。
* 支持与 Servelt API、Spring MVC 等 Web 技术集成。

##### 1.3 原理

* 底层使用Filter（javaEE标准）进行拦截
* Filter-->DispatchServlet-->Interceptor-->Controller(后三者属于Spring MVC)

![image-20220720093458509](http://qiniu.dyl.fit/Interview/image-20220720093458509.png)

#### 2、使用

新建 springsecuritydemo 项目

##### 2.1 引入依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

##### 2.2 修改实体类

User实体类实现UserDetails接口，实现接口中各方法（账号、凭证是否可用过期，管理权限）

```java
public class User implements UserDetails {

    private int id;
    private String username;
    private String password;
    private String salt;
    private String email;
    private int type;
    private int status;
    private String activationCode;
    private String headerUrl;
    private Date createTime;

    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    @Override
    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    @Override
    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public String getSalt() {
        return salt;
    }

    public void setSalt(String salt) {
        this.salt = salt;
    }

    public String getEmail() {
        return email;
    }

    public void setEmail(String email) {
        this.email = email;
    }

    public int getType() {
        return type;
    }

    public void setType(int type) {
        this.type = type;
    }

    public int getStatus() {
        return status;
    }

    public void setStatus(int status) {
        this.status = status;
    }

    public String getActivationCode() {
        return activationCode;
    }

    public void setActivationCode(String activationCode) {
        this.activationCode = activationCode;
    }

    public String getHeaderUrl() {
        return headerUrl;
    }

    public void setHeaderUrl(String headerUrl) {
        this.headerUrl = headerUrl;
    }

    public Date getCreateTime() {
        return createTime;
    }

    public void setCreateTime(Date createTime) {
        this.createTime = createTime;
    }

    @Override
    public String toString() {
        return "User{" +
                "id=" + id +
                ", username='" + username + '\'' +
                ", password='" + password + '\'' +
                ", salt='" + salt + '\'' +
                ", email='" + email + '\'' +
                ", type=" + type +
                ", status=" + status +
                ", activationCode='" + activationCode + '\'' +
                ", headerUrl='" + headerUrl + '\'' +
                ", createTime=" + createTime +
                '}';
    }

    // true:账户未过期
    @Override
    public boolean isAccountNonExpired() {
        return true;
    }

    // true:账户未锁定
    @Override
    public boolean isAccountNonLocked() {
        return true;
    }

    // true:凭证未过期
    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }

    // true:账户可用
    @Override
    public boolean isEnabled() {
        return true;
    }

    //
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        ArrayList<GrantedAuthority> list = new ArrayList<>();
        list.add(new GrantedAuthority() {
            @Override
            public String getAuthority() {
                switch (type) {
                    case 1:
                        return "ADMIN";
                    default:
                        return "USER";
                }
            }
        });
        return list;
    }
}
```

##### 2.3 修改 service

UserService 实现 UserDetailsService 接口,实现接口方法（ security 检查用户是否登录时用到该接口）

```java
@Service
public class UserService implements UserDetailsService {

    @Resource
    private UserMapper userMapper;

    public User findUserByName(String username) {
        return userMapper.selectByName(username);
    }

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        return this.findUserByName(username);
    }
}
```

##### 2.4 新建 SecurityConfig 类

先继承 WebSecurityConfigurerAdapter，然后配置忽略静态资源的访问

```java
@Override
public void configure(WebSecurity web) throws Exception {
    // 忽略静态资源的访问
    web.ignoring().antMatchers("/resources/**");
}
```

先实现认证的逻辑，自定义认证规则（AuthenticationManager: 认证的核心接口）

* 登录相关配置
* 退出相关配置

```java
@Override
protected void configure(httpecurity http) throws Exception {
    // 登录相关配置
    http.formLogin()
            .loginPage("/loginpage")
            .loginProcessingUrl("/login")
            .successHandler(new AuthenticationSuccessHandler() {
                @Override
                public void onAuthenticationSuccess(httpervletRequest request, httpervletResponse response, Authentication authentication) throws IOException, ServletException {
                    response.sendRedirect(request.getContextPath() + "/index");
                }
            })
            .failureHandler(new AuthenticationFailureHandler() {
                @Override
                public void onAuthenticationFailure(httpervletRequest request, httpervletResponse response, AuthenticationException e) throws IOException, ServletException {
                    request.setAttribute("error", e.getMessage());
                    request.getRequestDispatcher("/loginpage").forward(request, response);
                }
            });

    // 退出相关配置
    http.logout()
            .logoutUrl("/logout")
            .logoutSuccessHandler(new LogoutSuccessHandler() {
                @Override
                public void onLogoutSuccess(httpervletRequest request, httpervletResponse response, Authentication authentication) throws IOException, ServletException {
                    response.sendRedirect(request.getContextPath() + "/index");
                }
            });
}
```

> 委托模式: ProviderManager将认证委托给AuthenticationProvider.

实现授权的逻辑

*  授权配置
*  增加Filter,处理验证码
*  记住我

```java
@Override
protected void configure(httpecurity http) throws Exception {
    // 登录相关配置
    http.formLogin()
            .loginPage("/loginpage")
            .loginProcessingUrl("/login")
            .successHandler(new AuthenticationSuccessHandler() {
                @Override
                public void onAuthenticationSuccess(httpervletRequest request, httpervletResponse response, Authentication authentication) throws IOException, ServletException {
                    response.sendRedirect(request.getContextPath() + "/index");
                }
            })
            .failureHandler(new AuthenticationFailureHandler() {
                @Override
                public void onAuthenticationFailure(httpervletRequest request, httpervletResponse response, AuthenticationException e) throws IOException, ServletException {
                    request.setAttribute("error", e.getMessage());
                    request.getRequestDispatcher("/loginpage").forward(request, response);
                }
            });

    // 退出相关配置
    http.logout()
            .logoutUrl("/logout")
            .logoutSuccessHandler(new LogoutSuccessHandler() {
                @Override
                public void onLogoutSuccess(httpervletRequest request, httpervletResponse response, Authentication authentication) throws IOException, ServletException {
                    response.sendRedirect(request.getContextPath() + "/index");
                }
            });

    // 授权配置
    http.authorizeRequests()
            .antMatchers("/letter").hasAnyAuthority("USER", "ADMIN")
            .antMatchers("/admin").hasAnyAuthority("ADMIN")
            .and().exceptionHandling().accessDeniedPage("/denied");

    // 增加Filter,处理验证码
    http.addFilterBefore(new Filter() {
        @Override
        public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
            httpervletRequest request = (httpervletRequest) servletRequest;
            httpervletResponse response = (httpervletResponse) servletResponse;
            if (request.getServletPath().equals("/login")) {
                String verifyCode = request.getParameter("verifyCode");
                if (verifyCode == null || !verifyCode.equalsIgnoreCase("1234")) {
                    request.setAttribute("error", "验证码错误!");
                    request.getRequestDispatcher("/loginpage").forward(request, response);
                    return;
                }
            }
            // 让请求继续向下执行.
            filterChain.doFilter(request, response);
        }
    }, UsernamePasswordAuthenticationFilter.class);
    // 记住我
    http.rememberMe()
            .tokenRepository(new InMemoryTokenRepositoryImpl())
            .tokenValiditySeconds(3600 * 24)
            .userDetailsService(userService);

}
```

完整代码如下：

```java
@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    @Autowired
    private UserService userService;

    @Override
    public void configure(WebSecurity web) throws Exception {
        // 忽略静态资源的访问
        web.ignoring().antMatchers("/resources/**");
    }

    // AuthenticationManager:认证的核心接口
    // AuthenticationManagerBuilder:用于构建AuthenticationManager对象的工具
    // ProviderManager:AuthenticationManager接口的默认实现类
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        // 内置的认证规则
        auth.userDetailsService(userService).passwordEncoder(new Pbkdf2PasswordEncoder("1234"));

        // 自定义认证规则
        // AuthenticationProvider: ProviderManager持有一组AuthenticationProvider,每个AuthenticationProvider负责一种认证.
        // 委托模式: ProviderManager将认证委托给AuthenticationProvider.
        auth.authenticationProvider(new AuthenticationProvider() {
            // Authentication: 用于封装认证信息的接口,不同的实现类代表不同类型的认证信息.
            @Override
            public Authentication authenticate(Authentication authentication) throws AuthenticationException {
                String username = authentication.getName();
                String password = (String) authentication.getCredentials();

                User user = userService.findUserByName(username);
                if (user == null) {
                    throw new UsernameNotFoundException("账号不存在!");
                }

                password = CommunityUtil.md5(password + user.getSalt());
                if (!user.getPassword().equals(password)) {
                    throw new BadCredentialsException("密码不正确!");
                }

                // principal: 主要信息; credentials: 证书; authorities: 权限;
                return new UsernamePasswordAuthenticationToken(user, user.getPassword(), user.getAuthorities());
            }

            // 当前的AuthenticationProvider支持哪种类型的认证.
            @Override
            public boolean supports(Class<?> aClass) {
                // UsernamePasswordAuthenticationToken: Authentication接口的常用的实现类.
                return UsernamePasswordAuthenticationToken.class.equals(aClass);
            }
        });
    }

    @Override
    protected void configure(httpecurity http) throws Exception {
        // 登录相关配置
        http.formLogin()
                .loginPage("/loginpage")
                .loginProcessingUrl("/login")
                .successHandler(new AuthenticationSuccessHandler() {
                    @Override
                    public void onAuthenticationSuccess(httpervletRequest request, httpervletResponse response, Authentication authentication) throws IOException, ServletException {
                        response.sendRedirect(request.getContextPath() + "/index");
                    }
                })
                .failureHandler(new AuthenticationFailureHandler() {
                    @Override
                    public void onAuthenticationFailure(httpervletRequest request, httpervletResponse response, AuthenticationException e) throws IOException, ServletException {
                        request.setAttribute("error", e.getMessage());
                        request.getRequestDispatcher("/loginpage").forward(request, response);
                    }
                });

        // 退出相关配置
        http.logout()
                .logoutUrl("/logout")
                .logoutSuccessHandler(new LogoutSuccessHandler() {
                    @Override
                    public void onLogoutSuccess(httpervletRequest request, httpervletResponse response, Authentication authentication) throws IOException, ServletException {
                        response.sendRedirect(request.getContextPath() + "/index");
                    }
                });

        // 授权配置
        http.authorizeRequests()
                .antMatchers("/letter").hasAnyAuthority("USER", "ADMIN")
                .antMatchers("/admin").hasAnyAuthority("ADMIN")
                .and().exceptionHandling().accessDeniedPage("/denied");

        // 增加Filter,处理验证码
        http.addFilterBefore(new Filter() {
            @Override
            public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
                httpervletRequest request = (httpervletRequest) servletRequest;
                httpervletResponse response = (httpervletResponse) servletResponse;
                if (request.getServletPath().equals("/login")) {
                    String verifyCode = request.getParameter("verifyCode");
                    if (verifyCode == null || !verifyCode.equalsIgnoreCase("1234")) {
                        request.setAttribute("error", "验证码错误!");
                        request.getRequestDispatcher("/loginpage").forward(request, response);
                        return;
                    }
                }
                // 让请求继续向下执行.
                filterChain.doFilter(request, response);
            }
        }, UsernamePasswordAuthenticationFilter.class);
        // 记住我
        http.rememberMe()
                .tokenRepository(new InMemoryTokenRepositoryImpl())
                .tokenValiditySeconds(3600 * 24)
                .userDetailsService(userService);

    }
}
```

>重定向，浏览器访问 A ,服务器返回 302 ，建议访问 B 一般不能带数据给B（Session和Cookie）
>
>转发，浏览器访问 A ，A 完成部分请求，存入 Request,转发给B完成剩下请求。（有耦合）

##### 2.5 修改 controller

在 HomeController 添加认证逻辑，在认证成功后,结果会通过 SecurityContextHolder 存入 SecurityContext 中

```java
@GetMapping("/index")
public String getIndexPage(Model model) {
    // 认证成功后，结果会通过SecurityContextHolder存入SecurityContext中
    Object obj = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
    if (obj instanceof User) {
        model.addAttribute("loginUser", obj);
    }
    return "/index";
}
```

### 7.2 权限控制

#### 1、登录检查

之前采用拦截器实现了登录检查，这是简单的权限管理方案，现在将废弃。

将 WebMvcConfig 中这段代码注释掉

```java
@Resource
private LoginRequiredInterceptor loginRequiredInterceptor;

registry.addInterceptor(loginRequiredInterceptor)
                .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg");

```

#### 2、授权配置

对当前系统内的所有的请求，分配访问权限（普通用户、板主、管理员）。

##### 2.1 修改 CommunityConstant 

先在 CommunityConstant 中添加常量

```java
/**
 * 权限: 普通用户
 */
String AUTHORITY_USER = "user";

/**
 * 权限: 管理员
 */
String AUTHORITY_ADMIN = "admin";

/**
 * 权限: 版主
 */
String AUTHORITY_MODERATOR = "moderator";
```

##### 2.2 新建 config

新建 SecurityConfig 类，配置静态资源都可以访问

先在 HomeController 中，以便配置授权操作，以及权限不够时的处理

```java
@GetMapping("/denied")
public String getDeniedPage() {
    return "/error/404";
}
```

```java
@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter implements CommunityConstant {

    @Override
    public void configure(WebSecurity web) throws Exception {
        web.ignoring().antMatchers("/resources/**");
    }

    @Override
    protected void configure(httpecurity http) throws Exception {
        // 授权
        http.authorizeRequests()
                .antMatchers(
                        "/user/setting",
                        "/user/upload",
                        "/discuss/add",
                        "/comment/add/**",
                        "/letter/**",
                        "/notice/**",
                        "/like",
                        "/follow",
                        "/unfollow"
                )
                .hasAnyAuthority(
                        AUTHORITY_USER,
                        AUTHORITY_ADMIN,
                        AUTHORITY_MODERATOR
                )
                .anyRequest().permitAll();

        // 权限不够时的处理
        http.exceptionHandling()
                .authenticationEntryPoint(new AuthenticationEntryPoint() {
                    // 没有登录
                    @Override
                    public void commence(httpervletRequest request, httpervletResponse response, AuthenticationException e) throws IOException, ServletException {
                        String xRequestedWith = request.getHeader("x-requested-with");
                        if ("XMLHttpRequest".equals(xRequestedWith)) {
                            response.setContentType("application/plain;charset=utf-8");
                            PrintWriter writer = response.getWriter();
                            writer.write(CommunityUtil.getJSONString(403, "你还没有登录哦!"));
                        } else {
                            response.sendRedirect(request.getContextPath() + "/login");
                        }
                    }
                })
                .accessDeniedHandler(new AccessDeniedHandler() {
                    // 权限不足
                    @Override
                    public void handle(httpervletRequest request, httpervletResponse response, AccessDeniedException e) throws IOException, ServletException {
                        String xRequestedWith = request.getHeader("x-requested-with");
                        if ("XMLHttpRequest".equals(xRequestedWith)) {
                            response.setContentType("application/plain;charset=utf-8");
                            PrintWriter writer = response.getWriter();
                            writer.write(CommunityUtil.getJSONString(403, "你没有访问此功能的权限!"));
                        } else {
                            response.sendRedirect(request.getContextPath() + "/denied");
                        }
                    }
                });
    }
}
```

#### 3、认证方案

绕过Security认证流程，采用系统原来的认证方案。

##### 3.1 修改退出登录的拦截

Security底层默认会拦截 /logout 请求,进行退出处理。覆盖它默认的逻辑,才能执行我们自己的退出代码

在 SecurityConfig 的 configure() 方法中添加这段代码

```java
    // Security底层默认会拦截/logout请求,进行退出处理.
    // 覆盖它默认的逻辑,才能执行我们自己的退出代码.
    http.logout().logoutUrl("/securitylogout");
```

##### 3.2 修改 service

在 UserService 中增加查询用户权限方法

```java
public Collection<? extends GrantedAuthority> getAuthorities(int userId) {
    User user = this.findUserById(userId);

    ArrayList<GrantedAuthority> list = new ArrayList<>();
    list.add(new GrantedAuthority() {
        @Override
        public String getAuthority() {
            switch (user.getType()) {
                case 1:
                    return AUTHORITY_ADMIN;
                case 2:
                    return AUTHORITY_MODERATOR;
                default:
                    return AUTHORITY_USER;
            }
        }
    });
    return list;
}
```

##### 3.3 修改 LoginTicketInterceptor

在 LoginTicketInterceptor 中构建用户认证的结果,并存入 SecurityContext ,以便于 Security 进行授权

```java
@Override
public boolean preHandle(httpervletRequest request, httpervletResponse response, Object handler) throws Exception {
    //从cookie中获取凭证
    String ticket = CookieUtil.getValue(request, "ticket");

    if (ticket != null) {
        //查询凭证
        LoginTicket loginTicket = userService.findLoginTicket(ticket);
        //检查凭证是否有效
        if (loginTicket != null && loginTicket.getStatus() == 0 && loginTicket.getExpired().after(new Date())) {
            //根据凭证查询用户
            User user = userService.findUserById(loginTicket.getUserId());
            //在本次请求中持有用户,要考虑多线程的情况,考虑线程隔离
            hostHolder.setUser(user);
            // 构建用户认证的结果,并存入SecurityContext,以便于Security进行授权.
            Authentication authentication = new UsernamePasswordAuthenticationToken(
                    user, user.getPassword(), userService.getAuthorities(user.getId()));
            SecurityContextHolder.setContext(new SecurityContextImpl(authentication));
        }
    }
    return true;
}
```

##### 3.4 清除认证结果

在 LoginController 中修改退出方法，清除认证结果

```java
@GetMapping("/logout")
public String logout(@CookieValue("ticket") String ticket) {
    userService.logout(ticket);
    SecurityContextHolder.clearContext();
    return "redirect:/login";
    //默认是get请求
}
```

#### 4、CSRF配置

防止CSRF攻击的基本原理，以及表单、AJAX的相关配置。

发送AJAX请求之前,将CSRF令牌设置到请求的消息头中.

##### 4.1 CSRF 攻击

CSRF攻击：某网站盗取你的Cookie（ticket）凭证，模拟你的身份访问服务器。（发生在提交表单的时候）

![image-20220720104548563](http://qiniu.dyl.fit/Interview/image-20220720104548563.png)

##### 4.2 解决表单中的 CSRF 攻击

Spring Security 会在表单里增加一个 TOCKEN (自动生成)

![image-20220720104632169](http://qiniu.dyl.fit/Interview/image-20220720104632169.png)

##### 4.3 处理异步请求中的 CSRF 攻击

Security 无法处理异步请求中的 CSRF 攻击，因此可以在 html 文件中生成 CSRF 令牌，（异步不是通过请求体传数据，通过请求头）

修改 index.html

```html
<!--访问该界面时，在此处生成CSRF令牌-->
<meta name="_csrf" th:content="${_csrf.token}">
<meta name="_csrf_header" th:content="${_csrf.headerName}">
```

修改 index.js

```js
//发送Ajax请求之前，将CSRF令牌设置到请求的消息头中
var token = $("meta[name='_csrf']").attr("content");
var header = $("meta[name='_csrf_header']").attr("content");
$(document).ajaxSend(function (e, xhr, options) {
    xhr.setRequestHeader(header, token);
});
```

> 将 index.js 下面的 window.location.reload();这一行注释掉

##### 4.4 运行结果

新提交一个回帖后查看网页源代码

![image-20220720131139537](http://qiniu.dyl.fit/Interview/image-20220720131139537.png)

![image-20220720131119178](http://qiniu.dyl.fit/Interview/image-20220720131119178.png)

##### 4.5 禁用 CSRF 保护

在 SecurityConfig 中新增 .and().csrf().disable();

```java
 http.authorizeRequests()
                .antMatchers(
                        "/user/setting",
                        "/user/upload",
                        "/discuss/add",
                        "/comment/add/**",
                        "/letter/**",
                        "/notice/**",
                        "/like",
                        "/follow",
                        "/unfollow"
                )
                .hasAnyAuthority(
                        AUTHORITY_USER,
                        AUTHORITY_ADMIN,
                        AUTHORITY_MODERATOR
                )
                .anyRequest().permitAll()
                .and().csrf().disable();
```

### 7.3 置顶、加精、删除

#### 1、功能实现

点击“置顶”、“加精”、“删除”，修改帖子的状态

##### 1.1 修改 mapper

在 DiscussPostMapper 增加修改方法

```java
int updateType(int id, int type);

int updateStatus(int id, int status);
```

配置相应的 sql 语句

```xml
<update id="updateType">
    update discuss_post set type = #{type} where id = #{id}
</update>
<update id="updateStatus">
    update discuss_post set status = #{status} where id = #{id}
</update>
```

##### 1.2 修改 service

在 DiscussPostService 中增加方法

```java
public int updateType(int id, int type) {
    return discussPostMapper.updateType(id, type);
}

public int updateStatus(int id, int status) {
    return discussPostMapper.updateStatus(id, status);
}
```

##### 1.3 增加事件

在 CommunityConstant 中增加常量

```java
/**
 * 主题：删帖
 */
String TOPIC_DELETE = "delete";
```

在 EventConsumer 中增加消费删帖事件

```java
// 消费删帖事件
@KafkaListener(topics = {TOPIC_DELETE})
public void handleDeleteMessage(ConsumerRecord record) {
    if (record == null || record.value() == null) {
        logger.error("消息的内容为空!");
        return;
    }

    Event event = JSONObject.parseObject(record.value().toString(), Event.class);
    if (event == null) {
        logger.error("消息格式错误!");
        return;
    }

    elasticsearchService.deleteDiscussPost(event.getEntityId());
}
```

##### 1.4 修改 controller

在 DiscussPostController 中添加请求

```java
// 置顶
@PostMapping("/top")
@ResponseBody
public String setTop(int id) {
    discussPostService.updateType(id, 1);

    // 触发发帖事件
    Event event = new Event()
            .setTopic(TOPIC_PUBLISH)
            .setUserId(hostHolder.getUser().getId())
            .setEntityType(ENTITY_TYPE_POST)
            .setEntityId(id);
    eventProducer.fireEvent(event);

    return CommunityUtil.getJSONString(0);
}

// 加精
@PostMapping("/wonderful")
@ResponseBody
public String setWonderful(int id) {
    discussPostService.updateStatus(id, 1);

    // 触发发帖事件
    Event event = new Event()
            .setTopic(TOPIC_PUBLISH)
            .setUserId(hostHolder.getUser().getId())
            .setEntityType(ENTITY_TYPE_POST)
            .setEntityId(id);
    eventProducer.fireEvent(event);

    return CommunityUtil.getJSONString(0);
}

// 删除
@PostMapping("/delete")
@ResponseBody
public String setDelete(int id) {
    discussPostService.updateStatus(id, 2);

    // 触发删帖事件
    Event event = new Event()
            .setTopic(TOPIC_DELETE)
            .setUserId(hostHolder.getUser().getId())
            .setEntityType(ENTITY_TYPE_POST)
            .setEntityId(id);
    eventProducer.fireEvent(event);

    return CommunityUtil.getJSONString(0);
}
```

##### 1.5 修改前端界面

修改 discuss-detail.html 

```html
<div class="float-right">
    <input type="hidden" id="postId" th:value="${post.id}">
    <button type="button" class="btn btn-danger btn-sm" id="topBtn"
            th:disabled="${post.type==1}">置顶
    </button>
    <button type="button" class="btn btn-danger btn-sm" id="wonderfulBtn"
            th:disabled="${post.status==1}">加精
    </button>
    <button type="button" class="btn btn-danger btn-sm" id="deleteBtn"
            th:disabled="${post.status==2}">删除
    </button>
</div>
```

修改 discuss.js

```js
$(function () {
    $("#topBtn").click(setTop);
    $("#wonderfulBtn").click(setWonderful);
    $("#deleteBtn").click(setDelete);
});

function like(btn, entityType, entityId, entityUserId, postId) {
    $.post(
        CONTEXT_PATH + "/like",
        {"entityType": entityType, "entityId": entityId, "entityUserId": entityUserId, "postId": postId},
        function (data) {
            data = $.parseJSON(data);
            if (data.code === 0) {
                $(btn).children("i").text(data.likeCount);
                $(btn).children("b").text(data.likeStatus === 1 ? '已赞' : "赞");
            } else {
                alert(data.msg);
            }
        }
    );
}

// 置顶
function setTop() {
    $.post(
        CONTEXT_PATH + "/discuss/top",
        {"id": $("#postId").val()},
        function (data) {
            data = $.parseJSON(data);
            if (data.code === 0) {
                $("#topBtn").attr("disabled", "disabled");
            } else {
                alert(data.msg);
            }
        }
    );
}

// 加精
function setWonderful() {
    $.post(
        CONTEXT_PATH + "/discuss/wonderful",
        {"id": $("#postId").val()},
        function (data) {
            data = $.parseJSON(data);
            if (data.code === 0) {
                $("#wonderfulBtn").attr("disabled", "disabled");
            } else {
                alert(data.msg);
            }
        }
    );
}

// 删除
function setDelete() {
    $.post(
        CONTEXT_PATH + "/discuss/delete",
        {"id": $("#postId").val()},
        function (data) {
            data = $.parseJSON(data);
            if (data.code === 0) {
                location.href = CONTEXT_PATH + "/index";
            } else {
                alert(data.msg);
            }
        }
    );
}
```

#### 2、权限管理

版主可以执行“置顶”、“加精”操作。管理员可以执行“删除”操作。

在 SecurityConfig 类下配置，置顶、加精、删除的访问权限

```java
@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter implements CommunityConstant {

    @Override
    public void configure(WebSecurity web) throws Exception {
        web.ignoring().antMatchers("/resources/**");
    }

    @Override
    protected void configure(httpecurity http) throws Exception {
        // 授权
        http.authorizeRequests()
                .antMatchers(
                        "/user/setting",
                        "/user/upload",
                        "/discuss/add",
                        "/comment/add/**",
                        "/letter/**",
                        "/notice/**",
                        "/like",
                        "/follow",
                        "/unfollow"
                )
                .hasAnyAuthority(
                        AUTHORITY_USER,
                        AUTHORITY_ADMIN,
                        AUTHORITY_MODERATOR
                )
                .antMatchers(
                        "/discuss/top",
                        "/discuss/wonderful"
                )
                .hasAnyAuthority(
                        AUTHORITY_MODERATOR
                )
                .antMatchers(
                        "/discuss/delete"
                )
                .hasAnyAuthority(
                        AUTHORITY_ADMIN
                )
                .anyRequest().permitAll()
                .and().csrf().disable();

        // 权限不够时的处理
        http.exceptionHandling()
                .authenticationEntryPoint(new AuthenticationEntryPoint() {
                    // 没有登录
                    @Override
                    public void commence(httpervletRequest request, httpervletResponse response, AuthenticationException e) throws IOException, ServletException {
                        String xRequestedWith = request.getHeader("x-requested-with");
                        if ("XMLHttpRequest".equals(xRequestedWith)) {
                            response.setContentType("application/plain;charset=utf-8");
                            PrintWriter writer = response.getWriter();
                            writer.write(CommunityUtil.getJSONString(403, "你还没有登录哦!"));
                        } else {
                            response.sendRedirect(request.getContextPath() + "/login");
                        }
                    }
                })
                .accessDeniedHandler(new AccessDeniedHandler() {
                    // 权限不足
                    @Override
                    public void handle(httpervletRequest request, httpervletResponse response, AccessDeniedException e) throws IOException, ServletException {
                        String xRequestedWith = request.getHeader("x-requested-with");
                        if ("XMLHttpRequest".equals(xRequestedWith)) {
                            response.setContentType("application/plain;charset=utf-8");
                            PrintWriter writer = response.getWriter();
                            writer.write(CommunityUtil.getJSONString(403, "你没有访问此功能的权限!"));
                        } else {
                            response.sendRedirect(request.getContextPath() + "/denied");
                        }
                    }
                });

        // Security底层默认会拦截/logout请求,进行退出处理.
        // 覆盖它默认的逻辑,才能执行我们自己的退出代码.
        http.logout().logoutUrl("/securitylogout");
    }
}
```

#### 3、按钮显示

版主可以看到“置顶”、“加精”按钮。管理员可以看到“删除“按钮。

##### 3.1 引入依赖

```xml
<!-- http://mvnrepository.com/artifact/org.thymeleaf.extras/thymeleaf-extras-springsecurity5 -->
<dependency>
    <groupId>org.thymeleaf.extras</groupId>
    <artifactId>thymeleaf-extras-springsecurity5</artifactId>
</dependency>
```

##### 3.2 修改前端界面

修改 discuss-detail.html

在头部引入语法

```html
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
```

修改标题部分

```html
<div class="float-right">
    <input type="hidden" id="postId" th:value="${post.id}">
    <button type="button" class="btn btn-danger btn-sm" id="topBtn"
            th:disabled="${post.type==1}" sec:authorize="hasAnyAuthority('moderator')">置顶
    </button>
    <button type="button" class="btn btn-danger btn-sm" id="wonderfulBtn"
            th:disabled="${post.status==1}" sec:authorize="hasAnyAuthority('moderator')">加精
    </button>
    <button type="button" class="btn btn-danger btn-sm" id="deleteBtn"
            th:disabled="${post.status==2}" sec:authorize="hasAnyAuthority('admin')">删除
    </button>
</div>
```

##### 3.3 运行结果

用户 nowcoder11

![image-20220720143736006](http://qiniu.dyl.fit/Interview/image-20220720143736006.png)

用户xinghe

![image-20220720143813375](http://qiniu.dyl.fit/Interview/image-20220720143813375.png)

用户aaa

![image-20220720143846479](http://qiniu.dyl.fit/Interview/image-20220720143846479.png)

### 7.4 Redis高级数据类型

#### 1、HyperLoglog

* 采用一种基数算法，用于完成独立总数的统计。
* 占据空间小，无论统计多少个数据，只占12K的内存空间。
* 不精确的统计算法，标准误差为0.81%。

#### 2、Bitmap

* 不是一种独立的数据结构，实际上就是字符串。
* 支持按位存取数据，可以将其看成是byte数组。
* 适合存储大量的连续的数据的布尔值。

测试

在 RedisConfigTest 中添加测试方法

```java
// 统计20万个重复数据的独立总数.
@Test
void testHyperLogLog() {
    String redisKey = "test:hll:01";

    for (int i = 1; i <= 100000; i++) {
        redisTemplate.opsForHyperLogLog().add(redisKey, i);
    }

    for (int i = 1; i <= 100000; i++) {
        int r = (int) (Math.random() * 100000 + 1);
        redisTemplate.opsForHyperLogLog().add(redisKey, r);
    }

    long size = redisTemplate.opsForHyperLogLog().size(redisKey);
    System.out.println(size); // 99553
}

// 将3组数据合并, 再统计合并后的重复数据的独立总数.
@Test
void testHyperLogLogUnion() {
    String redisKey2 = "test:hll:02";
    for (int i = 1; i <= 10000; i++) {
        redisTemplate.opsForHyperLogLog().add(redisKey2, i);
    }

    String redisKey3 = "test:hll:03";
    for (int i = 5001; i <= 15000; i++) {
        redisTemplate.opsForHyperLogLog().add(redisKey3, i);
    }

    String redisKey4 = "test:hll:04";
    for (int i = 10001; i <= 20000; i++) {
        redisTemplate.opsForHyperLogLog().add(redisKey4, i);
    }

    String unionKey = "test:hll:union";
    redisTemplate.opsForHyperLogLog().union(unionKey, redisKey2, redisKey3, redisKey4);

    long size = redisTemplate.opsForHyperLogLog().size(unionKey);
    System.out.println(size); // 19833
}

// 统计一组数据的布尔值
@Test
void testBitMap() {
    String redisKey = "test:bm:01";

    // 记录
    redisTemplate.opsForValue().setBit(redisKey, 1, true);
    redisTemplate.opsForValue().setBit(redisKey, 4, true);
    redisTemplate.opsForValue().setBit(redisKey, 7, true);

    // 查询
    System.out.println(redisTemplate.opsForValue().getBit(redisKey, 0)); // false
    System.out.println(redisTemplate.opsForValue().getBit(redisKey, 1)); // true
    System.out.println(redisTemplate.opsForValue().getBit(redisKey, 2)); // false

    // 统计
    Object obj = redisTemplate.execute(new RedisCallback() {
        @Override
        public Object doInRedis(RedisConnection connection) throws DataAccessException {
            return connection.bitCount(redisKey.getBytes());
        }
    });

    System.out.println(obj); // 3
}

// 统计3组数据的布尔值, 并对这3组数据做OR运算.
@Test
void testBitMapOperation() {
    String redisKey2 = "test:bm:02";
    redisTemplate.opsForValue().setBit(redisKey2, 0, true);
    redisTemplate.opsForValue().setBit(redisKey2, 1, true);
    redisTemplate.opsForValue().setBit(redisKey2, 2, true);

    String redisKey3 = "test:bm:03";
    redisTemplate.opsForValue().setBit(redisKey3, 2, true);
    redisTemplate.opsForValue().setBit(redisKey3, 3, true);
    redisTemplate.opsForValue().setBit(redisKey3, 4, true);

    String redisKey4 = "test:bm:04";
    redisTemplate.opsForValue().setBit(redisKey4, 4, true);
    redisTemplate.opsForValue().setBit(redisKey4, 5, true);
    redisTemplate.opsForValue().setBit(redisKey4, 6, true);

    String redisKey = "test:bm:or";
    Object obj = redisTemplate.execute(new RedisCallback() {
        @Override
        public Object doInRedis(RedisConnection connection) throws DataAccessException {
            connection.bitOp(RedisStringCommands.BitOperation.OR,
                    redisKey.getBytes(), redisKey2.getBytes(), redisKey3.getBytes(), redisKey4.getBytes());
            return connection.bitCount(redisKey.getBytes());
        }
    });

    System.out.println(obj);// 7

    System.out.println(redisTemplate.opsForValue().getBit(redisKey, 0)); // true
    System.out.println(redisTemplate.opsForValue().getBit(redisKey, 1)); // true
    System.out.println(redisTemplate.opsForValue().getBit(redisKey, 2)); // true
    System.out.println(redisTemplate.opsForValue().getBit(redisKey, 3)); // true
    System.out.println(redisTemplate.opsForValue().getBit(redisKey, 4)); // true
    System.out.println(redisTemplate.opsForValue().getBit(redisKey, 5)); // true
    System.out.println(redisTemplate.opsForValue().getBit(redisKey, 6)); // true
    
    
}
```

### 7.5 网站数据统计

#### 1、UV(Unique Visitor)

* 独立访客，需通过用户IP排重新统计数据。
* 每次访问都要进行统计。
* 使用 HyperLoglog,性能好，且存储空间小。

#### 2、DAU(Daily Active User)

* 日活跃用户，需通过用户ID排重新统计数据。
* 访问过一次，则认为其为活跃。
* Bitmap,性能好、且可以统计精确的结果。

#### 3、实现

##### 3.1 修改util

在 RedisKeyUtil 中添加方法

```java
private static final String PREFIX_UV = "uv";
private static final String PREFIX_DAU = "dau";

// 单日UV
public static String getUVKey(String date) {
    return PREFIX_UV + SPLIT + date;
}

// 区间UV
public static String getUVKey(String startDate, String endDate) {
    return PREFIX_UV + SPLIT + startDate + SPLIT + endDate;
}

// 单日活跃用户
public static String getDAUKey(String date) {
    return PREFIX_DAU + SPLIT + date;
}

// 区间活跃用户
public static String getDAUKey(String startDate, String endDate) {
    return PREFIX_DAU + SPLIT + startDate + SPLIT + endDate;
}
```

##### 3.2 新建 DataService

新建 DataService 类进行统计操作

```java
@Service
public class DataService {

    @Resource
    private RedisTemplate redisTemplate;

    private SimpleDateFormat df = new SimpleDateFormat("yyyyMMdd");

    // 将指定的IP计入UV
    public void recordUV(String ip) {
        String redisKey = RedisKeyUtil.getUVKey(df.format(new Date()));
        redisTemplate.opsForHyperLogLog().add(redisKey, ip);
    }

    // 统计指定日期范围内的UV
    public long calculateUV(Date start, Date end) {
        if (start == null || end == null) {
            throw new IllegalArgumentException("参数不能为空!");
        }

        // 整理该日期范围内的key
        List<String> keyList = new ArrayList<>();
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(start);
        while (!calendar.getTime().after(end)) {
            String key = RedisKeyUtil.getUVKey(df.format(calendar.getTime()));
            keyList.add(key);
            calendar.add(Calendar.DATE, 1);
        }

        // 合并这些数据
        String redisKey = RedisKeyUtil.getUVKey(df.format(start), df.format(end));
        redisTemplate.opsForHyperLogLog().union(redisKey, keyList.toArray());

        // 返回统计的结果
        return redisTemplate.opsForHyperLogLog().size(redisKey);
    }

    // 将指定用户计入DAU
    public void recordDAU(int userId) {
        String redisKey = RedisKeyUtil.getDAUKey(df.format(new Date()));
        redisTemplate.opsForValue().setBit(redisKey, userId, true);
    }

    // 统计指定日期范围内的DAU
    public long calculateDAU(Date start, Date end) {
        if (start == null || end == null) {
            throw new IllegalArgumentException("参数不能为空!");
        }

        // 整理该日期范围内的key
        List<byte[]> keyList = new ArrayList<>();
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(start);
        while (!calendar.getTime().after(end)) {
            String key = RedisKeyUtil.getDAUKey(df.format(calendar.getTime()));
            keyList.add(key.getBytes());
            calendar.add(Calendar.DATE, 1);
        }

        // 进行OR运算
        return (long) redisTemplate.execute(new RedisCallback() {
            @Override
            public Object doInRedis(RedisConnection connection) throws DataAccessException {
                String redisKey = RedisKeyUtil.getDAUKey(df.format(start), df.format(end));
                connection.bitOp(RedisStringCommands.BitOperation.OR,
                        redisKey.getBytes(), keyList.toArray(new byte[0][0]));
                return connection.bitCount(redisKey.getBytes());
            }
        });
    }
}
```

##### 3.3 新建拦截器

在 interceptor 包内新建 DataInterceptor

```java
@Component
public class DataInterceptor implements HandlerInterceptor {

    @Resource
    private DataService dataService;

    @Resource
    private HostHolder hostHolder;

    @Override
    public boolean preHandle(httpervletRequest request, httpervletResponse response, Object handler) throws Exception {
        // 统计UV
        String ip = request.getRemoteHost();
        dataService.recordUV(ip);

        // 统计DAU
        User user = hostHolder.getUser();
        if (user != null) {
            dataService.recordDAU(user.getId());
        }

        return true;
    }
}
```

##### 3.4 配置拦截器

在 WebMvcConfig 中添加该拦截器

```java
@Resource
private DataInterceptor dataInterceptor;

@Override
public void addInterceptors(InterceptorRegistry registry) {
    registry.addInterceptor(alphaInterceptor)
        .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg")
        .addPathPatterns("/register", "/login");

    registry.addInterceptor(loginTicketInterceptor)
        .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg");

    //        registry.addInterceptor(loginRequiredInterceptor)
    //                .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg");

    registry.addInterceptor(messageInterceptor)
        .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg");

    registry.addInterceptor(dataInterceptor)
        .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg");
}
```

##### 3.5 新建 controller

```java
@Controller
public class DataController {

    @Resource
    private DataService dataService;

    // 统计页面
    @RequestMapping(path = "/data", method = {RequestMethod.GET, RequestMethod.POST})
    public String getDataPage() {
        return "/site/admin/data";
    }

    // 统计网站UV
    @PostMapping("/data/uv")
    public String getUV(@DateTimeFormat(pattern = "yyyy-MM-dd") Date start,
                        @DateTimeFormat(pattern = "yyyy-MM-dd") Date end, Model model) {
        long uv = dataService.calculateUV(start, end);

        model.addAttribute("uvResult", uv);
        model.addAttribute("uvStartDate", start);
        model.addAttribute("uvEndDate", end);
        return "forward:/data";
    }

    // 统计活跃用户网站DAU
    @PostMapping("/data/dau")
    public String getDAU(@DateTimeFormat(pattern = "yyyy-MM-dd") Date start,
                         @DateTimeFormat(pattern = "yyyy-MM-dd") Date end, Model model) {
        long dau = dataService.calculateDAU(start, end);

        model.addAttribute("dauResult", dau);
        model.addAttribute("dauStartDate", start);
        model.addAttribute("dauEndDate", end);
        return "forward:/data";
    }

}
```

> 返回时使用 forward 转发，表明当前请求仅完成一半，还需另外一个方法继续处理请求。

##### 3.6 权限控制

在 SecurityConfig 中添加权限控制

```java
.antMatchers(
        "/discuss/delete",
        "/data/**"
)
.hasAnyAuthority(
        AUTHORITY_ADMIN
)
```

##### 3.7 运行结果

![动画18](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB18.gif)

### 7.6 任务执行和调度

#### 1、JDK 线程池

* ExecutorService
* ScheduledExecutorService(可以执行定时任务)

```java
@SpringBootTest
class ThreadPoolTests {

    private static final Logger logger = LoggerFactory.getLogger(ThreadPoolTests.class);

    // JDK普通线程池
    private ExecutorService executorService = Executors.newFixedThreadPool(5);

    // JDK可执行定时任务的线程池
    private ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(5);

    private void sleep(long m) {
        try {
            Thread.sleep(m);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }

    // 1.JDK普通线程池
    @Test
    void testExecutorService() {
        Runnable task = new Runnable() {
            @Override
            public void run() {
                logger.debug("Hello ExecutorService");
            }
        };

        for (int i = 0; i < 10; i++) {
            executorService.submit(task);
        }

        sleep(10000);
    }

    // 2.JDK定时任务线程池
    @Test
    void testScheduledExecutorService() {
        Runnable task = new Runnable() {
            @Override
            public void run() {
                logger.debug("Hello ScheduledExecutorService");
            }
        };

        scheduledExecutorService.scheduleAtFixedRate(task, 10000, 1000, TimeUnit.MILLISECONDS);

        sleep(30000);
    }
}
```

#### 2、Spring 线程池

* ThreadPoolTaskExecutor
* ThreadPoolTaskScheduler（分布式环境可能出问题）

配置 application.yaml

```yaml
# TaskExecutionProperties
spring:
    task:
      execution:
        pool:
          core-size: 5
          max-size: 15
          queue-capacity: 100
      # TaskSchedulingProperties
      scheduling:
        pool:
          size: 5
```

添加 ThreadPoolConfig

```java
@Configuration
@EnableScheduling
@EnableAsync
public class ThreadPoolConfig {
}
```

在测试类中注入

```java
// Spring普通线程池
@Resource
private ThreadPoolTaskExecutor taskExecutor;

// Spring可执行定时任务的线程池
@Resource
private ThreadPoolTaskScheduler taskScheduler;
```

添加方法

```java
// 3.Spring普通线程池
@Test
void testThreadPoolTaskExecutor() {
    Runnable task = new Runnable() {
        @Override
        public void run() {
            logger.debug("Hello ThreadPoolTaskExecutor");
        }
    };

    for (int i = 0; i < 10; i++) {
        taskExecutor.submit(task);
    }

    sleep(10000);
}

// 4.Spring定时任务线程池
@Test
void testThreadPoolTaskScheduler() {
    Runnable task = new Runnable() {
        @Override
        public void run() {
            logger.debug("Hello ThreadPoolTaskScheduler");
        }
    };

    Date startTime = new Date(System.currentTimeMillis() + 10000);
    taskScheduler.scheduleAtFixedRate(task, startTime, 1000);

    sleep(30000);
}
```

简化方法

先在 AlphaService 中添加方法

```java
// 让该方法在多线程环境下,被异步的调用.
@Async
public void execute1() {
    logger.debug("execute1");
}

@Scheduled(initialDelay = 10000, fixedRate = 1000)
public void execute2() {
    logger.debug("execute2");
}
```

在测试类中添加方法

```java
// 5.Spring普通线程池(简化)
@Test
void testThreadPoolTaskExecutorSimple() {
    for (int i = 0; i < 10; i++) {
        alphaService.execute1();
    }

    sleep(10000);
}

// 6.Spring定时任务线程池(简化)
@Test
void testThreadPoolTaskSchedulerSimple() {
    sleep(30000);
}
```

#### 3、分布式定时任务

* Spring Quartz（将数据存储到数据库，分布式时可以共享数据）
  * 核心调度接口Scheduler
  * 定义任务的接口Job的execute方法
  * Jobdetail接口来配置Job的名字、组等
  * Trigger接口配置Job的什么时候运行、运行频率
  * QuartzConfig：配置 -> 数据库 -> 调用

* FactoryBean可简化Bean的实例化过程:
  1. 通过FactoryBean封装Bean的实例化过程
  2. 将FactoryBean装配到Spring容器里
  3. 将FactoryBean注入给其他的Bean.
  4. 该Bean得到的是FactoryBean所管理的对象实例

##### 3.1 引入依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-quartz</artifactId>
</dependency>
```

##### 3.2 创建定时任务

创建 quartz 包，并在包内新建 AlphaJob

```java
public class AlphaJob implements Job {
    @Override
    public void execute(JobExecutionContext context) throws JobExecutionException {
        System.out.println(Thread.currentThread().getName() + ": execute a quartz job.");
    }
}
```

##### 3.3 添加定时任务配置

创建 QuartzConfig

```java
@Configuration
public class QuartzConfig {

    // FactoryBean可简化Bean的实例化过程:
    // 1.通过FactoryBean封装Bean的实例化过程.
    // 2.将FactoryBean装配到Spring容器里.
    // 3.将FactoryBean注入给其他的Bean.
    // 4.该Bean得到的是FactoryBean所管理的对象实例.

    // 配置JobDetail
    @Bean
    public JobDetailFactoryBean alphaJobDetail() {
        JobDetailFactoryBean factoryBean = new JobDetailFactoryBean();
        factoryBean.setJobClass(AlphaJob.class);
        factoryBean.setName("alphaJob");
        factoryBean.setGroup("alphaJobGroup");
        factoryBean.setDurability(true);
        factoryBean.setRequestsRecovery(true);
        return factoryBean;
    }

    // 配置Trigger(SimpleTriggerFactoryBean, CronTriggerFactoryBean)
    @Bean
    public SimpleTriggerFactoryBean alphaTrigger(JobDetail alphaJobDetail) {
        SimpleTriggerFactoryBean factoryBean = new SimpleTriggerFactoryBean();
        factoryBean.setJobDetail(alphaJobDetail);
        factoryBean.setName("alphaTrigger");
        factoryBean.setGroup("alphaTriggerGroup");
        factoryBean.setRepeatInterval(3000);
        factoryBean.setJobDataMap(new JobDataMap());
        return factoryBean;
    }
}
```

##### 3.4 配置 application.yaml

在 application.yaml 中添加 QuartzProperties

```yaml
# QuartzProperties
spring: 
    quartz:
      #相关属性配置
      properties:
        org:
          quartz:
            scheduler:
              instanceName: clusteredScheduler
              instanceId: AUTO
            jobStore:
              class: org.quartz.impl.jdbcjobstore.JobStoreTX
              driverDelegateClass: org.quartz.impl.jdbcjobstore.StdJDBCDelegate
              tablePrefix: QRTZ_
              isClustered: true
              clusterCheckinInterval: 10000
              useProperties: false
            threadPool:
              class: org.quartz.simpl.SimpleThreadPool
              threadCount: 10
              threadPriority: 5
              threadsInheritContextClassLoaderOfInitializingThread: true
      #数据库方式
      job-store-type: jdbc
      #初始化表结构
      #jdbc:
      #initialize-schema: never
```

##### 3.5 删除任务

创建 AlphaJob 的测试类

```java
@SpringBootTest
class AlphaJobTest {

    @Resource
    private Scheduler scheduler;

    @Test
    void testDeleteJob() {
        try {
            boolean result = scheduler.deleteJob(new JobKey("alphaJob", "alphaJobGroup"));
            System.out.println(result);
        } catch (SchedulerException e) {
            e.printStackTrace();
        }
    }
}
```

### 7.7 热贴排行

log(精华分 + 评论数 * 10 + 点赞数 * 2)+（发布时间 - 牛客纪元）

在发帖、点赞、加精时计算帖子分数（存入 Redis 中）

#### 1、实现定时任务

##### 1.1 修改 RedisKeyUtil 

在 RedisKeyUtil 中添加方法

```java
private static final String PREFIX_POST = "post";

// 帖子分数
public static String getPostScoreKey() {
    return PREFIX_POST + SPLIT + "score";
}
```

##### 1.2 修改 controller

在 DiscussPostController 中添加计算帖子分数的方法

先注入 RedisTemplate

```java
@Resource
private RedisTemplate redisTemplate;
```

然后修改 add() 方法

```java
@PostMapping("/add")
@ResponseBody
public String addDiscussPost(String title, String content) {

    User user = hostHolder.getUser();
    if (user == null) {
        return CommunityUtil.getJSONString(403, "你还没有登录！");
    }

    DiscussPost post = new DiscussPost();
    post.setUserId(user.getId());
    post.setTitle(title);
    post.setContent(content);
    post.setCreateTime(new Date());
    discussPostService.addDiscussPost(post);

    // 触发发帖事件
    Event event = new Event()
            .setTopic(TOPIC_PUBLISH)
            .setUserId(user.getId())
            .setEntityType(ENTITY_TYPE_POST)
            .setEntityId(post.getId());
    eventProducer.fireEvent(event);

    // 计算帖子分数
    String redisKey = RedisKeyUtil.getPostScoreKey();
    redisTemplate.opsForSet().add(redisKey, post.getId());

    //报错情况,将来统一处理
    return CommunityUtil.getJSONString(0, "发布成功！");
}
```

以及加精方法

```java
// 加精
@PostMapping("/wonderful")
@ResponseBody
public String setWonderful(int id) {
    discussPostService.updateStatus(id, 1);

    // 触发发帖事件
    Event event = new Event()
            .setTopic(TOPIC_PUBLISH)
            .setUserId(hostHolder.getUser().getId())
            .setEntityType(ENTITY_TYPE_POST)
            .setEntityId(id);
    eventProducer.fireEvent(event);

    // 计算帖子分数
    String redisKey = RedisKeyUtil.getPostScoreKey();
    redisTemplate.opsForSet().add(redisKey, id);

    return CommunityUtil.getJSONString(0);
}
```

在 CommentController 中添加计算帖子分数的方法

```java
@Resource
private RedisTemplate redisTemplate;

@PostMapping("/add/{discussPostId}")
public String addComment(@PathVariable("discussPostId") int discussPostId, Comment comment) {
    comment.setUserId(hostHolder.getUser().getId());
    comment.setStatus(0);
    comment.setCreateTime(new Date());
    commentService.addComment(comment);

    //触发评论事件
    Event event = new Event()
            .setTopic(TOPIC_COMMENT)
            .setUserId(hostHolder.getUser().getId())
            .setEntityType(comment.getEntityType())
            .setEntityId(comment.getEntityId())
            .setData("postId", discussPostId);
    if (comment.getEntityType() == ENTITY_TYPE_POST) {
        DiscussPost target = discussPostService.findDiscussPostById(comment.getEntityId());
        event.setEntityUserId(target.getUserId());
    } else if (comment.getEntityType() == ENTITY_TYPE_COMMENT) {
        Comment target = commentService.findCommentById(comment.getEntityId());
        event.setEntityUserId(target.getUserId());
    }
    eventProducer.fireEvent(event);

    if (comment.getEntityType() == ENTITY_TYPE_POST) {
        // 触发发帖事件
        event = new Event()
                .setTopic(TOPIC_PUBLISH)
                .setUserId(comment.getUserId())
                .setEntityType(ENTITY_TYPE_POST)
                .setEntityId(discussPostId);
        eventProducer.fireEvent(event);

        // 计算帖子分数
        String redisKey = RedisKeyUtil.getPostScoreKey();
        redisTemplate.opsForSet().add(redisKey, discussPostId);
    }

    return "redirect:/discuss/detail/" + discussPostId;
}
```

在 LikeController 中添加计算帖子分数的方法

```java
@Resource
private RedisTemplate redisTemplate;

@PostMapping("/like")
@ResponseBody
public String like(int entityType, int entityId, int entityUserId, int postId) {
    User user = hostHolder.getUser();

    // 点赞
    likeService.like(user.getId(), entityType, entityId, entityUserId);
    // 数量
    long likeCount = likeService.findEntityLikeCount(entityType, entityId);
    // 状态
    int likeStatus = likeService.findEntityLikeStatus(user.getId(), entityType, entityId);
    // 返回结果
    Map<String, Object> map = new HashMap<>();
    map.put("likeCount", likeCount);
    map.put("likeStatus", likeStatus);

    // 触发点赞事件
    if (likeStatus == 1) {
        Event event = new Event()
                .setTopic(TOPIC_LIKE)
                .setUserId(hostHolder.getUser().getId())
                .setEntityType(entityType)
                .setEntityId(entityId)
                .setEntityUserId(entityUserId)
                .setData("postId", postId);
        eventProducer.fireEvent(event);
    }

    if (entityType == ENTITY_TYPE_POST) {
        // 计算帖子分数
        String redisKey = RedisKeyUtil.getPostScoreKey();
        redisTemplate.opsForSet().add(redisKey, postId);
    }

    return CommunityUtil.getJSONString(0, null, map);
}
```

##### 1.3 新建 PostScoreRefreshJob

实现接口 implements Job, CommunityConstant

```java
public class PostScoreRefreshJob implements Job, CommunityConstant {
    
    private static final Logger logger = LoggerFactory.getLogger(PostScoreRefreshJob.class);

    @Resource
    private RedisTemplate redisTemplate;

    @Resource
    private DiscussPostService discussPostService;

    @Resource
    private LikeService likeService;

    @Resource
    private ElasticsearchService elasticsearchService;

    // 论坛创建时间
    private static final Date epoch;

    static {
        try {
            epoch = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").parse("2021-09-24 00:00:00");
        } catch (ParseException e) {
            throw new RuntimeException("初始化论坛创建时间失败");
        }
    }

    @Override
    public void execute(JobExecutionContext context) throws JobExecutionException {
        String redisKey = RedisKeyUtil.getPostScoreKey();
        BoundSetOperations operations = redisTemplate.boundSetOps(redisKey);

        if (operations.size() == 0) {
            logger.info("任务取消！没有需要刷新的帖子");
            return;
        }

        logger.info("任务开始！正在刷新帖子分数：" + operations.size());

        while (operations.size() > 0) {
            this.refresh((Integer) operations.pop());
        }
        logger.info("任务结束！帖子分数刷新完毕！");

    }

    private void refresh(int postId) {
        DiscussPost post = discussPostService.findDiscussPostById(postId);

        if (post == null) {
            logger.error("该帖子不存在：id = " + postId);

            return;
        }

        // 是否加精
        boolean wonderful = post.getStatus() == 1;
        //评论数量
        int commentCount = post.getCommentCount();
        //点赞数量
        long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, postId);

        // 计算权重
        double w = (wonderful ? 75 : 0) + commentCount * 10 + likeCount * 2;

        // 分数 = 帖子权重 + 距离天数
        double score = Math.log10(Math.max(w, 1)) + (post.getCreateTime().getTime() - epoch.getTime()) / (1000 * 3600 * 24);

        // 更新帖子分数
        discussPostService.updateScore(postId, score);

        // 同步搜索数据
        post.setScore(score);
        elasticsearchService.saveDiscussPost(post);
    }
}
```

此时要在 DiscussPostMapper 中添加方法

```java
int updateScore(int id, double score);
```

配置相应的 sql 语句

```xml
<update id="updateScore">
    update discuss_post
    set score = #{score}
    where id = #{id}
</update>
```

在 DiscussPostService 中添加方法

```java
public int updateScore(int id, double score) {
    return discussPostMapper.updateScore(id, score);
}
```

##### 1.4 配置定时任务

```java
@Configuration
public class QuartzConfig {

    // FactoryBean可简化Bean的实例化过程:
    // 1.通过FactoryBean封装Bean的实例化过程.
    // 2.将FactoryBean装配到Spring容器里.
    // 3.将FactoryBean注入给其他的Bean.
    // 4.该Bean得到的是FactoryBean所管理的对象实例.

    // 配置JobDetail
//    @Bean
    public JobDetailFactoryBean alphaJobDetail() {
        JobDetailFactoryBean factoryBean = new JobDetailFactoryBean();
        factoryBean.setJobClass(AlphaJob.class);
        factoryBean.setName("alphaJob");
        factoryBean.setGroup("alphaJobGroup");
        factoryBean.setDurability(true);
        factoryBean.setRequestsRecovery(true);
        return factoryBean;
    }

    // 配置Trigger(SimpleTriggerFactoryBean, CronTriggerFactoryBean)
//    @Bean
    public SimpleTriggerFactoryBean alphaTrigger(JobDetail alphaJobDetail) {
        SimpleTriggerFactoryBean factoryBean = new SimpleTriggerFactoryBean();
        factoryBean.setJobDetail(alphaJobDetail);
        factoryBean.setName("alphaTrigger");
        factoryBean.setGroup("alphaTriggerGroup");
        factoryBean.setRepeatInterval(3000);
        factoryBean.setJobDataMap(new JobDataMap());
        return factoryBean;
    }

    // 刷新帖子分数任务
    @Bean
    public JobDetailFactoryBean postScoreRefreshJobDetail() {
        JobDetailFactoryBean factoryBean = new JobDetailFactoryBean();
        factoryBean.setJobClass(PostScoreRefreshJob.class);
        factoryBean.setName("postScoreRefreshJob");
        factoryBean.setGroup("communityJobGroup");
        factoryBean.setDurability(true);
        factoryBean.setRequestsRecovery(true);
        return factoryBean;
    }

    @Bean
    public SimpleTriggerFactoryBean postScoreRefreshTrigger(JobDetail postScoreRefreshJobDetail) {
        SimpleTriggerFactoryBean factoryBean = new SimpleTriggerFactoryBean();
        factoryBean.setJobDetail(postScoreRefreshJobDetail);
        factoryBean.setName("postScoreRefreshTrigger");
        factoryBean.setGroup("communityTriggerGroup");
        factoryBean.setRepeatInterval(1000 * 60 * 5);
        factoryBean.setJobDataMap(new JobDataMap());
        return factoryBean;
    }
}
```

>这里可以把之前测试定时任务配置的 AlphaService 中的 execute2() 注释掉，因为这个定时任务会一直启动，但是和我们的项目没有关系
>
>```java
>/*@Scheduled(initialDelay = 10000, fixedRate = 1000)*/
>public void execute2() {
>    logger.debug("execute2");
>}
>```

##### 1.5 运行结果

![image-20220721091152928](http://qiniu.dyl.fit/Interview/image-20220721091152928.png)

![image-20220721091136608](http://qiniu.dyl.fit/Interview/image-20220721091136608.png)

#### 2、实现热帖排行

修改帖子按照热度来排序显示

##### 2.1 重构 DiscussPostMapper

重构 DiscussPostMapper 中的查询帖子方法，增加一个参数来决定是按照时间排序还是热度排序

```java
List<DiscussPost> selectDiscussPosts(int userId, int offset, int limit, int orderMode);
```

修改相应的 sql 语句

```xml
<select id="selectDiscussPosts" resultType="DiscussPost">
    select
    <include refid="selectFields"/>
    from discuss_post
    where status != 2
    <if test="userId!=0">
        and user_id = #{userId}
    </if>
    <if test="orderMode==0">
        order by type desc, create_time desc
    </if>
    <if test="orderMode==1">
        order by type desc, score desc, create_time desc
    </if>
    limit #{offset}, #{limit}
</select>
```

##### 2.2 重构 DiscussPostService

重构 DiscussPostService 中的方法

```java
public List<DiscussPost> findDiscussPosts(int userId, int offset, int limit, int orderMode) {
    return discussPostMapper.selectDiscussPosts(userId, offset, limit,orderMode);
}
```

选中该方法，查看使用此方法的显示层的方法

![image-20220721092246330](http://qiniu.dyl.fit/Interview/image-20220721092246330.png)

显示 HomeController 使用了该方法

##### 2.3 重构 HomeController

重构 HomeController 的 getIndexPage() 方法

```java
@GetMapping("/index")
public String getIndexPage(Model model, Page page, @RequestParam(name = "orderMode", defaultValue = "0") int orderMode) {
    // 方法调用之前,SpringMVC会自动实例化Model和Page,并将Page注入Model.
    // 所以,在thymeleaf中可以直接访问Page对象中的数据.
    page.setRows(discussPostservice.findDiscussPostRows(0));
    page.setPath("/index?orderMode=" + orderMode);

    List<DiscussPost> list = discussPostservice.findDiscussPosts(0, page.getOffset(), page.getLimit(), orderMode);
    List<Map<String, Object>> discussPosts = new ArrayList<>();
    if (list != null) {
        for (DiscussPost post : list) {
            Map<String, Object> map = new HashMap<>();
            map.put("post", post);
            User user = userService.findUserById(post.getUserId());
            map.put("user", user);

            long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId());
            map.put("likeCount", likeCount);

            discussPosts.add(map);
        }
    }
    model.addAttribute("discussPosts", discussPosts);
    model.addAttribute("orderMode", orderMode);

    return "/index";
}
```

##### 2.4 修改前端界面

修改 index.html

```html
<!-- 筛选条件 -->
<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <a th:class="|nav-link ${orderMode==0?'active':''}|" th:href="@{/index(orderMode=0)}">最新</a>
    </li>
    <li class="nav-item">
        <a th:class="|nav-link ${orderMode==1?'active':''}|" th:href="@{/index(orderMode=1)}">最热</a>
    </li>
</ul>
```

##### 2.5 修改测试类

修改测试类由于增加参数而导致的错误

修改 DiscussPostMapperTest

```java
@Test
void testSelectPosts() {
    List<DiscussPost> list = discussPostMapper.selectDiscussPosts(149, 0, 10,0);
    for (DiscussPost post : list) {
        System.out.println(post);
    }
    // DiscussPost{id=280, userId=149, title='事务', content='事务的4个特性，包括原子性、一致性、隔离性、持久性。', type=0, status=0, createTime=Mon May 20 17:41:30 CST 2019, commentCount=16, score=1755.2095150145426}
    // DiscussPost{id=277, userId=149, title='Spring Cache', content='Spring Cache RedisCacheManager', type=0, status=0, createTime=Fri May 17 17:06:54 CST 2019, commentCount=38, score=1752.5797835966168}
    // DiscussPost{id=276, userId=149, title='新人报道', content='新人报道，请多关照！', type=0, status=0, createTime=Fri May 17 15:50:18 CST 2019, commentCount=6, score=1751.806179973984}


    int rows = discussPostMapper.selectDiscussPostRows(149);
    System.out.println(rows);
    // 3
}
```

修改 DiscussPostRepositoryTest

```java
@Test
void testInsertList() {
    discussPostRepository.saveAll(discussPostMapper.selectDiscussPosts(103, 0, 100,0));
    discussPostRepository.saveAll(discussPostMapper.selectDiscussPosts(111, 0, 100,0));
    discussPostRepository.saveAll(discussPostMapper.selectDiscussPosts(112, 0, 100,0));
    discussPostRepository.saveAll(discussPostMapper.selectDiscussPosts(131, 0, 100,0));
    discussPostRepository.saveAll(discussPostMapper.selectDiscussPosts(132, 0, 100,0));
    discussPostRepository.saveAll(discussPostMapper.selectDiscussPosts(133, 0, 100,0));
    discussPostRepository.saveAll(discussPostMapper.selectDiscussPosts(134, 0, 100,0));
}
```

##### 2.6 运行结果

![image-20220721092912970](http://qiniu.dyl.fit/Interview/image-20220721092912970.png)

![image-20220721092925823](http://qiniu.dyl.fit/Interview/image-20220721092925823.png)

### 7.8 生成长图（TODO）

#### 1、软件安装配置

##### 1.1 软件链接

链接：http://pan.baidu.com/s/1ddQWZ_hxFiH21fSbNK_Ffg 提取码：5rz5 

##### 1.2 配置环境变量

在 Path 中 添加相应的 bin 目录 

##### 1.3 命令行演示

html->pdf

![image-20220721094422492](http://qiniu.dyl.fit/Interview/image-20220721094422492.png)

html->image （压缩质量为75%)

![image-20220721094837012](http://qiniu.dyl.fit/Interview/image-20220721094837012.png)

#### 2、程序实现

##### 2.1 新建测试类

```java
public class WkTests {

    public static void main(String[] args) {
        String cmd = "D:/APP/wkhtmltopdf/bin/wkhtmltoimage  http://blog.dyl.fit D:/Learn/data/community/wk-images/3.png";
        try {
            Runtime.getRuntime().exec(cmd);
            System.out.println("ok.");
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

##### 2.2 配置 application.yaml

```yaml
# wk
wk:
  image:
    command: D:/APP/wkhtmltopdf/bin/wkhtmltoimage
    storage: D:/Learn/data/community/wk-images
  pdf:
    command: D:/APP/wkhtmltopdf/bin/wkhtmltopdf
    storage: D:/Learn/data/community/wk-pdfs
```

##### 2.3 创建 WkConfig

```java
@Configuration
public class WkConfig {

    public static final Logger logger = LoggerFactory.getLogger(WkConfig.class);

    @Value("${wk.image.storage}")
    private String wkImageStorage;

    @Value("${wk.pdf.storage}")
    private String wkPdfStorage;

    @PostConstruct
    public void init() {
        // 创建wk图片目录
        File file = new File(wkImageStorage);
        if (!file.exists()) {
            file.mkdir();
            logger.info("创建wk图片目录：" + wkImageStorage);
        }

        File file1 = new File(wkPdfStorage);
        if (!file1.exists()) {
            file1.mkdir();
            logger.info("创建wkPDF目录：" + wkPdfStorage);
        }
    }
}
```

##### 2.4 创建 ShareController

在 CommunityConstant 中添加常量

```java
/**
 * 主题：分享
 */
String TOPIC_SHARE = "share";
```

创建 ShareController，实现 CommunityConstant 接口

```java
@Controller
public class ShareController implements CommunityConstant {

    private static final Logger logger = LoggerFactory.getLogger(ShareController.class);

    @Resource
    private EventProducer eventProducer;

    @Value("${community.path.domain}")
    private String domain;

    @Value("${server.servlet.context-path}")
    private String contextPath;

    @Value("${wk.image.storage}")
    private String wkImageStorage;

    @Value("${wk.pdf.storage}")
    private String wkPdfStorage;

    @GetMapping("/share")
    @ResponseBody
    public String share(String htmlUrl) {
        // 文件名
        String fileName = CommunityUtil.generateUUID();

        // 异步生成长图
        Event event = new Event()
                .setTopic(TOPIC_SHARE)
                .setData("htmlUrl", htmlUrl)
                .setData("fileName", fileName)
                .setData("suffix", ".png");
        eventProducer.fireEvent(event);

        // 返回访问路径
        Map<String, Object> map = new HashMap<>();
        map.put("shareUrl", domain + contextPath + "/share/image/" + fileName);

        return CommunityUtil.getJSONString(0, null, map);
    }
}
```

##### 2.5 创建消费分享事件

在 EventConsumer 中添加消费分享事件

```java
// 消费分享事件
@KafkaListener(topics = {TOPIC_SHARE})
public void handleShareMessage(ConsumerRecord record) {
    if (record == null || record.value() == null) {
        logger.error("消息的内容为空!");
        return;
    }

    Event event = JSONObject.parseObject(record.value().toString(), Event.class);
    if (event == null) {
        logger.error("消息格式错误!");
        return;
    }

    String htmlUrl = (String) event.getData().get("htmlUrl");
    String fileName = (String) event.getData().get("fileName");
    String suffix = (String) event.getData().get("suffix");
    String cmd = wkImageCommand + " --quality 75 " + htmlUrl + " " + wkImageStorage + "/" + fileName + suffix;

    try {
        Runtime.getRuntime().exec(cmd);
        logger.info("生成长图成功：" + cmd);
    } catch (IOException e) {
        logger.error("生成长图失败：" + e.getMessage());
    }
}
```

##### 2.6 运行结果

在浏览器中输入 http://localhost:8080/community/share?htmlUrl=http://www.nowcoder.com

![image-20220721104844054](http://qiniu.dyl.fit/Interview/image-20220721104844054.png)

点击产生的链接 http://127.0.0.1:8080/community/share/image/1cf7c13d6394448e9e42bf02e6306ca0

在浏览器中可以显示图片

### 7.9 将文件上传至云服务器

* 客户端上传
  * 客户端将数据提交给云服务器，并等待其响应。
  * 用户上传头像时，将表单数据提交给云服务器。

* 服务器直传
  * 应用服务器将数据直接提交给云服务器，并等待其响应。
  * 分享时，服务端将自动生成的图片，直接提交给云服务器。

#### 1、客户端上传

##### 1.1 引入七牛云依赖

```xml
<dependency>
    <groupId>com.qiniu</groupId>
    <artifactId>qiniu-java-sdk</artifactId>
    <version>7.2.23</version>
</dependency>
```

##### 1.2 配置七牛云

```yaml
# qiniu
qiniu:
  key:
    access: xxx
    secret: xxx
  bucket:
    header:
      name: dyl-community-header
      url: http://community.header.img.dyl.fit
    share:
      name: dyl-community-share
      url: http://community.share.img.dyl.fit
```

##### 1.3 修改 controller

修改 UserController

注入七牛云的内容

```java
@Value("${qiniu.key.access}")
private String accessKey;

@Value("${qiniu.key.secret}")
private String secretKey;

@Value("${qiniu.bucket.header.name}")
private String headerBucketName;

@Value("${qiniu.bucket.header.url}")
private String headerBucketUrl;
```

重构方法 getSettingPage() ,并添加 updateHeaderUrl() 方法

```java
@LoginRequired
@GetMapping("/setting")
public String getSettingPage(Model model) {

    // 上传文件名称
    String fileName = CommunityUtil.generateUUID();
    // 设置响应信息
    StringMap policy = new StringMap();
    policy.put("returnBody", CommunityUtil.getJSONString(0));

    // 生成上传凭证
    Auth auth = Auth.create(accessKey, secretKey);
    String uploadToken = auth.uploadToken(headerBucketName, fileName, 3600, policy);

    model.addAttribute("uploadToken", uploadToken);
    model.addAttribute("fileName", fileName);

    return "/site/setting";
}

// 更新头像路径
@PostMapping("/header/url")
@ResponseBody
public String updateHeaderUrl(String fileName) {
    if (StringUtils.isBlank(fileName)) {
        return CommunityUtil.getJSONString(1, "文件名不能为空");
    }

    String url = headerBucketUrl + "/" + fileName;
    userService.updateHeader(hostHolder.getUser().getId(), url);

    return CommunityUtil.getJSONString(0);
}
```

##### 1.4 修改前端界面

修改 setting.html

将原来的部分代码注释掉，改为新的上传到七牛云

```html
<!--上传到七牛云-->
<form class="mt-5" id="uploadForm">
    <div class="form-group row mt-4">
        <label for="head-image" class="col-sm-2 col-form-label text-right">选择头像:</label>
        <div class="col-sm-10">
            <div class="custom-file">
                <input type="hidden" name="token" th:value="${uploadToken}">
                <input type="hidden" name="key" th:value="${fileName}">
                <input type="file" class="custom-file-input" id="head-image" name="file" lang="es"
                       required="">
                <label class="custom-file-label" for="head-image" data-browse="文件">选择一张图片</label>
                <div class="invalid-feedback"></div>
            </div>
        </div>
    </div>
    <div class="form-group row mt-4">
        <div class="col-sm-2"></div>
        <div class="col-sm-10 text-center">
            <button type="submit" class="btn btn-info text-white form-control">立即上传</button>
        </div>
    </div>
</form>
```

添加 setting.js

```js
$(function () {
    $("#uploadForm").submit(upload);
});

function upload() {
    $.ajax({
        url: "https://upload-z1.qiniup.com",
        method: "post",
        processData: false,
        contentType: false,
        data: new FormData($("#uploadForm")[0]),
        success: function (data) {
            if (data && data.code === 0) {
                // 更新头像访问路径
                $.post(
                    CONTEXT_PATH + "/user/header/url",
                    {"fileName": $("input[name='key']").val()},
                    function (data) {
                        data = $.parseJSON(data);
                        if (data.code === 0) {
                            window.location.reload();
                        } else {
                            alert(data.msg);
                        }
                    }
                );
            } else {
                alert("上传失败！");
            }
        }
    });

    return false;
}
```

然后在 setting.html 页脚处添加 js 引入

```html
<script th:src="@{/js/setting.js}"></script>
```

##### 1.5 运行结果

![动画19](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB19.gif)

#### 2、服务器直传

##### 2.1 修改 ShareController

```java
@Value("${qiniu.bucket.share.url}")
private String shareBucketUrl;
```

```java
    @GetMapping("/share")
    @ResponseBody
    public String share(String htmlUrl) {
        // 文件名
        String fileName = CommunityUtil.generateUUID();

        // 异步生成长图
        Event event = new Event()
                .setTopic(TOPIC_SHARE)
                .setData("htmlUrl", htmlUrl)
                .setData("fileName", fileName)
                .setData("suffix", ".png");
        eventProducer.fireEvent(event);

        // 返回访问路径
        Map<String, Object> map = new HashMap<>();
//        map.put("shareUrl", domain + contextPath + "/share/image/" + fileName);
        map.put("shareUrl", shareBucketUrl + "/" + fileName);

        return CommunityUtil.getJSONString(0, null, map);
    }
```

##### 2.2 修改消费分享事件

```java
// 消费分享事件
@KafkaListener(topics = {TOPIC_SHARE})
public void handleShareMessage(ConsumerRecord record) {
    if (record == null || record.value() == null) {
        logger.error("消息的内容为空!");
        return;
    }

    Event event = JSONObject.parseObject(record.value().toString(), Event.class);
    if (event == null) {
        logger.error("消息格式错误!");
        return;
    }

    String htmlUrl = (String) event.getData().get("htmlUrl");
    String fileName = (String) event.getData().get("fileName");
    String suffix = (String) event.getData().get("suffix");
    String cmd = wkImageCommand + " --quality 75 " + htmlUrl + " " + wkImageStorage + "/" + fileName + suffix;

    try {
        Runtime.getRuntime().exec(cmd);
        logger.info("生成长图成功：" + cmd);
    } catch (IOException e) {
        logger.error("生成长图失败：" + e.getMessage());
    }

    // 启用定时器，监视该图片，一旦生成了，则上传到七牛云
    UploadTask task = new UploadTask(fileName, suffix);
    Future future = taskScheduler.scheduleAtFixedRate(task, 500);
    task.setFuture(future);

}

class UploadTask implements Runnable {
    //文件名称
    private String fileName;

    //文件后缀
    private String suffix;

    //启动任务的返回值
    private Future future;

    //开始时间
    private long startTime;

    //上传次数
    private int uploadTimes;

    public UploadTask(String fileName, String suffix) {
        this.fileName = fileName;
        this.suffix = suffix;
        this.startTime = System.currentTimeMillis();
    }

    public void setFuture(Future future) {
        this.future = future;
    }

    @Override
    public void run() {
        // 生成图片失败
        if (System.currentTimeMillis() - startTime > 30000) {
            logger.error("执行时间过长，终止任务:" + fileName);
            future.cancel(true);
            return;
        }

        // 上传失败
        if (uploadTimes >= 3) {
            logger.error("上传次数过多，终止任务:" + fileName);
            future.cancel(true);
            return;
        }

        String path = wkImageStorage + "/" + fileName + suffix;
        File file = new File(path);
        if (file.exists()) {
            logger.info(String.format("开始第%d次上传[%s].", ++uploadTimes, file));

            //设置响应信息
            com.qiniu.util.StringMap policy = new StringMap();
            policy.put("returnBody", CommunityUtil.getJSONString(0));
            // 生成上传凭证
            Auth auth = Auth.create(accessKey, secretKey);
            String uploadToken = auth.uploadToken(shareBucketName, fileName, 3600, policy);
            // 指定上传机房
            UploadManager manager = new UploadManager(new Configuration(Zone.zone1()));
            try {
                // 开始上传图片
                suffix = suffix.substring(suffix.lastIndexOf(".") + 1);
                Response response = manager.put(path, fileName, uploadToken,
                        null, "image/" + suffix, false);
                // 处理响应结果
                JSONObject json = JSONObject.parseObject(response.bodyString());
                if (json == null || json.get("code") == null || !json.get("code").toString().equals("0")) {
                    logger.info(String.format("第%d次上传失败[%s].", uploadTimes, fileName));
                } else {
                    logger.info(String.format("第%d次上传成功[%s].", uploadTimes, fileName));
                    future.cancel(true);
                }
            } catch (Exception e) {
                logger.info(String.format("第%d次上传失败[%s].", uploadTimes, fileName));
            }
        } else {
            logger.info("等待图片生成[" + fileName + "]");
        }
    }
}
```

##### 2.3 运行结果

在浏览器中输入 http://localhost:8080/community/share?htmlUrl=https://www.baidu.com

![image-20220721160529302](http://qiniu.dyl.fit/Interview/image-20220721160529302.png)

![image-20220721160623745](http://qiniu.dyl.fit/Interview/image-20220721160623745.png)

### 7.10 优化网站的性能(缓存热帖排行)

* 本地缓存
  * 将数据缓存在应用服务器上，性能最好。
  * 常用缓存工具：Ehcache、Cuava、Caffeine等。
* 分布式缓存
  * 将数据缓存在 NoSQL 数据库上，跨服务器。
  * 常用缓存工具：MemCache、Redis等。
* 多级缓存
  * 一级缓存（本地缓存）->二级缓存（分布式缓存）-> DB
  * 避免缓存雪崩（缓存失效，大量请求直达DB），提高系统的可用性。

![image-20220721161242967](http://qiniu.dyl.fit/Interview/image-20220721161242967.png)

![image-20220721161448394](http://qiniu.dyl.fit/Interview/image-20220721161448394.png)

#### 1、实现缓存

##### 1.1 引入依赖

```xml
<dependency>
    <groupId>com.github.ben-manes.caffeine</groupId>
    <artifactId>caffeine</artifactId>
    <version>2.7.0</version>
</dependency>
```

##### 1.2 配置 application.yaml

自定义配置 caffeine

```yaml
# caffeine
caffeine:
  posts:
    max-size: 15
    expire-seconds: 180
```

##### 1.3 修改 service

修改 DiscussPostService

```java
private static final Logger logger = LoggerFactory.getLogger(DiscussPostService.class);

@Value("${caffeine.posts.max-size}")
private int maxSize;

@Value("${caffeine.posts.expire-seconds}")
private int expireSeconds;

// Caffeine核心接口: Cache, LoadingCache, AsyncLoadingCache

// 帖子列表缓存
private LoadingCache<String, List<DiscussPost>> postListCache;

// 帖子总数缓存
private LoadingCache<Integer, Integer> postRowsCache;

@Resource
private DiscussPostMapper discussPostMapper;

@Resource
private SensitiveFilter sensitiveFilter;

@PostConstruct
public void init() {
    // 初始化帖子列表缓存
    postListCache = Caffeine.newBuilder()
            .maximumSize(maxSize)
            .expireAfterWrite(expireSeconds, TimeUnit.SECONDS)
            .build(new CacheLoader<String, List<DiscussPost>>() {
                @Nullable
                @Override
                public List<DiscussPost> load(@NonNull String key) throws Exception {
                    if (key == null || key.length() == 0) {
                        throw new IllegalArgumentException("参数错误!");
                    }

                    String[] params = key.split(":");
                    if (params == null || params.length != 2) {
                        throw new IllegalArgumentException("参数错误!");
                    }

                    int offset = Integer.valueOf(params[0]);
                    int limit = Integer.valueOf(params[1]);

                    // 二级缓存: Redis -> mysql

                    logger.debug("load post list from DB.");
                    return discussPostMapper.selectDiscussPosts(0, offset, limit, 1);
                }
            });
    // 初始化帖子总数缓存
    postRowsCache = Caffeine.newBuilder()
            .maximumSize(maxSize)
            .expireAfterWrite(expireSeconds, TimeUnit.SECONDS)
            .build(new CacheLoader<Integer, Integer>() {
                @Nullable
                @Override
                public Integer load(@NonNull Integer key) throws Exception {
                    logger.debug("load post rows from DB.");
                    return discussPostMapper.selectDiscussPostRows(key);
                }
            });
}

public List<DiscussPost> findDiscussPosts(int userId, int offset, int limit, int orderMode) {
    if (userId == 0 && orderMode == 1) {
        return postListCache.get(offset + ":" + limit);
    }

    logger.debug("load post list from DB.");
    return discussPostMapper.selectDiscussPosts(userId, offset, limit, orderMode);
}

public int findDiscussPostRows(int userId) {
    if (userId == 0) {
        return postRowsCache.get(userId);
    }

    logger.debug("load post rows from DB.");
    return discussPostMapper.selectDiscussPostRows(userId);
}
```

##### 1.4 创建测试类 CaffeineTest

```java
@SpringBootTest
class CaffeineTest {

    @Resource
    private DiscussPostService discussPostService;

    @Test
    void initDataForTest() {
        for (int i = 0; i < 300000; i++) {
            DiscussPost post = new DiscussPost();
            post.setUserId(111);
            post.setTitle("互联网求职暖春计划");
            post.setContent("今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！");
            post.setCreateTime(new Date());
            post.setScore(Math.random() * 2000);
            discussPostService.addDiscussPost(post);
        }
    }

    @Test
    void testCache() {
        System.out.println(discussPostService.findDiscussPosts(0, 0, 10, 1));
        System.out.println(discussPostService.findDiscussPosts(0, 0, 10, 1));
        System.out.println(discussPostService.findDiscussPosts(0, 0, 10, 1));
        System.out.println(discussPostService.findDiscussPosts(0, 0, 10, 0));
    }
}
```

##### 1.5 运行结果

初始化30万条数据后再运行第二个测试方法

![image-20220721164015101](http://qiniu.dyl.fit/Interview/image-20220721164015101.png)

#### 2、压力测试

##### 2.1 jmeter 安装配置（头都）

资源链接：https://pan.baidu.com/s/1yYykjAxpPvYPxH6iPrc3FA 提取码：fl6t 

##### 2.2 使用 jmeter

双击 jmeter.bat

更改语言：在option中选择language，再选择中文简体

添加线程组

![image-20220721165121531](http://qiniu.dyl.fit/Interview/image-20220721165121531.png)

添加HTTP请求

![image-20220721165254844](http://qiniu.dyl.fit/Interview/image-20220721165254844.png)

添加定时器

![image-20220721165324705](http://qiniu.dyl.fit/Interview/image-20220721165324705.png)

添加聚合报告（在线程组里添加监听器里）

![image-20220721165457507](http://qiniu.dyl.fit/Interview/image-20220721165457507.png)

##### 2.3 运行结果

![image-20220721165637746](http://qiniu.dyl.fit/Interview/image-20220721165637746.png)

点击扫帚按钮清理数据后开启项目里的缓存再跑一遍

![image-20220721165856487](http://qiniu.dyl.fit/Interview/image-20220721165856487.png)

### 7.11 我的帖子和评论

#### 1、查看我的帖子

##### 1.1 修改 controller

在 UserController 中添加方法

```java
//跳转到我的帖子页面
@GetMapping("/mypost/{userId}")
public String toMyPost(@PathVariable("userId") int userId, Model model, Page page,
                       @RequestParam(name = "infoMode", defaultValue = "1") int infoMode) {
    User user = userService.findUserById(userId);
    if (user == null) {
        throw new RuntimeException("该用户不存在!");
    }
    model.addAttribute("user", user);

    // 设置分页信息
    page.setLimit(5);
    page.setRows(discussPostService.findDiscussPostRows(user.getId()));
    page.setPath("/user/mypost/" + userId);


    // 查询某用户发布的帖子
    List<DiscussPost> discussPosts = discussPostService.findDiscussPosts(user.getId(), page.getOffset(), page.getLimit(), 0);
    List<Map<String, Object>> list = new ArrayList<>();
    if (discussPosts != null) {
        for (DiscussPost post : discussPosts) {
            Map<String, Object> map = new HashMap<>();
            map.put("post", post);
            // 点赞数量
            long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId());
            map.put("likeCount", likeCount);

            list.add(map);
        }
        model.addAttribute("discussPosts", list);
    }
    // 帖子数量
    int postCount = discussPostService.findDiscussPostRows(user.getId());
    model.addAttribute("postCount", postCount);
    model.addAttribute("infoMode", infoMode);

    return "site/my-post";
}
```

##### 1.2 修改前端界面

修改 my-post.html

```html
<!-- 内容 -->
<div class="main">
    <div class="container">
        <!-- 选项 -->
        <div class="position-relative">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a th:class="|nav-link ${infoMode==0?'active':''}|"
                       th:href="@{|/user/profile/${user.id}|}">个人信息</a>
                </li>
                <li class="nav-item">
                    <a th:class="|nav-link ${infoMode==1?'active':''}|" th:href="@{|/user/mypost/${user.id}|}"
                       th:text="${loginUser.id!=user.id?'它的帖子':'我的帖子'}">我的帖子</a>
                </li>
                <li class="nav-item">
                    <a th:class="|nav-link ${infoMode==2?'active':''}|" th:href="@{|/user/mycomment/${user.id}|}"
                       th:text="${loginUser.id!=user.id?'它的评论':'我的评论'}">我的评论</a>
                </li>
            </ul>
            <a th:href="@{|/user/profile/${user.id}|}" class="text-muted position-absolute rt-0"
               th:if="${loginUser.id==user.id}">返回个人主页&gt;</a>
        </div>
        <!-- 我的帖子 -->
        <div class="mt-4">
            <h6><b class="square"></b> 发布的帖子(<i th:text="${postCount}"></i>)</h6>
            <ul class="list-unstyled mt-4 pl-3 pr-3">
                <li class="border-bottom pb-3 mt-4" th:each="map:${discussPosts}">
                    <div class="font-size-16 text-info">
                        <a th:href="@{|/discuss/detail/${map.post.id}|}" class="text-info"
                           th:utext="${map.post.title}">备战春招，面试刷题跟他复习，一个月全搞定！</a>
                        <span class="float-right font-size-12 text-muted">
                            赞 <i class="mr-2" th:utext="${map.likeCount}"></i>|&nbsp;&nbsp;回帖 <i class="mr-2"
                                                                                                 th:utext="${map.post.commentCount}"></i>
                            &nbsp;发布于 <b th:text="${#dates.format(map.post.createTime, 'yyyy-MM-dd HH:mm:ss')}"></b>
                        </span>
                    </div>

                </li>
            </ul>
            <!-- 分页 -->
            <nav class="mt-5" th:replace="index::pagination"></nav>
        </div>
    </div>
</div>
```

修改 profile.html

```html
<!-- 选项 -->
<div class="position-relative">
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a th:class="|nav-link ${infoMode==0?'active':''}|" th:href="@{|/user/profile/${user.id}|}">个人信息</a>
        </li>
        <li class="nav-item">
            <a th:class="|nav-link ${infoMode==1?'active':''}|" th:href="@{|/user/mypost/${user.id}|}" th:text="${loginUser.id!=user.id?'它的帖子':'我的帖子'}">我的帖子</a>
        </li>
		<li class="nav-item">
    		<a class="nav-link" href="my-reply.html">我的回复</a>
		</li>
    </ul>
</div>
```

#### 2、查看我的评论

##### 2.1 修改 mapper

在 CommentMapper 中添加方法

```java
int selectCommentCountById(int id);

List<Comment> selectCommentsByUserId(int id, int offset, int limit);

int updateStatus(int entityId, int status);
```

配置相应的 sql 语句

```xml
<select id="selectCommentCountById" resultType="int">
    select count(id)
    from comment
    where status = 0
      and user_id = #{id}
      and entity_type=1
</select>
<select id="selectCommentsByUserId" resultType="Comment">
    select <include refid="selectFields"/>
    from comment
    where status = 0
    and user_id=#{id}
    and entity_type=1
    order by create_time desc
    limit #{offset}, #{limit}
</select>

<update id="updateStatus">
    update comment set status = #{status} where entity_id = #{entityId} and entity_type=1
</update>
```

##### 2.2 修改 service

修改 CommentService

```java
public int findCommentCountById(int id) {
    return commentMapper.selectCommentCountById(id);
}

public List<Comment> findCommentsByUserId(int id,int offset,int limit) {
    return commentMapper.selectCommentsByUserId(id,offset,limit);
}

public int updateStatus(int entityId, int status) {
    return commentMapper.updateStatus(entityId,status);
}
```

##### 2.3 修改 controller

在 UserController 中添加方法

```java
//跳转到我的评论页面
@GetMapping("/mycomment/{userId}")
public String toMyReply(@PathVariable("userId") int userId, Model model, Page page,
                        @RequestParam(name = "infoMode", defaultValue = "2") int infoMode) {
    User user = userService.findUserById(userId);
    if (user == null) {
        throw new RuntimeException("该用户不存在!");
    }
    model.addAttribute("user", user);

    // 设置分页信息
    page.setLimit(5);
    page.setRows(commentService.findCommentCountById(user.getId()));
    page.setPath("/user/mycomment/" + userId);

    // 获取用户所有评论 (而不是回复,所以在 sql 里加一个条件 entity_type = 1)
    List<Comment> comments = commentService.findCommentsByUserId(user.getId(), page.getOffset(), page.getLimit());
    List<Map<String, Object>> list = new ArrayList<>();
    if (comments != null) {
        for (Comment comment : comments) {
            Map<String, Object> map = new HashMap<>();
            map.put("comment", comment);

            // 根据实体 id 查询对应的帖子标题
            String discussPostTitle = discussPostService.findDiscussPostById(comment.getEntityId()).getTitle();
            map.put("discussPostTitle", discussPostTitle);

            list.add(map);
        }
        model.addAttribute("comments", list);
    }

    // 回复的数量
    int commentCount = commentService.findCommentCountById(user.getId());
    model.addAttribute("commentCount", commentCount);
    model.addAttribute("infoMode", infoMode);

    return "site/my-comment";
}
```

##### 2.4 修改前端界面

修改 my-comment.html

```html
<div class="main">
    <div class="container">
        <!-- 选项 -->
        <div class="position-relative">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a th:class="|nav-link ${infoMode==0?'active':''}|"
                       th:href="@{|/user/profile/${user.id}|}">个人信息</a>
                </li>
                <li class="nav-item">
                    <a th:class="|nav-link ${infoMode==1?'active':''}|" th:href="@{|/user/mypost/${user.id}|}"
                       th:text="${loginUser.id!=user.id?'它的帖子':'我的帖子'}">我的帖子</a>
                </li>
                <li class="nav-item">
                    <a th:class="|nav-link ${infoMode==2?'active':''}|" th:href="@{|/user/mycomment/${user.id}|}"
                       th:text="${loginUser.id!=user.id?'它的评论':'我的评论'}">我的评论</a>
                </li>
            </ul>
            <a th:href="@{|/user/profile/${user.id}|}" class="text-muted position-absolute rt-0"
               th:if="${loginUser.id==user.id}">返回个人主页&gt;</a>
        </div>
        <!-- 我的回复 -->
        <div class="mt-4">
            <h6><b class="square"></b> 评论的帖子(<i th:text="${commentCount}"></i>)</h6>
            <ul class="list-unstyled mt-4 pl-3 pr-3">
                <li class="border-bottom pb-3 mt-4" th:each="map:${comments}">
                    <div class="font-size-16 text-info">
                        <a th:href="@{|/discuss/detail/${map.comment.entityId}|}" class="text-info"
                           th:utext="${map.discussPostTitle}"></a>
                    </div>
                    <div class="mt-1 font-size-14" th:utext="${map.comment.content}"></div>
                    <div class="text-right font-size-12 text-muted">
                        评论于 <b th:text="${#dates.format(map.comment.createTime, 'yyyy-MM-dd HH:mm:ss')}"></b>
                    </div>
                </li>
            </ul>
            <!-- 分页 -->
            <nav class="mt-5" th:replace="index::pagination"></nav>
        </div>
    </div>
</div>
```

修改 profile.html

```html
<!-- 选项 -->
<div class="position-relative">
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a th:class="|nav-link ${infoMode==0?'active':''}|" th:href="@{|/user/profile/${user.id}|}">个人信息</a>
        </li>
        <li class="nav-item">
            <a th:class="|nav-link ${infoMode==1?'active':''}|" th:href="@{|/user/mypost/${user.id}|}" th:text="${loginUser.id!=user.id?'它的帖子':'我的帖子'}">我的帖子</a>
        </li>
        <li class="nav-item">
            <a th:class="|nav-link ${infoMode==2?'active':''}|" th:href="@{|/user/mycomment/${user.id}|}" th:text="${loginUser.id!=user.id?'它的评论':'我的评论'}">我的评论</a>
        </li>
    </ul>
</div>
```

### 7.12 忘记密码

#### 1、实现忘记密码

##### 1.1 修改 RedisKeyUtil

```java
private static final String PREFIX_CODE = "code";

// 忘记密码
public static String getCodeKey(String owner) {
    return PREFIX_CODE + SPLIT + owner;
}
```

##### 1.2 修改 service

```java
// 忘记密码功能
public User findUserByEmail(String email) {
    return userMapper.selectByEmail(email);
}

public void sendCode(String email, HttpServletResponse response) {
    String text = CommunityUtil.generateUUID().substring(0, 6);
    // 验证码的归属
    String codeOwner = CommunityUtil.generateUUID();
    Cookie cookie = new Cookie("codeOwner", codeOwner);
    //失效的时间是10min
    cookie.setMaxAge(60 * 10);
    cookie.setPath(contextPath);
    response.addCookie(cookie);
    // 将验证码存入Redis,失效的时间是10min
    String redisKey = RedisKeyUtil.getCodeKey(codeOwner);
    redisTemplate.opsForValue().set(redisKey, text, 60 * 10, TimeUnit.SECONDS);

    // 激活邮件,使用thymeleaf创建的对象携带变量
    Context context = new Context();
    context.setVariable("email", email);
    context.setVariable("text", text);
    //使用模板引擎，利用thymeleaf，将context放到/mail/activation.html文件中，然后再利用mail包发送给邮箱
    String content = templateEngine.process("/mail/forget", context);
    mailClient.sendMail(email, "忘记密码", content);

}

public Map<String, Object> changePasswordByCode(String email, String password) {
    Map<String, Object> map = new HashMap<>();
    // 验证密码
    if (StringUtils.isBlank(password)) {
        map.put("passwordMsg", "密码不能为空!");
        return map;
    }
    User user = userMapper.selectByEmail(email);
    password = CommunityUtil.md5(password + user.getSalt());
    userMapper.updatePassword(user.getId(), password);
    map.put("success", "success");
    clearCache(user.getId());
    return map;
}
```

##### 1.3 修改 controller

在 UserController 中添加方法

```java
@RequestMapping(path = "/changePasswordByCode", method = {RequestMethod.GET, RequestMethod.POST})
//修改密码，model变量用来向页面返回数据
public String changePasswordByCode(String email, String code, String password, Model model,
                                   @CookieValue("codeOwner") String codeOwner) {
    String kaptcha = null;
    try {
        if (StringUtils.isNotBlank(codeOwner)) {
            String redisKey = RedisKeyUtil.getCodeKey(codeOwner);
            kaptcha = (String) redisTemplate.opsForValue().get(redisKey);
        }
    } catch (Exception e) {
        model.addAttribute("codeMsg", "验证码失效!");
        return "/site/forget";
    }


    if (StringUtils.isBlank(kaptcha) || StringUtils.isBlank(code) || !kaptcha.equals(code)) {
        model.addAttribute("codeMsg", "验证码不正确!");
        return "/site/forget";
    }
    Map<String, Object> map = userService.changePasswordByCode(email, password);
    if (map.containsKey("success")) {
        return "redirect:/login";
    } else {
        model.addAttribute("passwordMsg", map.get("passwordMsg"));
        return "/site/forget";
    }
}

@RequestMapping(path = "/forgetPassword", method = RequestMethod.GET)
//忘记密码
public String forgetPassword() {
    return "/site/forget";
}

@RequestMapping(path = "/sendCode", method = RequestMethod.POST)
//向邮箱发送验证码
@ResponseBody
public String sendCode(String email, HttpServletResponse response) {
    User user = userService.findUserByEmail(email);
    if (user == null) {
        return CommunityUtil.getJSONString(1, "您输入的邮箱格式有误或未注册");
    }
    userService.sendCode(email, response);
    return CommunityUtil.getJSONString(0);
}
```

##### 1.4 修改前端界面

修改 site 包下的 forget.html

```html
<!-- 内容 -->
<div class="main">
    <div class="container pl-5 pr-5 pt-3 pb-3 mt-3 mb-3">
        <form class="mt-5" method="post" enctype="multipart/form-data" th:action="@{/user/changePasswordByCode}">
            <div class="form-group row">
                <label for="email" class="col-sm-2 col-form-label text-right">邮箱:</label>
                <div class="col-sm-10">
                    <input type="email"
                           th:class="|form-control ${emailMsg!=null?'is-invalid':''}|"
                           th:value="${user!=null?user.email:''}"
                           id="email" name="email" placeholder="请输入您的邮箱!" required>
                    <div class="invalid-feedback" th:text="${emailMsg}">
                        该邮箱已注册!
                    </div>
                </div>
            </div>
            <div class="form-group row mt-4">
                <label for="code" class="col-sm-2 col-form-label text-right">验证码:</label>
                <div class="col-sm-6">
                    <input type="text" th:class="|form-control ${codeMsg!=null?'is-invalid':''}|"
                           id="code" name="code" placeholder="请输入验证码!">
                    <div class="invalid-feedback" th:text="${codeMsg}">
                        验证码不正确!
                    </div>
                </div>
                <div class="col-sm-4">
                    <button type="button" class="btn btn-info form-control feach-btn">获取验证码</button>
                </div>
            </div>
            <div class="form-group row mt-4">
                <label for="password" class="col-sm-2 col-form-label text-right">新密码:</label>
                <div class="col-sm-10">
                    <input type="password" class="form-control" id="password" name="password" placeholder="请输入新的密码!"
                           required>
                    <div class="invalid-feedback">
                        密码长度不能小于8位!
                    </div>
                </div>
            </div>
            <div class="form-group row mt-4">
                <div class="col-sm-2"></div>
                <div class="col-sm-10 text-center">
                    <button type="submit" class="btn btn-info text-white form-control">重置密码</button>
                </div>
            </div>
        </form>
    </div>
</div>
```

引入新建的 forget.js

```html
<script th:src="@{/js/forget.js}"></script>
```

```js
$(function () {
    $(".feach-btn").click(feach);
});

function feach() {
    var btn = this;
    var count = 60;
    const countDown = setInterval(() => {
        if (count === 60) {
            $.post(
                CONTEXT_PATH + "/user/sendCode?p=" + Math.random(),
                {"email": $("#email").val()},
                function (data) {
                    data = $.parseJSON(data);
                    if (data.code !== 0) {
                        alert(data.msg);
                    }
                }
            );
        }
        if (count === 0) {
            $(btn).text('重新发送').removeAttr('disabled');
            $(btn).css({
                background: '#ff9400',
                color: '#fff',
            });
            clearInterval(countDown);
        } else {
            $(btn).attr('disabled', true);
            $(btn).css({
                background: '#d8d8d8',
                color: '#707070',
            });
            $(btn).text(count + '秒后可重新获取');
        }
        count--;
    }, 1000);
}
```

修改 mail 包下的 forget.html

```html
<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
   <meta charset="utf-8">
   <link rel="icon" href="https://static.nowcoder.com/images/logo_87_87.png"/>
   <title>牛客网-忘记密码</title>
</head>
<body>
<div>
   <p>
      <b th:text="${email}">xxx@xxx.com</b>, 您好!
   </p>
   <p>
      您正在找回Community的密码, 本次操作的验证码为 <b th:text="${text}">u5s6dt</b> ,
      有效时间10分钟, 请您及时进行操作!
   </p>
</div>
</body>
</html>
```

修改 login.html

```html
<div class="col-sm-10">
    <input type="checkbox" id="remember-me" name="rememberme"
           th:checked="${param.rememberme}">
    <label class="form-check-label" for="remember-me">记住我</label>
    <a th:href="@{/user/forgetPassword}" class="text-danger float-right">忘记密码?</a>
</div>
```

##### 1.5 运行结果

![动画20](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB20.gif)

#### 2、重构修改密码（修复之前的显示 bug）

##### 2.1 修改 service

```java
//    public Map<String, Object> updatePassword(String password, String newPassword, int id) {
//        Map<String, Object> map = new HashMap<>();
//        User user = userMapper.selectById(id);
//        password = CommunityUtil.md5(password + user.getSalt());
//        if (!user.getPassword().equals(password)) {
//            map.put("passwordMsg", "输入密码错误！");
//            return map;
//        } else {
//            //注意：存入新密码要以加密后的形式存进去
//            newPassword = CommunityUtil.md5(newPassword + user.getSalt());
//            userMapper.updatePassword(id, newPassword);
//        }
//
//        clearCache(user.getId());
//        return map;
//    }

    public Map<String, Object> changePassword(User user, String oldPassword, String newPassword, String confirmPassword) {
        Map<String, Object> map = new HashMap<>();
        // 验证密码
        oldPassword = CommunityUtil.md5(oldPassword + user.getSalt());
        if (!user.getPassword().equals(oldPassword)) {
            map.put("oldPasswordMsg", "密码不正确!");
            return map;
        }
        if (StringUtils.isBlank(newPassword)) {
            map.put("newPasswordMsg", "密码不能为空!");
            return map;
        }
        if (!newPassword.equals(confirmPassword)) {
            map.put("confirmPasswordMsg", "两次输入的密码不一致!");
            return map;
        }
        int id = user.getId();
        newPassword = CommunityUtil.md5(newPassword + user.getSalt());
        if (oldPassword.equals(newPassword)) {
            map.put("newPasswordMsg", "旧密码与新密码一致!");
            return map;
        }
        userMapper.updatePassword(id, newPassword);
        clearCache(user.getId());
        return map;
    }
```

##### 2.2 修改controller

修改 UserController 原来的方法

```java
//    @PostMapping("/change")
//    public String updatePassword(Model model, String password, String newPassword, String confirmPassword) {
//        if (StringUtils.isBlank(password)) {
//            model.addAttribute("passwordMsg", "请输入原来密码！");
//            return "/site/setting";
//        }
//        if (StringUtils.isBlank(newPassword)) {
//            model.addAttribute("newPasswordMsg", "请输入新密码！");
//            return "/site/setting";
//        }
//        if (StringUtils.isBlank(confirmPassword)) {
//            model.addAttribute("confirmPasswordMsg", "请再次输入新密码！");
//            return "/site/setting";
//        }
//        if (!confirmPassword.equals(newPassword)) {
//            model.addAttribute("newPasswordMsg", "两次输入的新密码不相同！");
//            return "/site/setting";
//        }
//        User user = hostHolder.getUser();
//        Map<String, Object> map = userService.updatePassword(password, newPassword, user.getId());
//        if (map == null || map.isEmpty()) {
//            //传给templates注册成功信息
//            model.addAttribute("msg", "密码修改成功");
//            //跳到回个人设置页面
//            model.addAttribute("target", "/logout");
//            return "/site/operate-result";
//        } else {
//            //失败了传失败信息，跳到到原来的页面
//            model.addAttribute("passwordMsg", "输入的原始密码错误！");
//            return "/site/setting";
//        }
//    }


    //    @LoginRequired
    @RequestMapping(path = "/changePassword", method = {RequestMethod.GET, RequestMethod.POST})
    //修改密码，model变量用来向页面返回数据
    public String changePassword(String oldPassword, String newPassword, String confirmPassword, Model model) {
        User user = hostHolder.getUser();
        Map<String, Object> map = userService.changePassword(user, oldPassword, newPassword, confirmPassword);
        if (map == null || map.isEmpty()) {
            model.addAttribute("msg", "密码修改成功");
            model.addAttribute("target", "/logout");
            return "/site/operate-result";
//            return "redirect:/index";
        } else {
            model.addAttribute("oldPasswordMsg", map.get("oldPasswordMsg"));
            model.addAttribute("newPasswordMsg", map.get("newPasswordMsg"));
            model.addAttribute("confirmPasswordMsg", map.get("confirmPasswordMsg"));
            return "/site/setting";
        }
    }
```

##### 2.3 修改前端界面

修改 setting.html

```html
<!-- 修改密码 -->
<!--            <h6 class="text-left text-info border-bottom pb-2 mt-5">修改密码</h6>-->
<!--            <form class="mt-5" method="post" th:action="@{/user/change}">-->
<!--                <div class="form-group row mt-4">-->
<!--                    <label for="old-password" class="col-sm-2 col-form-label text-right">原密码:</label>-->
<!--                    <div class="col-sm-10">-->
<!--                        <input type="password"-->
<!--                               th:class="|form-control ${passwordMsg != null ?'is-invalid':'' }|"-->
<!--                               id="old-password"-->
<!--                               th:value="${param.password}"-->
<!--                               name="password" placeholder="请输入原始密码!" required>-->
<!--                        <div class="invalid-feedback" th:text="${passwordMsg}">-->
<!--                            密码长度不能小于8位!-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--                <div class="form-group row mt-4">-->
<!--                    <label for="new-password" class="col-sm-2 col-form-label text-right">新密码:</label>-->
<!--                    <div class="col-sm-10">-->
<!--                        <input type="password"-->
<!--                               class="form-control"-->
<!--                               id="new-password"-->
<!--                               th:value="${param.newPassword}"-->
<!--                               name="newPassword" placeholder="请输入新的密码!" required>-->
<!--                        <div class="invalid-feedback" th:text="${newPasswordMsg}">-->
<!--                            密码长度不能小于8位!-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--                <div class="form-group row mt-4">-->
<!--                    <label for="confirm-password" class="col-sm-2 col-form-label text-right">确认密码:</label>-->
<!--                    <div class="col-sm-10">-->
<!--                        <input type="password"-->
<!--                               th:class="|form-control ${newPasswordMsg != null?'is-invalid':'' }|"-->
<!--                               id="confirm-password"-->
<!--                               th:value="${param.confirmPassword}"-->
<!--                               name=confirmPassword placeholder="请再次输入新密码!" required>-->
<!--                        <div class="invalid-feedback">-->
<!--                            两次输入的密码不一致!-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--                <div class="form-group row mt-4">-->
<!--                    <div class="col-sm-2"></div>-->
<!--                    <div class="col-sm-10 text-center">-->
<!--                        <button type="submit" class="btn btn-info text-white form-control">立即保存</button>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </form>-->

            <h6 class="text-left text-info border-bottom pb-2 mt-5">修改密码</h6>
            <form class="mt-5" method="post" enctype="multipart/form-data" th:action="@{/user/changePassword}">
                <div class="form-group row mt-4">
                    <label for="old-password" class="col-sm-2 col-form-label text-right">原密码:</label>
                    <div class="col-sm-10">
                        <input type="password" th:class="|form-control ${oldPasswordMsg!=null?'is-invalid':''}|"
                               id="old-password"
                               name="oldPassword" placeholder="请输入原始密码!" required>
                        <div class="invalid-feedback" th:text="${oldPasswordMsg}">
                            密码长度不能小于8位!
                        </div>
                    </div>
                </div>
                <div class="form-group row mt-4">
                    <label for="new-password" class="col-sm-2 col-form-label text-right">新密码:</label>
                    <div class="col-sm-10">
                        <input type="password" th:class="|form-control ${newPasswordMsg!=null?'is-invalid':''}|"
                               id="new-password"
                               name="newPassword" placeholder="请输入新的密码!" required>
                        <div class="invalid-feedback" th:text="${newPasswordMsg}">
                            密码长度不能小于8位!
                        </div>
                    </div>
                </div>
                <div class="form-group row mt-4">
                    <label for="confirm-password" class="col-sm-2 col-form-label text-right">确认密码:</label>
                    <div class="col-sm-10">
                        <input type="password" th:class="|form-control ${confirmPasswordMsg!=null?'is-invalid':''}|"
                               id="confirm-password"
                               name="confirmPassword" placeholder="再次输入新密码!" required>
                        <div class="invalid-feedback" th:text="${confirmPasswordMsg}">
                            两次输入的密码不一致!
                        </div>
                    </div>
                </div>
                <div class="form-group row mt-4">
                    <div class="col-sm-2"></div>
                    <div class="col-sm-10 text-center">
                        <button type="submit" class="btn btn-info text-white form-control">立即保存</button>
                    </div>
                </div>
            </form>
```

##### 2.4 运行结果

![动画21](http://qiniu.dyl.fit/Interview/%E5%8A%A8%E7%94%BB21.gif)

## 第8章 项目发布与总结

### 8.1 单元测试

* Spring Boot Testing
  * 依赖：spring-boot-starter-test
  * 包括：Junit、Spring Test 、AssertJ、...

* Test Case
  * 要求：保证测试方法的独立性。
  * 步骤：初始化数据、执行测试代码、验证测试结果、清理测试数据。
  * Junit 4 常用注解：@BeforeClass、@AfterClass、@Before、@After。
  * Junit 5 常用注解：@BeforeAll、@AfterAll、@BeforeEach、@AfterEach

Junit 4 版本

```java
@RunWith(SpringRunner.class)
@SpringBootTest
@ContextConfiguration(classes = CommunityApplication.class)
public class SpringBootTests {

    @Autowired
    private DiscussPostService discussPostService;

    private DiscussPost data;

    @BeforeClass
    public static void beforeClass() {
        System.out.println("beforeClass");
    }

    @AfterClass
    public static void afterClass() {
        System.out.println("afterClass");
    }

    @Before
    public void before() {
        System.out.println("before");

        // 初始化测试数据
        data = new DiscussPost();
        data.setUserId(111);
        data.setTitle("Test Title");
        data.setContent("Test Content");
        data.setCreateTime(new Date());
        discussPostService.addDiscussPost(data);
    }

    @After
    public void after() {
        System.out.println("after");

        // 删除测试数据
        discussPostService.updateStatus(data.getId(), 2);
    }

    @Test
    public void test1() {
        System.out.println("test1");
    }

    @Test
    public void test2() {
        System.out.println("test1");
    }

    @Test
    public void testFindById() {
        DiscussPost post = discussPostService.findDiscussPostById(data.getId());
        Assert.assertNotNull(post);
        Assert.assertEquals(data.getTitle(), post.getTitle());
        Assert.assertEquals(data.getContent(), post.getContent());
    }

    @Test
    public void testUpdateScore() {
        int rows = discussPostService.updateScore(data.getId(), 2000.00);
        Assert.assertEquals(1, rows);

        DiscussPost post = discussPostService.findDiscussPostById(data.getId());
        Assert.assertEquals(2000.00, post.getScore(), 2);
    }
}
```

Junit 5 版本

```java
@SpringBootTest
class SpringBootTests {

    @Resource
    private DiscussPostService discussPostService;

    private DiscussPost discussPost;

    @BeforeAll
    public static void beforeClass() {
        System.out.println("beforeClass");
    }

    @AfterAll
    public static void afterClass() {
        System.out.println("afterClass");
    }

    @BeforeEach
    public void before() {
        System.out.println("before");

        // 初始化测试数据
        discussPost = new DiscussPost();
        discussPost.setUserId(111);
        discussPost.setTitle("Test Title");
        discussPost.setContent("Test Content");
        discussPost.setCreateTime(new Date());
        discussPostService.addDiscussPost(discussPost);
    }

    @AfterEach
    public void after() {
        System.out.println("after");

        // 删除测试数据
        discussPostService.updateStatus(discussPost.getId(), 2);
    }

    @Test
    void test1() {
        System.out.println("test1");
    }

    @Test
    void test2() {
        System.out.println("test1");
    }

    @Test
    void testFindById() {
        DiscussPost post = discussPostService.findDiscussPostById(discussPost.getId());
        Assert.assertNotNull(post);
        Assert.assertEquals(discussPost.getTitle(), post.getTitle());
        Assert.assertEquals(discussPost.getContent(), post.getContent());
    }

    @Test
    void testUpdateScore() {
        int rows = discussPostService.updateScore(discussPost.getId(), 2000.00);
        Assert.assertEquals(1, rows);

        DiscussPost post = discussPostService.findDiscussPostById(discussPost.getId());
        Assert.assertEquals(2000.00, post.getScore(), 2);
    }
}
```

### 8.2 项目监控

Spring Boot Actuator

* Endpoints: 监控应用的入口，Spring Boot内置了很多端点，也支持自定义端点。
* 监控方式：HTTP或JMX。
* 访问路径：例如“/actuator/health”。
* 注意事项：按需配置暴露的端点，并对所有端点进行权限控制。

#### 1、实现

##### 1.1 引入依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

##### 1.2 配置 application.yaml

```yaml
# actuator
management:
  endpoints:
    web:
      exposure:
        # 暴露所有端点，排除某些端点
        include: "*"
        exclude: info,caches
```

##### 1.3 配置自定义端点

```java
@Component
@Endpoint(id = "database")
public class DatabaseEndpoint {

    private static final Logger logger = LoggerFactory.getLogger(DatabaseEndpoint.class);

    @Resource
    private DataSource dataSource;

    @ReadOperation
    public String checkConnection() {
        try (
                Connection conn = dataSource.getConnection();
        ) {
            return CommunityUtil.getJSONString(0, "获取连接成功!");
        } catch (SQLException e) {
            logger.error("获取连接失败:" + e.getMessage());
            return CommunityUtil.getJSONString(1, "获取连接失败!");
        }
    }

}
```

##### 1.4 运行结果

输入 http://localhost:8080/community/actuator/database

![image-20220722091855987](http://qiniu.dyl.fit/Interview/image-20220722091855987.png)

##### 1.5 权限配置

将 "/actuator/**" 路径只赋予管理员权限

```java
.antMatchers(
        "/discuss/delete",
        "/data/**",
        "/actuator/**"
)
.hasAnyAuthority(
        AUTHORITY_ADMIN
)
```

### 8.3 项目部署

* 浏览器访问 Nginx（负责分发请求，反向代理）
* Tomcat服务器（装JRE和Maven）
* MySQL、Redis、Kafka、Elasticsearch、Wkhtmltopdf
* Putty(访问服务器的客户端)

su root命令是授予管理员权限

后台方式启动

bin/zookeeper-server-start.sh -daemon config/zookeeper.properties 

nohup bin/kafka-server-start.sh config/server.properties 1>/dev/null 2>&1 &

查询一下 bin/kafka-topics.sh --list --bootstrap-server localhost:9092

![image-20220722153518178](http://qiniu.dyl.fit/Interview/image-20220722153518178.png)

更改 es 占用内存 jvm.options

256M-512M

![image-20220722153814737](http://qiniu.dyl.fit/Interview/image-20220722153814737.png)

添加普通用户

![image-20220722154107004](http://qiniu.dyl.fit/Interview/image-20220722154107004.png)

设置用户权限

![image-20220722154327061](http://qiniu.dyl.fit/Interview/image-20220722154327061.png)

后台启动

```sh
bin/elastic
```



![image-20220722154507199](http://qiniu.dyl.fit/Interview/image-20220722154507199.png)

测试是否启动

```she
curl -X GET "localhost:9200/_cat/health?v"
```

![image-20220722154635057](http://qiniu.dyl.fit/Interview/image-20220722154635057.png)

安装 wkhtmltopdf

查询库中是否存在该软件

yum list wkhtmltopdf*

安装 

-y 代表如果存在安装时候提示是否继续安装的时候默认选是

yum install -y wkhtmltopdf.x86_64

![image-20220722155216248](http://qiniu.dyl.fit/Interview/image-20220722155216248.png)

由于转换成PDF需要GUI工具

因此安装该工具

```shell
yum list *xvfb*
```

xorg-x11-server-Xvfb.x86_64 

![image-20220722155623618](http://qiniu.dyl.fit/Interview/image-20220722155623618.png)

测试

xvfb-run --server-args="-screen 0, 1024x768x24" wkhtmltoimage https://www.baidu.com 1.png



新建脚本文件

```she
cd /opt
vim wkhtmltoimage.sh
然后输入
xvfb-run --server-args="-screen 0, 1024x768x24" wkhtmltoimage "$@"
```

给这个文件增加执行权限

chmod +x wkhtmltoimage.sh

![image-20220722161353534](http://qiniu.dyl.fit/Interview/image-20220722161353534.png)

测试

cd /root/test

/opt/wkhtmltoimage.sh https:baidu.com 2.png

配置 tomcat



配置环境变量

修改 etc目录下的profile文件，在最后填上一句

export PATH=$PATH:/www/server/tomcat/bin

刷新一下环境变量

source /etc/profile

查看环境变量

echo $PATH

安装 Nginx

配置Nginx

```properties
upstream myserver{
  server 127.0.0.1:8080 max_fails=3;
}

server{
  listen 80;
  server_name 192.168.80.128;
  location / {
    proxy_pass http://myserver;
  }
}
```

创建生产环境

![image-20220725085239309](http://qiniu.dyl.fit/Interview/image-20220725085239309.png)

修改配置文件

修改 pom.xml，打包为 war 包,增加名字

```xml
<packaging>war</packaging>

<build>
    <finalName>ROOT</finalName>
</build>
```

修改 application.yaml

```yaml
# profile
spring:
  profiles:
    active: produce
# logback
logging:
  config: logback-spring-${spring.profiles.active}.xml
```

修改 application-produce.yaml

```yaml
# ServerProperties
server:
  port: 8080
  servlet:
    context-path: 
```

修改前端界面

修改 global.js

```js
var CONTEXT_PATH = "";
```

修改 controller

修改 HomeController

```java
@GetMapping("/")
public String root() {
    return "forward:/index";
}
```

创建 CommunityServletInitializer类

```java
public class CommunityServletInitializer extends SpringBootServletInitializer {

    @Override
    protected SpringApplicationBuilder configure(SpringApplicationBuilder builder) {
        return builder.sources(CommunityApplication.class);
    }
}
```

上传到根目录

执行跳过测试打包的命令

```shell
mvn clean package -Dmaven.test.skip=true
```



### 8.4 项目总结

* Spring Boot
* **Spring**
* Spring MVC、Spring Mybatis、**Spring Security**
* 权限@会话管理
  * 注册、登录、退出、状态、设置、授权
  * Spring Email、**Interceptor**
* 核心@敏感词、@事务
  * 首页、帖子、评论、私信、异常、日志
  * Advice、**AOP**、**Transaction**
* 性能@数据结构
  * 点赞、关注、统计、缓存
  * **Redis**
* 通知@模式
  * 系统通知
  * Kafka
* 搜索@索引
  * 全文搜索
  * Elasticsearch
* 其他@线程池、@缓存
  * 排行、上传、服务器缓存
  * Quartz、**Caffeine**

动态请求：客户端-->Nginx主(从)-->Sever(community->本地缓存)-->Redis、DB、Kafka、Elasticsearch、文件服务器（七牛云）

静态资源：客户端--> 部署到CDN缓存服务（全国都有服务器，就近加载）

### 8.5 常见面试题

#### MySQL

* 存储引擎
  * InnoDB支持事务（Transations）
* 事务
  * 事务的特性：原子性、一致性、隔离性、持久性
  * 事务的隔离
    * 并发异常：第一类丢失更新、第二类丢失更新、脏读、不可重复读、幻读
    * 隔离级别：Read Uncommited、Read Committed、Repeatable Read、Serializable
    * Spring事务管理：声明式事务、编程式事务
* 锁
  * 范围
    * 表级锁：开销小、加锁快，发生锁冲突的概率高、并发度低，不会出现死锁。
    * 行级锁：开销大、加锁慢，发生锁冲突的概率低、并发度高，会出现死锁。
* 索引（InnoDB）
  * 共享锁（S）：行级，读取一行；
  * 排他锁（X）：表级，更新一行；
  * 意向共享锁（IS）：表级，准备加共享锁；
  * 意向排他锁（IX）：表级，准备加排他锁；
  * 间隙锁（NK）：行级，使用范围条件时，对范围内不存在的记录加锁。一是为了防止幻读，二是为了满足恢复和复制的需要。

|      |  IS  |  IX  |  S   |  X   |
| :--: | :--: | :--: | :--: | :--: |
|  IS  |      |      |      |  x   |
|  IX  |      |      |  x   |  x   |
|  S   |      |  x   |      |  x   |
|  X   |  x   |  x   |  x   |  x   |

* 加锁

  * 增加行级锁之前，InnoDB会自动给表加意向锁；
  * 执行DML语句时，InnoDB会自动给数据加排他锁；
  * 执行DQL语句时
    * 共享锁（S）：SELECT...FROM...WHERE...LOCK IN SHARE MODE;
    * 排他锁（X）：SELECT...FROM...WHERE...FOR UPDATE;
    * 间隙锁（NK）：上述SQL采用范围条件时，InnoDB对不存在的记录自动增加间隙锁。

* 死锁

  * 场景
    * 事务1：UPDATE T SET...WHERE ID=1;UPDATE T SET...WHERE ID=2;
    * 事务2：UPDATE T SET...WHERE ID=2;UPDATE T SET...WHERE ID=1;
  * 解决方案
    * 一般InnoDB会自动检测到，并使一个事务回滚，另一个事务继续；
    * 设置超时等参数 innodb_lock_wait_timeout；
  * 避免死锁
    * 不同的业务并发访问多个表时，应约定以相同的顺序来访问这些表；
    * 以批量的方式处理数据时，应事先对数据排序，保证线程按固定的顺序来处理数据；
    * 在事务中，如果要更新记录，应直接申请足够级别的锁，即排他锁；

* 悲观锁（数据库）

* 乐观锁（自定义）

  * 版本号机制

    * UPDATE..SET...,VERSION=#{version+1} WHERE ... AND ... VERSION=#{version}

  * CAS算法（Compare and swap）

    是一种无锁的算法，该算法涉及3个操作数（内存值V、旧值A、新值B），当V等于A时，采用原子方式用B的值更新V的值。该算法通常采用自旋操作，也叫自旋锁。它的缺点是：

    * ABA问题：某线程将A改为B，再改回A，则CAS会误认为A没被修改过。
    * 自旋操作采用循环的方式实现，若加锁时间长，则会给CPU带来巨大的开销。
    * CAS只能保证一个共享变量的原子操作。

* B+Tree(InnoDB)

  * 数据分块存储，每一块称为一页；
  * 所有值都是按顺序存储的，并且每一个叶子到根的距离相同；
  * 非叶子节点存储数据的边界，叶子节点存储指向数据行的指针；
  * 通过边界缩小数据的范围，从而避免全表扫描，加快了查找的速度。

#### Redis

* 数据类型

|  数据类型   | 最大存储数据量 |
| :---------: | :------------: |
|     key     |      512M      |
|   string    |      512M      |
|    hash     |     2^32-1     |
|    list     |     2^32-1     |
|     set     |     2^32-1     |
| sorted set  |    官方没给    |
|   bitmap    |      512M      |
| hyperloglog |      12K       |

* 过期策略

  Redis会把设置了过期时间的key放入一个独立的字典里，在key过期时并不会立刻删除它。

  Redis会通过如下两种策略，来删除过期的key：

  * 惰性删除

    客户端访问某个key时，Redis会检查该key是否过期，若过期则删除。

  * 定期扫描

    Redis默认每秒执行10次过期扫描（配置hz选项），扫描策略如下：

    1. 从过期字典中随机选择20个key；
    2. 删除这20个key中已过期的key；
    3. 如果过期的key的比例超过25%，则重复步骤1；

* 淘汰策略

  当Redis占用内存超出最大限制（maxmemory）时，可采用如下策略（maxmemory-policy），让Redis淘汰一些数据，以腾出空间继续提供读写服务：

  * noeviction：对可能导致增大内存的命令返回错误（大多数写命令，DEL除外）；
  * volatile-ttl：在设置了过期时间的key中，选择剩余寿命（TTL）最短的key，将其淘汰；
  * volatile-lru：在设置了过期时间的key中，选择最少使用的key（LRU），将其淘汰；
  * volatile-random：在设置了过期时间的key中，随机选择一些key，将其淘汰；
  * allkeys-lru：在所有的key中，选择最少使用的key（LRU），将其淘汰；
  * allkeys-random：在所有的key中，随机选择一些key，将其淘汰；

  LRU算法：

  * 维护一个链表，用于顺序存储被访问过的key。在访问数据时，最新访问过的key将被移动到表头，即最近访问的key在表头，最少访问的key在表尾。

  近似LRU算法（Redis）

  * 给每个key维护一个时间戳，淘汰时随机采样5个key，从中淘汰掉最旧的key。如果还是超出内存限制，则继续随机采样淘汰。
  * 优点：比LRU算法节约内存，却可以取得非常近似的效果。

* 缓存穿透

  * 场景

    查询根本不存在的数据，使得请求直达存储层，导致其负载过大，甚至宕机。

  * 解决方案：

    1. 缓存空对象：存储层未命中后，仍然将空值存入缓存层。再次访问该数据时，缓存层会直接返回空值。
    2. 布隆过滤器：将所有存在的key提前存入布隆过滤器，在访问缓存层之前，先通过过滤器拦截，若请求的是不存在的key，则直接返回空值。

* 缓存击穿

  * 场景

    一份热点数据，它的访问量非常大。在其缓存失效瞬间，大量请求直达存储层，导致服务崩溃。

  * 解决方案：

    1. 加互斥锁：对数据的访问加互斥锁，当一个线程访问该数据时，其他线程只能等待。这个线程访问过后，缓存中的数据将被 重建，届时其他线程就可以直接从缓存取值。
    2. 永不过期：不设置过期时间，所以不会出现上述问题，这是“物理“上的不过期。为每个value设置逻辑过期时间，当发现该值逻辑过期时，使用单独的线程重建缓存。

* 缓存雪崩

  * 场景

    由于某些原因，缓存层不能提供服务，导致所有请求直达存储层，造成存储层宕机。

  * 解决方案：

    1. 避免同时过期：设置过期时间时，附加一个随机数，避免大量的key同时过期。
    2. 构建高可用的Redis缓存：部署多个Redis实例，个别节点宕机，依然可以保持服务的整体可用。
    3. 构建多级缓存：增加本地缓存，在存储层前面多加一级屏障，降低请求直达存储层的几率。
    4. 启用限流和降级措施：对存储层增加限流措施，当请求超出限制时，对其提供降级服务。

* 分布式锁

  * 场景

    修改时，经常需要将数据读取到内存，在内存中修改后再存回去。在分布式应用中，可能多个进程同时执行上述操作，而读取和修改非原子操作，所以会产生冲突。增加分布式锁，可以解决此类问题。

  * 基本原理

    * 同步锁：在多个线程都能访问到的地方，做一个标记，标识该数据的访问权限。
    * 分布式锁：在多个进程都能访问到的地方，做一个标记，标识该数据的访问权限。

  * 实现方式

    1. 基于数据库实现分布式锁；
    2. 基于Redis实现分布式锁；
    3. 基于Zookeeper实现分布式锁；

  * Redis实现分布式锁的原则

    1. 安全属性：独享。在任一时刻，只有一个客户端持有锁。
    2. 活性A：无死锁。即便持有锁的客户端崩溃或者网络被分裂，锁仍然可以被获取。
    3. 活性B：容错。只要大部分Redis节点都活着，客户端就可以获取和释放锁。

  * 单Redis实例实现分布式锁

    1. 获取锁使用命令：

       ```
       SET resource_name my_random_value NX PX 30000
       ```

       NX：仅在key不存在时才执行成功。PX：设置锁的自动过期时间。

    2. 通过Lua脚本释放锁：

       ```
       if redis.call("get",KEYS[1]) == ARGV[1] then 
       	return redis.call("del",KEYS[1])
       else return 0 end
       ```

       可以避免删除别的客户端获取成功的锁：

       A加锁 --> A阻塞 --> 因超时释放锁 --> B加锁 --> A恢复 --> 释放锁

  * 多Redis实例实现分布式锁

    Redlock算法，该算法有现成的实现，其Java版本的库为Redisson。

    1. 获取当前Unix时间，以毫秒为单位。
    2. 依次尝试从N个实例，使用相同的key和随机值获取锁，并设置响应超时时间。如果服务器没有在规定时间内响应，客户端应该尽快尝试另外一个Redis实例。
    3. 客户端使用当前时间减去开始获取锁的时间，得到获取锁使用的时间。当且仅当大多数的Redis节点都取到锁，并且使用的时间小于锁失效的时间时，锁才算取得成功。
    4. 如果取到了锁，key的真正有效时间等于有效时间减去获取锁使用的时间。
    5. 如果获取锁失败，客户端应该在所有的Redis实例上进行解锁。

#### Spring 

* Spring IOC
  * Bean的作用域

|    作用域     |    使用范围    |                             描述                             |
| :-----------: | :------------: | :----------------------------------------------------------: |
|   singleton   | 所有Spring应用 |               在容器中只存在一个实例，默认值。               |
|   prototype   | 所有Spring应用 | 在容器中存在多个实例，即每次获取该Bean时，都会创建一个新实例。 |
|    request    | SpringWeb应用  |                 为每个请求创建一个新的实例。                 |
|    session    | SpringWeb应用  |                 为每个会话创建一个新的实例。                 |
| globalSession | SpringWeb应用  |    为全局的session创建一个实例，只在Portlet上下文中有效。    |
|  application  | SpringWeb应用  |               为整个Web应用创建一个新的实例。                |

* Spring AOP

  * AOP的术语

    Target（Joinpoint）<-- Weaving <-- Aspect(Pointcut(s.find*(..))、Advice(q前、后、返回、异常))

    1. 编译时织入，需使用特殊的编译器。
    2. 装载时织入，需使用特殊的类装载器。
    3. 运行时织入，需为目标生成代理对象。

* Spring MVC

  1. **客户端**发出请求访问服务器时，由**DispatcherServlet**处理。
  2. DispatcherServlet调用**HandlerMapping**(根据访问路径找到对应Controller)。
  3. HandlerMapping给DispatcherServlet返回**HandlerExecutionChain**对象（封装了Controller和拦截器）。
  4. DispatcherServlet调用拦截器的preHandle()方法，接着调用**HandlerAdapter**(内部调了Controller)。
  5. HandlerAdapter返回**ModelAndView**给DispatcherServlet，返回后调用postHandle()方法。
  6. DispatcherServlet调用**ViewResolver**(视图解析器)。
  7. ViewResolver解析**View**，由模板引擎渲染，（拦截器的afterCompletion()方法）返回客户端。
